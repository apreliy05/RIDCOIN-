<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíé RIDCOIN ‚Äî –ö–æ—à–µ–ª—ë–∫</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold-primary: #F1C40F;
            --gold-dark: #B8860B;
            --gold-light: #FFD700;
            --gold-gradient: linear-gradient(135deg, #F1C40F, #B8860B);
            --black-velvet: #0a0a0a;
            --black-charcoal: #1a1a1a;
            --black-matte: #222222;
            --emerald: #009966;
            --ruby: #8B0000;
            --silver: #C0C0C0;
            --platinum: #E5E4E2;
            --shadow-gold: 0 0 20px rgba(241, 196, 15, 0.3);
            --glow-gold: 0 0 15px rgba(241, 196, 15, 0.5);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:
                radial-gradient(circle at 20% 50%, rgba(241,196,15,0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(184,134,11,0.03) 0%, transparent 50%),
                var(--black-velvet);
            color: var(--platinum);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%; width: 100%; padding: 20px;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
        }

        .card {
            background: var(--black-charcoal); padding: 30px; border-radius: 20px;
            margin: 20px 0; border: 2px solid var(--gold-dark); box-shadow: var(--shadow-gold);
            width: 100%; max-width: 600px; transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--gold-gradient); }
        .card:hover { transform:translateY(-5px); box-shadow:0 15px 35px rgba(241,196,15,0.2); border-color:var(--gold-primary); }

        .header { text-align:center; margin-bottom:30px; padding:20px; background:rgba(0,0,0,0.5); border-radius:20px; border:1px solid var(--gold-dark); position:relative; }
        .header::after { content:'üíé'; position:absolute; top:-15px; right:-15px; font-size:40px; color:var(--gold-light); text-shadow:var(--glow-gold); }

        .logo { font-size:52px; margin-bottom:15px; background:var(--gold-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:900; letter-spacing:2px; }

        .big {
            font-size:56px; font-weight:900; color:var(--gold-primary); text-align:center;
            margin:30px 0; text-shadow:var(--glow-gold); letter-spacing:1px; transition:all 0.4s ease;
        }
        .big.flash { animation: balanceFlash 0.6s ease; }
        @keyframes balanceFlash {
            0%   { transform:scale(1);    color:var(--gold-primary); }
            30%  { transform:scale(1.12); color:#fff; text-shadow:0 0 30px #F1C40F; }
            100% { transform:scale(1);    color:var(--gold-primary); }
        }

        .price { font-size:22px; color:var(--gold-light); text-align:center; margin:25px 0; line-height:1.6; background:rgba(241,196,15,0.1); padding:20px; border-radius:15px; border-left:4px solid var(--gold-primary); border-right:4px solid var(--gold-primary); }

        input, button, select, textarea { width:100%; padding:20px; margin:15px 0; border-radius:12px; font-size:18px; border:none; outline:none; transition:all 0.3s; font-weight:600; }
        input, textarea { background:var(--black-matte); border:2px solid rgba(241,196,15,0.3); color:var(--platinum); }
        input:focus, textarea:focus { border-color:var(--gold-primary); box-shadow:var(--shadow-gold); background:rgba(241,196,15,0.05); }
        input::placeholder, textarea::placeholder { color:rgba(192,192,192,0.6); }

        button { background:var(--gold-gradient); color:#000; font-weight:900; cursor:pointer; letter-spacing:1px; text-transform:uppercase; position:relative; overflow:visible; border:2px solid var(--gold-dark); }
        button::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent); transition:0.5s; pointer-events:none; overflow:hidden; }
        button:hover { transform:translateY(-3px); box-shadow:0 10px 25px rgba(241,196,15,0.4); }
        button:hover::before { left:100%; }

        .history { font-size:15px; color:var(--silver); margin-top:20px; max-height:300px; overflow-y:auto; padding:15px; background:var(--black-matte); border-radius:12px; border:1px solid rgba(241,196,15,0.2); }
        .history-item { padding:10px 12px; margin:6px 0; border-radius:8px; background:rgba(255,255,255,0.03); border-left:3px solid transparent; transition:all 0.2s; }
        .history-item:hover { background:rgba(241,196,15,0.07); }
        .history-item.in  { border-left-color:#2ecc71; }
        .history-item.out { border-left-color:#e74c3c; }
        .history-item.system { border-left-color:var(--gold-dark); }
        .history-item .hi-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .history-item .hi-type { font-weight:700; font-size:13px; text-transform:uppercase; letter-spacing:1px; }
        .history-item .hi-type.in  { color:#2ecc71; }
        .history-item .hi-type.out { color:#e74c3c; }
        .history-item .hi-type.system { color:var(--gold-primary); }
        .history-item .hi-amount { font-weight:700; color:var(--gold-light); font-size:15px; }
        .history-item .hi-meta { font-size:12px; color:#777; }
        .history-item .hi-comment { font-size:13px; color:#aaa; margin-top:4px; font-style:italic; }

        .history-filters { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
        .filter-btn { flex:1; min-width:80px; padding:8px 12px; margin:0; font-size:12px; border-radius:8px; background:var(--black-matte); color:var(--silver); border:1px solid rgba(241,196,15,0.2); }
        .filter-btn.active { background:var(--gold-gradient); color:#000; border-color:var(--gold-primary); }

        .history-pagination { display:flex; justify-content:center; align-items:center; gap:10px; margin-top:10px; }
        .page-btn { width:auto; padding:8px 16px; margin:0; font-size:13px; border-radius:8px; }
        .page-info { color:var(--silver); font-size:13px; }

        h2, h3, h4 { color:var(--gold-primary); text-align:center; margin-top:0; font-weight:700; letter-spacing:1px; }
        h2 { font-size:32px; margin-bottom:20px; }
        h3 { font-size:26px; margin:25px 0 15px 0; }

        .usd-value { font-size:24px; color:var(--gold-light); text-align:center; margin:20px 0; font-weight:700; }
        .small-note { font-size:14px; color:var(--silver); margin:8px 0; text-align:center; font-style:italic; }

        .error { color:var(--ruby); font-size:16px; margin:10px 0; padding:12px; background:rgba(139,0,0,0.1); border-radius:8px; border-left:4px solid var(--ruby); display:none; font-weight:600; }

        .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:15px 0; }
        .stat-box { background:var(--black-matte); border-radius:12px; padding:14px; text-align:center; border:1px solid rgba(241,196,15,0.15); }
        .stat-box .stat-val { font-size:20px; font-weight:900; color:var(--gold-primary); }
        .stat-box .stat-label { font-size:12px; color:var(--silver); margin-top:4px; }

        .profile-avatar { width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:900; color:#fff; margin:0 auto 10px; border:3px solid var(--gold-primary); box-shadow:var(--shadow-gold); }

        .user-list { margin:20px 0; }
        .user-item { padding:15px; margin:10px 0; background:var(--black-matte); border-radius:12px; border-left:4px solid var(--gold-dark); transition:all 0.3s; display:flex; justify-content:space-between; align-items:center; }
        .user-item:hover { transform:translateX(10px); border-left-color:var(--gold-primary); background:rgba(241,196,15,0.05); }
        .admin-badge { background:var(--gold-gradient); color:#000; padding:6px 16px; border-radius:20px; font-size:14px; font-weight:900; text-transform:uppercase; letter-spacing:1px; box-shadow:0 3px 10px rgba(241,196,15,0.3); }
        .zero-balance { color:var(--ruby); font-weight:700; }
        .action-buttons { margin-top:30px; padding-top:25px; border-top:2px solid rgba(241,196,15,0.3); }
        .user-item-admin { border-left:4px solid var(--gold-primary); background:rgba(241,196,15,0.1); position:relative; }
        .user-item-admin::before { content:'üëë'; position:absolute; left:-25px; font-size:20px; color:var(--gold-light); }
        .balance-display { font-size:20px; font-weight:700; color:var(--gold-light); }
        .crown-icon { color:var(--gold-light); text-shadow:var(--glow-gold); }

        .autocomplete-wrap { position:relative; }
        .autocomplete-list { position:absolute; top:100%; left:0; right:0; background:#1e1e1e; border:1px solid var(--gold-dark); border-radius:0 0 10px 10px; z-index:100; max-height:200px; overflow-y:auto; }
        .autocomplete-item { padding:12px 16px; cursor:pointer; font-size:15px; display:flex; align-items:center; gap:10px; border-bottom:1px solid rgba(255,255,255,0.05); }
        .autocomplete-item:hover { background:rgba(241,196,15,0.1); color:var(--gold-primary); }
        .ac-avatar { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; }

        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(10,10,10,0.95); z-index:1000; justify-content:center; align-items:center; padding:20px; backdrop-filter:blur(5px); }
        .modal-content { background:var(--black-charcoal); padding:30px; border-radius:20px; border:2px solid var(--gold-primary); max-width:500px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.8); animation:modalAppear 0.3s ease-out; }
        @keyframes modalAppear { from{opacity:0;transform:scale(0.9) translateY(-20px);} to{opacity:1;transform:scale(1) translateY(0);} }

        #toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; pointer-events:none; }
        .toast { background:#1e1e1e; border-radius:12px; padding:14px 20px; min-width:260px; max-width:340px; font-size:15px; font-weight:600; border-left:4px solid var(--gold-primary); box-shadow:0 8px 24px rgba(0,0,0,0.6); animation:toastIn 0.35s ease, toastOut 0.35s ease 3.15s forwards; pointer-events:all; display:flex; align-items:center; gap:10px; }
        .toast.success { border-left-color:#2ecc71; }
        .toast.error   { border-left-color:#e74c3c; }
        .toast.info    { border-left-color:var(--gold-primary); }
        @keyframes toastIn  { from{opacity:0;transform:translateX(60px);} to{opacity:1;transform:translateX(0);} }
        @keyframes toastOut { from{opacity:1;} to{opacity:0;transform:translateX(60px);} }

        @keyframes pulseGold { 0%{box-shadow:0 0 0 0 rgba(241,196,15,0.4);} 70%{box-shadow:0 0 0 10px rgba(241,196,15,0);} 100%{box-shadow:0 0 0 0 rgba(241,196,15,0);} }
        .pulse { animation:pulseGold 2s infinite; }

        ::-webkit-scrollbar { width:8px; }
        ::-webkit-scrollbar-track { background:var(--black-matte); border-radius:4px; }
        ::-webkit-scrollbar-thumb { background:var(--gold-gradient); border-radius:4px; }

        @media(max-width:768px) { .container{padding:15px;} .card{padding:25px;} .big{font-size:44px;} .logo{font-size:42px;} input,button{padding:18px;font-size:16px;} }
        @media(max-width:480px) { .card{padding:20px;margin:15px 0;} .big{font-size:36px;} h2{font-size:28px;} .price{font-size:18px;padding:15px;} .logo{font-size:36px;} }

        .wealth-indicator { height:5px; background:var(--gold-gradient); border-radius:3px; margin:10px 0; }

        .chain-balance-block {
            background: rgba(130,71,229,0.1); border: 1px solid rgba(130,71,229,0.35);
            border-radius: 14px; padding: 16px 20px; margin: 10px 0; text-align: center;
        }
        .chain-balance-block .cb-label { font-size: 12px; color: var(--silver); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .chain-balance-block .cb-value { font-size: 26px; font-weight: 900; color: #a97ff5; }
        .chain-balance-block .cb-sub { font-size: 12px; color: #777; margin-top: 4px; }
        .chain-balance-block .cb-refresh { background: none; border: 1px solid rgba(130,71,229,0.4); color: #a97ff5; font-size: 12px; padding: 6px 14px; margin: 8px 0 0; width: auto; text-transform: none; letter-spacing: 0; border-radius: 8px; cursor: pointer; }
        .chain-balance-block .cb-refresh:hover { background: rgba(130,71,229,0.2); transform: none; box-shadow: none; }
        .gold-text { color:var(--gold-primary); font-weight:700; }
        .diamond { color:var(--gold-light); text-shadow:0 0 10px rgba(255,215,0,0.5); }

        .recovery-section { margin-top:30px; padding:20px; background:rgba(46,204,113,0.1); border-radius:12px; border:2px solid rgba(46,204,113,0.3); }
        .recovery-textarea { width:100%; padding:15px; background:var(--black-matte); border:2px solid rgba(46,204,113,0.5); border-radius:10px; color:var(--platinum); font-size:16px; resize:none; font-family:'Courier New',monospace; margin:10px 0; }
        .phrase-display { font-family:'Courier New',monospace; font-size:16px; line-height:1.6; padding:15px; background:rgba(0,0,0,0.3); border-radius:8px; margin:10px 0; border-left:4px solid var(--emerald); word-break:break-all; }
        .phrase-word { display:inline-block; background:rgba(46,204,113,0.2); padding:4px 10px; margin:3px; border-radius:6px; border:1px solid rgba(46,204,113,0.3); }
        .warning-box { background:rgba(241,196,15,0.1); border:2px solid rgba(241,196,15,0.3); border-radius:10px; padding:15px; margin:15px 0; }
        .warning-icon { color:#f39c12; font-weight:bold; }
        .generate-btn { background:linear-gradient(135deg,#2ecc71,#27ae60)!important; border:2px solid #27ae60!important; margin:10px 0; }
        .recovery-btn { background:linear-gradient(135deg,#e74c3c,#c0392b)!important; border:2px solid #c0392b!important; margin:10px 0; }
        .copy-btn { background:linear-gradient(135deg,#3498db,#2980b9)!important; border:2px solid #2980b9!important; padding:12px!important; font-size:14px!important; margin:5px 0; }
        .purple-btn { background:linear-gradient(135deg,#9b59b6,#8e44ad)!important; border:2px solid #8e44ad!important; }
        .blue-btn { background:linear-gradient(135deg,#3498db,#2980b9)!important; border:2px solid #2980b9!important; }
        .share-btn { background:linear-gradient(135deg,#27ae60,#1e8449)!important; border:2px solid #1e8449!important; }

        .forgot-password { text-align:center; margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); }
        .forgot-password a { color:var(--gold-primary); text-decoration:none; font-weight:600; font-size:14px; }
        .forgot-password a:hover { text-decoration:underline; }
        .form-actions { display:flex; gap:10px; margin-top:20px; }
        .form-actions button { flex:1; }

        .password-strength { height:4px; border-radius:2px; margin:-10px 0 10px; transition:all 0.3s; background:#333; }
        .password-strength.weak   { background:#e74c3c; width:33%; }
        .password-strength.medium { background:#f39c12; width:66%; }
        .password-strength.strong { background:#2ecc71; width:100%; }
        .strength-label { font-size:12px; text-align:right; margin:-8px 0 10px; }
        .strength-label.weak   { color:#e74c3c; }
        .strength-label.medium { color:#f39c12; }
        .strength-label.strong { color:#2ecc71; }

        .username-copy-btn { display:inline-block; background:none; border:none; padding:2px 6px; font-size:14px; cursor:pointer; opacity:0.6; width:auto; margin:0; vertical-align:middle; transform:none!important; box-shadow:none!important; }
        .username-copy-btn:hover { opacity:1; }

        .confirm-details { background:var(--black-matte); border-radius:12px; padding:20px; margin:15px 0; border:1px solid rgba(241,196,15,0.3); }
        .confirm-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05); }
        .confirm-row:last-child { border-bottom:none; }
        .confirm-row .label { color:var(--silver); font-size:14px; }
        .confirm-row .value { font-weight:700; color:var(--gold-light); }

        .change-password-section { margin-top:20px; padding:20px; background:rgba(52,152,219,0.07); border-radius:12px; border:2px solid rgba(52,152,219,0.2); }

        .users-counter {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: rgba(241,196,15,0.08); border: 1px solid rgba(241,196,15,0.2);
            border-radius: 12px; padding: 12px 20px; margin: 15px 0;
        }
        .users-counter .uc-num { font-size: 22px; font-weight: 900; color: var(--gold-primary); }
        .users-counter .uc-label { font-size: 13px; color: var(--silver); }

        .chart-wrap { background: var(--black-matte); border-radius: 14px; padding: 16px; margin: 20px 0; border: 1px solid rgba(241,196,15,0.15); }
        .chart-title { font-size: 13px; color: var(--silver); text-align: center; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        #ridChart { width: 100%; height: 120px; display: block; }

        .about-section { background: var(--black-matte); border-radius: 14px; padding: 20px; margin: 20px 0; border: 1px solid rgba(241,196,15,0.15); }
        .about-row { display: flex; align-items: flex-start; gap: 12px; margin: 12px 0; }
        .about-icon { font-size: 22px; flex-shrink: 0; margin-top: 2px; }
        .about-text { font-size: 14px; color: var(--silver); line-height: 1.6; }
        .about-text strong { color: var(--gold-light); }

        #particles-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; opacity: 0; transition: opacity 0.3s; }
        #particles-canvas.active { opacity: 1; }

        .firebase-badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3);
            border-radius: 20px; padding: 4px 12px; font-size: 12px; color: #ffc107;
            margin: 8px auto; text-align: center;
        }
        .firebase-badge .dot { width:8px; height:8px; border-radius:50%; background:#ffc107; animation: blink 1.5s infinite; }
        .firebase-badge.connected .dot { background:#2ecc71; }
        .firebase-badge.connected { color:#2ecc71; border-color:rgba(46,204,113,0.3); background:rgba(46,204,113,0.08); }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(10,10,10,0.85); z-index:9998; justify-content:center; align-items:center; flex-direction:column; gap:20px; }
        .loading-overlay.show { display:flex; }
        .spinner { width:50px; height:50px; border:4px solid rgba(241,196,15,0.2); border-top-color:var(--gold-primary); border-radius:50%; animation:spin 0.8s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg);} }
        .loading-text { color:var(--gold-light); font-size:16px; font-weight:600; }

        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .delete-user-btn {
            width:auto; padding:10px 16px; margin:0; font-size:13px; border-radius:10px;
            background:linear-gradient(135deg,#e74c3c,#c0392b); border:2px solid #c0392b;
            flex-shrink:0; letter-spacing:0; text-transform:none; color:#fff;
        }
        .delete-user-btn:hover { background:linear-gradient(135deg,#c0392b,#962d22); box-shadow:0 5px 15px rgba(231,76,60,0.4); }

        /* –ü–æ–∏—Å–∫ –≤ –ø–∞–Ω–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .admin-search { margin-bottom:15px; }
        .admin-search input { margin:0; padding:14px; font-size:15px; }
    </style>
</head>
<body>

<canvas id="particles-canvas"></canvas>
<div id="toast-container"></div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</div>
</div>

<div class="container">

    <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
    <div class="card header">
        <h1 class="logo">üíé RIDCOIN</h1>
        <div class="price" id="headerPrice">
            <div class="gold-text" id="headerPriceValue">1 RID = ... USD</div>
            <div id="headerDate"></div>
        </div>
        <div style="text-align:center;">
            <span class="firebase-badge" id="firebaseBadge">
                <span class="dot"></span>
                <span id="firebaseStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </span>
        </div>
        <div class="users-counter">
            <span class="uc-num" id="totalUsersCount">0</span>
            <span class="uc-label">üë• —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ</span>
        </div>
        <div class="wealth-indicator"></div>
    </div>

    <div id="walletMode" style="width:100%;display:block;">


        <!-- ===== –ü–†–û–ú–û-–ë–ê–ù–ù–ï–† ===== -->
        <div class="card promo-banner" style="max-width:600px;background:linear-gradient(135deg,#1a1a00,#2a2000);border:2px solid var(--gold-primary);box-shadow:0 0 30px rgba(241,196,15,0.35);padding:0;overflow:hidden;">

            <!-- –®–∞–ø–∫–∞ –±–∞–Ω–Ω–µ—Ä–∞ -->
            <div style="background:var(--gold-gradient);padding:18px 24px;text-align:center;">
                <div style="font-size:28px;font-weight:900;color:#000;letter-spacing:2px;text-transform:uppercase;">üéÅ –§–ê–ó–ê –†–ê–ó–í–ò–¢–ò–Ø</div>
                <div style="font-size:14px;font-weight:700;color:#3a2800;margin-top:4px;letter-spacing:1px;">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ¬∑ –¢–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å</div>
            </div>

            <div style="padding:24px;">

                <!-- –ì–ª–∞–≤–Ω—ã–π –æ—Ñ—Ñ–µ—Ä -->
                <div style="text-align:center;background:rgba(241,196,15,0.08);border:2px solid rgba(241,196,15,0.3);border-radius:16px;padding:20px;margin-bottom:18px;">
                    <div style="font-size:42px;margin-bottom:8px;">üíé</div>
                    <div style="font-size:22px;font-weight:900;color:var(--gold-light);line-height:1.3;">
                        –ü—Ä–æ—Å—Ç–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è ‚Äî<br>–ø–æ–ª—É—á–∏ <span style="color:#fff;font-size:28px;text-shadow:0 0 15px #F1C40F;">1 RIDCOIN</span> –≤ –ø–æ–¥–∞—Ä–æ–∫
                    </div>
                    <div style="font-size:13px;color:var(--silver);margin-top:10px;font-style:italic;">–ë–µ–∑–≤–æ–∑–º–µ–∑–¥–Ω–æ. –ë–µ–∑ —É—Å–ª–æ–≤–∏–π. –ü—Ä–æ—Å—Ç–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.</div>
                </div>

                <!-- –§–æ–Ω–¥ —Ä–∞–∑–¥–∞—á–∏ -->
                <div style="text-align:center;background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-bottom:18px;border:1px solid rgba(241,196,15,0.15);">
                    <div style="font-size:13px;color:var(--silver);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">–§–æ–Ω–¥ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π —Ä–∞–∑–¥–∞—á–∏</div>
                    <div id="airdropFundCounter" style="font-size:36px;font-weight:900;color:var(--gold-primary);text-shadow:var(--glow-gold);">1 000 000</div>
                    <div style="font-size:16px;font-weight:700;color:var(--gold-light);">RIDCOIN</div>
                    <div style="font-size:12px;color:#777;margin-top:6px;">–¢–æ–ª—å–∫–æ –∑–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</div>
                </div>

                <!-- –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –µ—â—ë -->
                <div style="margin-bottom:18px;">
                    <div style="font-size:14px;font-weight:900;color:var(--gold-primary);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;text-align:center;">üìà –ö–∞–∫ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –µ—â—ë</div>

                    <div style="display:flex;align-items:flex-start;gap:12px;background:rgba(46,204,113,0.07);border:1px solid rgba(46,204,113,0.25);border-radius:12px;padding:14px;margin-bottom:10px;">
                        <div style="font-size:24px;flex-shrink:0;">üì£</div>
                        <div>
                            <div style="font-weight:700;color:#2ecc71;font-size:15px;">–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</div>
                            <div style="font-size:13px;color:var(--silver);margin-top:3px;">–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–∞—à Telegram-–∫–∞–Ω–∞–ª –∏ –ø–æ–ª—É—á–∏ –º–æ–Ω–µ—Ç—ã.</div>
                        </div>
                    </div>

                    <div style="display:flex;align-items:flex-start;gap:12px;background:rgba(52,152,219,0.07);border:1px solid rgba(52,152,219,0.25);border-radius:12px;padding:14px;">
                        <div style="font-size:24px;flex-shrink:0;">ü§ù</div>
                        <div>
                            <div style="font-weight:700;color:#3498db;font-size:15px;">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</div>
                            <div style="font-size:13px;color:var(--silver);margin-top:3px;">
                                –ü—Ä–∏–≥–ª–∞—Å–∏–ª ‚Äî <strong style="color:var(--gold-light);">+1 RID —Ç–µ–±–µ</strong>.<br>
                                –î—Ä—É–≥ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è ‚Äî <strong style="color:var(--gold-light);">+1 RID –µ–º—É</strong>.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–∏–Ω—Ü–∏–ø —Å–∏—Å—Ç–µ–º—ã -->
                <div style="background:rgba(139,0,0,0.12);border:2px solid rgba(139,0,0,0.35);border-radius:12px;padding:16px;text-align:center;">
                    <div style="font-size:18px;margin-bottom:8px;">üîí</div>
                    <div style="font-weight:900;color:#e74c3c;font-size:15px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">RIDCOIN –Ω–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–¥–∞—Ç—å</div>
                    <div style="font-size:13px;color:var(--silver);line-height:1.6;">
                        –≠—Ç–æ <strong style="color:var(--platinum);">–ø—Ä–∏–Ω—Ü–∏–ø —Å–∏—Å—Ç–µ–º—ã</strong>.<br>
                        –ú–æ–Ω–µ—Ç—É –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ <strong style="color:var(--gold-light);">–∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å</strong> ‚Äî —á–µ—Ä–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–∑–µ–π.<br>
                        –ù–∏–∫–∞–∫–∏—Ö –ø–æ–∫—É–ø–æ–∫. –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–¥–∞–∂.
                    </div>
                </div>

            </div>

            <!-- –ü–æ–¥–≤–∞–ª –±–∞–Ω–Ω–µ—Ä–∞ -->
            <div style="background:rgba(241,196,15,0.06);border-top:1px solid rgba(241,196,15,0.2);padding:14px 24px;text-align:center;">
                <div style="font-size:13px;color:var(--silver);">‚è≥ –§–∞–∑–∞ —Ä–∞–∑–¥–∞—á–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ ¬∑ –£—Å–ø–µ–π –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π <strong style="color:var(--gold-light);">RIDCOIN</strong> –±–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
            </div>
        </div>
        <!-- ===== –ö–û–ù–ï–¶ –ü–†–û–ú–û-–ë–ê–ù–ù–ï–†–ê ===== -->

        <!-- –í–•–û–î -->
        <div class="card" id="loginSection">
            <h3>üëë –í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h3>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off">
            <button onclick="login()" class="pulse">üîë –í–æ–π—Ç–∏</button>
            <div class="forgot-password">
                <a href="javascript:void(0)" onclick="showRecoveryModal()">üîì –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
            </div>
            <div style="text-align:center;margin-top:20px;color:var(--silver);">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</div>
            <button onclick="showRegisterModal()" class="purple-btn">‚ú® –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>

            <div style="margin-top:30px;">
                <h4 style="margin-bottom:5px;">üìñ –û –ø—Ä–æ–µ–∫—Ç–µ</h4>
                <div class="about-section">
                    <div class="about-row">
                        <span class="about-icon">üíé</span>
                        <div class="about-text"><strong>RIDCOIN</strong> ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ü–∏—Ñ—Ä–æ–≤–∞—è –º–æ–Ω–µ—Ç–∞ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã RidcoinEcoSystem.</div>
                    </div>

                    <div class="about-row">
                        <span class="about-icon">üîí</span>
                        <div class="about-text">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ —Å <strong>SHA-256</strong> –∑–∞—â–∏—Ç–æ–π –∏ —Ñ—Ä–∞–∑–æ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.</div>
                    </div>
                    <div class="about-row">
                        <span class="about-icon">üî•</span>
                        <div class="about-text">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ <strong>Firebase Realtime Database</strong> ‚Äî –∫–æ—à–µ–ª—ë–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</div>
                    </div>
                    <button onclick="window.open('https://polygonscan.com/token/0xcD36914FD4C560D1475088eB84bB82C11f3E19DE','_blank')" style="background:linear-gradient(135deg,#8247e5,#6a35c2);border:2px solid #6a35c2;margin-top:8px;font-size:15px;padding:14px;">
                        üî∑ –°–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ Polygon
                    </button>
                </div>
            </div>

            <div class="user-list" id="userList" style="display:none;">
                <h4>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã:</h4>
                <div id="usersContainer"></div>
            </div>
        </div>

        <!-- –ö–û–®–ï–õ–Å–ö -->
        <div class="card" id="wallet" style="display:none;">
            <div class="profile-avatar" id="profileAvatar">?</div>
            <h3 style="margin-top:0;">üí∞ –ö–æ—à–µ–ª—ë–∫</h3>
            <p style="text-align:center;">
                <strong id="userName" class="gold-text"></strong>
                <button class="username-copy-btn" onclick="copyUsername()" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">üìã</button>
                <span id="userBadge" class="admin-badge" style="margin-left:8px;"></span>
            </p>
            <p class="small-note" id="lastLoginNote" style="margin-top:4px;"></p>

            <div class="big" id="balance">0 RID</div>
            <div class="usd-value" id="usdBalance">‚âà 0 USD</div>

            <div class="chain-balance-block">
                <div class="cb-label">üîó –†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ Polygon</div>
                <div class="cb-value" id="chainBalance">‚Äî</div>
                <div class="cb-sub" id="chainBalanceSub">–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                <button class="cb-refresh" onclick="loadChainBalance()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <div class="chart-wrap">
                <div class="chart-title">üìà –†–æ—Å—Ç –∫—É—Ä—Å–∞ RID –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
                <canvas id="ridChart"></canvas>
            </div>

            <div class="stats-grid">
                <div class="stat-box"><div class="stat-val" id="statTxCount">0</div><div class="stat-label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div></div>
                <div class="stat-box"><div class="stat-val" id="statVolume">0</div><div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ RID</div></div>
                <div class="stat-box"><div class="stat-val" id="statReceived">0</div><div class="stat-label">–ü–æ–ª—É—á–µ–Ω–æ RID</div></div>
                <div class="stat-box"><div class="stat-val" id="statDaysActive">0</div><div class="stat-label">–î–Ω–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</div></div>
            </div>

            <h3 style="margin-top:30px;">üè¶ –ü–µ—Ä–µ–≤–æ–¥</h3>
            <div class="autocomplete-wrap">
                <input type="text" id="to" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è" autocomplete="off" oninput="onRecipientInput(this.value)" onblur="hideAutocomplete()">
                <div class="autocomplete-list" id="autocompleteList" style="display:none;"></div>
            </div>
            <input type="number" id="amount" placeholder="–°—É–º–º–∞ –≤ RID" step="0.00000001" min="0.00000001" autocomplete="off">
            <input type="text" id="transferComment" placeholder="üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" autocomplete="off" style="font-size:15px;padding:14px 20px;">
            <div class="small-note">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 0.00000001 RID (1 —Å–∞—Ç–æ—à–∏)</div>
            <div class="error" id="amountError"></div>
            <button onclick="initiateSend()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>

            <h3 style="margin-top:30px;">üìú –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <div class="history-filters">
                <button class="filter-btn active" onclick="setHistoryFilter('all',this)">–í—Å–µ</button>
                <button class="filter-btn" onclick="setHistoryFilter('in',this)">–í—Ö–æ–¥—è—â–∏–µ</button>
                <button class="filter-btn" onclick="setHistoryFilter('out',this)">–ò—Å—Ö–æ–¥—è—â–∏–µ</button>
            </div>
            <div id="history" class="history"></div>
            <div class="history-pagination" id="historyPagination" style="display:none;">
                <button class="page-btn" onclick="historyPagePrev()">‚Üê –ù–∞–∑–∞–¥</button>
                <span class="page-info" id="pageInfo"></span>
                <button class="page-btn" onclick="historyPageNext()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
            </div>

            <div class="action-buttons">
                <button onclick="showAllUsers()" class="blue-btn" style="margin-bottom:15px;font-size:18px;padding:22px 20px;letter-spacing:1.5px;box-shadow:0 4px 18px rgba(52,152,219,0.4);">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button onclick="showGlobalChat()" style="background:linear-gradient(135deg,#16a085,#1abc9c);border:2px solid #1abc9c;margin-bottom:15px;margin-top:12px;position:relative;font-size:18px;padding:22px 20px;letter-spacing:1.5px;box-shadow:0 4px 18px rgba(26,188,156,0.4);">
                    üí¨ –û–±—â–∏–π —á–∞—Ç
                    <span id="globalChatBadge" style="display:none;position:absolute;top:-13px;right:-13px;background:#e74c3c;color:#fff;border-radius:50%;min-width:28px;height:28px;font-size:14px;font-weight:900;align-items:center;justify-content:center;border:3px solid #0a0a0a;padding:0 5px;box-shadow:0 0 10px rgba(231,76,60,0.9);z-index:10;">0</span>
                </button>
                <button onclick="showDMList()" style="background:linear-gradient(135deg,#2980b9,#3498db);border:2px solid #3498db;margin-bottom:15px;margin-top:12px;position:relative;font-size:18px;padding:22px 20px;letter-spacing:1.5px;box-shadow:0 4px 18px rgba(52,152,219,0.4);">
                    ‚úâÔ∏è –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    <span id="dmUnreadBadge" style="display:none;position:absolute;top:-13px;right:-13px;background:#e74c3c;color:#fff;border-radius:50%;min-width:28px;height:28px;font-size:14px;font-weight:900;align-items:center;justify-content:center;border:3px solid #0a0a0a;padding:0 5px;box-shadow:0 0 10px rgba(231,76,60,0.9);z-index:10;">0</span>
                </button>
                <button onclick="showProfileModal()" class="purple-btn" style="margin-bottom:15px;font-size:18px;padding:22px 20px;letter-spacing:1.5px;box-shadow:0 4px 18px rgba(155,89,182,0.4);">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å –∏ —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</button>
                <button onclick="window.open('https://polygonscan.com/token/0xcD36914FD4C560D1475088eB84bB82C11f3E19DE','_blank')" style="background:linear-gradient(135deg,#8247e5,#6a35c2);border:2px solid #6a35c2;margin-bottom:15px;font-size:18px;padding:22px 20px;letter-spacing:1.5px;box-shadow:0 4px 18px rgba(130,71,229,0.4);">üî∑ –ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ Polygon</button>
                <button onclick="logout()" style="background:linear-gradient(135deg,var(--ruby),#6a0000);font-size:18px;padding:22px 20px;letter-spacing:1.5px;box-shadow:0 4px 18px rgba(139,0,0,0.5);">üö™ –í—ã–π—Ç–∏</button>
            </div>

            <!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è RIDCOIN -->
            <div id="adminPanel" style="display:none; margin-top:20px; padding:20px; background:rgba(231,76,60,0.08); border-radius:16px; border:2px solid rgba(231,76,60,0.3);">
                <h4 style="color:#e74c3c; margin-bottom:15px;">‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
                <button onclick="showAllUsersAdmin()" style="background:linear-gradient(135deg,#e74c3c,#c0392b); border-color:#c0392b; margin-bottom:10px;">
                    üóëÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                </button>
                <button onclick="showAllUsersAdmin()" style="background:linear-gradient(135deg,#e67e22,#d35400); border-color:#d35400; margin-bottom:10px;">
                    üëÅÔ∏è –í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã (—Å –±–∞–ª–∞–Ω—Å–∞–º–∏)
                </button>
                <button onclick="addBalanceModal()" style="background:linear-gradient(135deg,#27ae60,#1e8449); border-color:#1e8449;">
                    üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </button>
            </div>

            <div class="wealth-indicator" style="margin-top:30px;"></div>
        </div>
    </div>

    <!-- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ -->
    <div id="addBalanceModal" class="modal-overlay">
        <div class="modal-content">
            <h3>üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
            <input type="text" id="ab-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <input type="number" id="ab-amount" placeholder="–°—É–º–º–∞ –≤ RID" step="0.00000001" min="0.00000001">
            <div class="error" id="abError"></div>
            <div class="form-actions">
                <button onclick="confirmAddBalance()" style="background:linear-gradient(135deg,#27ae60,#1e8449);">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                <button onclick="hideAddBalanceModal()" style="background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º) -->
    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <h3><span class="diamond">üëë</span> –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã</h3>
            <div id="allUsersList"></div>
            <button onclick="hideUsersModal()" style="margin-top:20px;width:100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (ADMIN) ‚Äî —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="adminUsersModal" class="modal-overlay">
        <div class="modal-content" style="max-width:560px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h3 style="margin:0;">üóëÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                <button onclick="hideAdminUsersModal()" style="width:auto;padding:8px 16px;margin:0;font-size:13px;border-radius:8px;">‚úï</button>
            </div>
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="admin-search">
                <input type="text" id="adminUserSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." oninput="filterAdminUsersList(this.value)">
            </div>
            <!-- –°—á—ë—Ç—á–∏–∫ -->
            <div style="font-size:13px;color:var(--silver);margin-bottom:10px;text-align:center;" id="adminUsersCountLabel"></div>
            <!-- –°–ø–∏—Å–æ–∫ -->
            <div id="adminUsersList" style="max-height:480px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <h3><span class="diamond">‚ú®</span> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input type="text" id="reg-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" autocomplete="off" oninput="checkPasswordStrength(this.value)">
            <div class="password-strength" id="pwStrengthBar"></div>
            <div class="strength-label" id="pwStrengthLabel"></div>
            <input type="password" id="reg-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="off">
            <div class="recovery-section">
                <h4 style="color:#2ecc71;margin-bottom:15px;">üîê –§—Ä–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</h4>
                <div class="phrase-display" id="recoveryPhraseDisplay">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                <div class="form-actions">
                    <button onclick="generateRecoveryPhrase()" class="generate-btn">üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button onclick="copyRecoveryPhrase()" class="copy-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="warning-box">
                    <span class="warning-icon">‚ö†Ô∏è</span> <strong>–í–ê–ñ–ù–û!</strong> –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç—É —Ñ—Ä–∞–∑—É –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ!<br>–ë–µ–∑ –Ω–µ–µ –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø.
                </div>
            </div>
            <div class="form-actions">
                <button onclick="createAccount()">‚úÖ –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <button onclick="hideRegisterModal()" style="background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ -->
    <div id="recoveryModal" class="modal-overlay">
        <div class="modal-content">
            <h3><span class="diamond">üîì</span> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞</h3>
            <input type="text" id="recovery-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <textarea id="recovery-phrase-input" class="recovery-textarea" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (12 —Å–ª–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª)"></textarea>
            <div class="error" id="recoveryError"></div>
            <div class="form-actions">
                <button onclick="recoverPassword()" class="recovery-btn">üîì –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <button onclick="hideRecoveryModal()" style="background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞</h3>
            <div class="confirm-details" id="confirmDetails"></div>
            <div class="form-actions" style="margin-top:20px;">
                <button onclick="confirmSend()" style="background:linear-gradient(135deg,#27ae60,#1e8449);">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button onclick="hideConfirmModal()" style="background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</h3>
            <div class="profile-avatar" id="profileAvatarModal" style="width:70px;height:70px;font-size:32px;">?</div>
            <p style="text-align:center;margin:10px 0 5px;font-size:18px;font-weight:700;" id="profileName"></p>
            <p style="text-align:center;color:var(--silver);font-size:13px;" id="profileCreated"></p>
            <div class="change-password-section">
                <h4 style="color:#3498db;margin-bottom:15px;">üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h4>
                <input type="password" id="cp-current" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" autocomplete="off">
                <input type="password" id="cp-new" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" autocomplete="off" oninput="checkNewPasswordStrength(this.value)">
                <div class="password-strength" id="cpStrengthBar"></div>
                <div class="strength-label" id="cpStrengthLabel"></div>
                <input type="password" id="cp-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" autocomplete="off">
                <div class="error" id="cpError"></div>
                <button onclick="changePassword()" class="blue-btn">üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </div>
            <button onclick="hideProfileModal()" style="margin-top:15px;background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –û–ë–©–ò–ô –ß–ê–¢ -->
    <div id="globalChatModal" class="modal-overlay">
        <div class="modal-content" style="max-width:560px;display:flex;flex-direction:column;height:85vh;padding:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <h3 style="margin:0;">üí¨ –û–±—â–∏–π —á–∞—Ç</h3>
                <button onclick="hideGlobalChat()" style="width:auto;padding:8px 16px;margin:0;font-size:13px;border-radius:8px;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div id="globalChatMessages" style="flex:1;overflow-y:auto;padding:10px;background:var(--black-matte);border-radius:12px;border:1px solid rgba(241,196,15,0.15);margin-bottom:12px;display:flex;flex-direction:column;gap:8px;">
                <div style="text-align:center;color:#555;font-size:13px;margin:auto;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            <div style="display:flex;gap:8px;">
                <input type="text" id="globalChatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1;margin:0;padding:14px;font-size:15px;" maxlength="500" onkeypress="if(event.key==='Enter')sendGlobalMessage()">
                <button onclick="sendGlobalMessage()" style="width:auto;padding:14px 20px;margin:0;font-size:15px;border-radius:12px;">‚û§</button>
            </div>
        </div>
    </div>

    <!-- –°–ü–ò–°–û–ö –õ–° -->
    <div id="dmListModal" class="modal-overlay">
        <div class="modal-content" style="max-width:500px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h3 style="margin:0;">‚úâÔ∏è –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                <button onclick="hideDMList()" style="width:auto;padding:8px 16px;margin:0;font-size:13px;border-radius:8px;">‚úï</button>
            </div>
            <div style="margin-bottom:12px;">
                <div style="font-size:13px;color:var(--silver);margin-bottom:8px;">–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</div>
                <div class="autocomplete-wrap">
                    <input type="text" id="dmSearchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è..." style="margin:0;" autocomplete="off" oninput="onDmSearchInput(this.value)" onblur="setTimeout(hideDmAutocomplete,200)">
                    <div class="autocomplete-list" id="dmAutocompleteList" style="display:none;"></div>
                </div>
                <button onclick="openDMFromSearch()" style="margin-top:8px;padding:12px;">‚úâÔ∏è –û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥</button>
            </div>
            <div id="dmConversationsList" style="max-height:300px;overflow-y:auto;">
                <div style="text-align:center;color:#555;font-size:13px;padding:20px;">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>
            </div>
        </div>
    </div>

    <!-- –õ–° –î–ò–ê–õ–û–ì -->
    <div id="dmChatModal" class="modal-overlay">
        <div class="modal-content" style="max-width:560px;display:flex;flex-direction:column;height:85vh;padding:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <h3 style="margin:0;" id="dmChatTitle">üí¨ –î–∏–∞–ª–æ–≥</h3>
                <div style="display:flex;gap:8px;">
                    <button onclick="hideDMChat();showDMList();" style="width:auto;padding:8px 14px;margin:0;font-size:13px;border-radius:8px;background:rgba(255,255,255,0.1);">‚Üê –ù–∞–∑–∞–¥</button>
                    <button onclick="hideDMChat()" style="width:auto;padding:8px 14px;margin:0;font-size:13px;border-radius:8px;">‚úï</button>
                </div>
            </div>
            <div id="dmChatMessages" style="flex:1;overflow-y:auto;padding:10px;background:var(--black-matte);border-radius:12px;border:1px solid rgba(241,196,15,0.15);margin-bottom:12px;display:flex;flex-direction:column;gap:8px;">
                <div style="text-align:center;color:#555;font-size:13px;margin:auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div style="display:flex;gap:8px;">
                <input type="text" id="dmChatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1;margin:0;padding:14px;font-size:15px;" maxlength="500" onkeypress="if(event.key==='Enter')sendDMMessage()">
                <button onclick="sendDMMessage()" style="width:auto;padding:14px 20px;margin:0;font-size:15px;border-radius:12px;">‚û§</button>
            </div>
        </div>
    </div>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
// ============================================================
// FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================
const firebaseConfig = {
    apiKey:            "AIzaSyBYwiL1O7WiHXxlAEOZ2PWQFyDmiU_Bjjs",
    authDomain:        "ridcoin-d1ed7.firebaseapp.com",
    databaseURL:       "https://ridcoin-d1ed7-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:         "ridcoin-d1ed7",
    storageBucket:     "ridcoin-d1ed7.firebasestorage.app",
    messagingSenderId: "768053669932",
    appId:             "1:768053669932:web:8a1062808d2401b8e96189",
    measurementId:     "G-6MWY9G7XL7"
};

firebase.initializeApp(firebaseConfig);
const db   = firebase.database();
const auth = firebase.auth();

// ============================================================
// –¶–ï–ù–ê
// ============================================================
const RID_CREATION_DATE  = '2025-04-27';
const RID_INITIAL_PRICE  = 1.00;
const RID_DAILY_INCREASE = 1.00;
const SATOSHI_PER_RID    = 100000000;

function getCurrentRidPrice() {
    const c = new Date(RID_CREATION_DATE + 'T00:00:00Z');
    const now = new Date();
    const days = Math.max(0, Math.floor(
        (Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) -
         Date.UTC(c.getUTCFullYear(),  c.getUTCMonth(),   c.getUTCDate())) / 86400000
    ));
    return RID_INITIAL_PRICE + days * RID_DAILY_INCREASE;
}

function updateHeaderPrice() {
    const price = getCurrentRidPrice();
    const d = document.getElementById('headerPriceValue');
    if (d) d.textContent = `1 RID = ${price.toFixed(2)} USD`;
    const dd = document.getElementById('headerDate');
    if (dd) dd.textContent = new Date().toLocaleDateString('ru-RU', {day:'2-digit',month:'2-digit',year:'numeric'});
}

// ============================================================
// UI HELPERS
// ============================================================
function showLoading(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').classList.add('show');
}
function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('show');
}
function showToast(msg, type = 'info') {
    const icons = {success:'‚úÖ', error:'‚ùå', info:'üíé'};
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<span>${icons[type]||'üíé'}</span><span>${msg}</span>`;
    document.getElementById('toast-container').appendChild(el);
    setTimeout(() => el.remove(), 3500);
}
function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
// –•–≠–®–ò–†–û–í–ê–ù–ò–ï –ü–ê–†–û–õ–ï–ô ‚Äî PBKDF2
// ============================================================
async function sha256(pw) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}
function generateSalt() {
    const arr = new Uint8Array(16);
    crypto.getRandomValues(arr);
    return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
}
async function pbkdf2Hash(pw, salt) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveBits']);
    const bits = await crypto.subtle.deriveBits(
        { name: 'PBKDF2', salt: enc.encode(salt), iterations: 100000, hash: 'SHA-256' },
        keyMaterial, 256
    );
    return Array.from(new Uint8Array(bits)).map(b => b.toString(16).padStart(2,'0')).join('');
}
async function hashPassword(pw) {
    const salt = generateSalt();
    const hash = await pbkdf2Hash(pw, salt);
    return 'pbkdf2$' + salt + '$' + hash;
}
async function verifyPassword(pw, stored) {
    if (!stored) return false;
    if (stored.startsWith('pbkdf2$')) {
        const parts = stored.split('$');
        if (parts.length !== 3) return false;
        const computed = await pbkdf2Hash(pw, parts[1]);
        return computed === parts[2];
    }
    return (await sha256(pw)) === stored;
}
async function hashPhrase(phrase) {
    return hashPassword(phrase.toLowerCase().replace(/\s+/g, ' ').trim());
}
async function verifyPhrase(phrase, stored) {
    return verifyPassword(phrase.toLowerCase().replace(/\s+/g, ' ').trim(), stored);
}

// ============================================================
// –î–ê–ù–ù–´–ï
// ============================================================
let users = {}, currentUser = null, currentRecoveryPhrase = '', pendingTransfer = null;
let historyFilter = 'all', historyPage = 0;
const HISTORY_PAGE_SIZE = 10;

// –ö—ç—à –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤ adminUsersModal ‚Äî –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
let adminUsersCache = [];

const RECOVERY_WORDS_FULL = [
    "–∫–æ—à–∫–∞","–¥–æ–º","—Å–æ–ª–Ω—Ü–µ","—Ä–µ–∫–∞","–≥–æ—Ä—ã","–∫–Ω–∏–≥–∞","—á–∞—à–∫–∞","—Å—Ç–æ–ª","–æ–∫–Ω–æ","–º–æ—Ä–µ",
    "–ø—Ç–∏—Ü–∞","—Ü–≤–µ—Ç–æ–∫","–¥–µ—Ä–µ–≤–æ","–∫–ª—é—á","–æ–≥–æ–Ω—å","–≤–µ—Ç–µ—Ä","–∑–≤–µ–∑–¥–∞","–ª—É–Ω–∞","–¥–æ–∂–¥—å","—Å–Ω–µ–≥",
    "—Ç—Ä–∞–≤–∞","–ª–∏—Å—Ç","–∫–∞–º–µ–Ω—å","–ø–µ—Å–æ–∫","–≤–æ–¥–∞","–≤–æ–∑–¥—É—Ö","–∑–µ–º–ª—è","–º–µ—Ç–∞–ª–ª","—Ä—É–∫–∞","–Ω–æ–≥–∞",
    "–≥–æ–ª–æ–≤–∞","—Å–µ—Ä–¥—Ü–µ","–≥–ª–∞–∑","—É—Ö–æ","–Ω–æ—Å","—Ä–æ—Ç","–∑—É–±","–≤–æ–ª–æ—Å","—è–±–ª–æ–∫–æ","—Ö–ª–µ–±",
    "–º–æ–ª–æ–∫–æ","—Å–∞—Ö–∞—Ä","—Å–æ–ª—å","—á–∞–π","–∫–æ—Ñ–µ","–º—è—Å–æ","—Ä—ã–±–∞","—Å—ã—Ä","—Å—Ç—É–ª","–¥–≤–µ—Ä—å",
    "–∫—Ä–æ–≤–∞—Ç—å","–ª–∞–º–ø–∞","—á–∞—Å—ã","–∑–µ—Ä–∫–∞–ª–æ","–∫–æ–≤–µ—Ä","–ø–æ–ª–∫–∞","—à–∫–∞—Ñ","–º–∞—à–∏–Ω–∞","–¥–æ—Ä–æ–≥–∞",
    "–º–æ—Å—Ç","–ø–æ–µ–∑–¥","—Å–∞–º–æ–ª–µ—Ç","–∫–æ—Ä–∞–±–ª—å","–≤–µ–ª–æ—Å–∏–ø–µ–¥","–ª–æ–¥–∫–∞","—Ä–∞–∫–µ—Ç–∞","—Ç—Ä–∞–∫—Ç–æ—Ä",
    "–≥–æ—Ä–æ–¥","—Å–µ–ª–æ","—É–ª–∏—Ü–∞","–ø–ª–æ—â–∞–¥—å","–ø–∞—Ä–∫","—Å–∞–¥","–ª–µ—Å","–ø–æ–ª–µ","–æ–∑–µ—Ä–æ","–æ–∫–µ–∞–Ω",
    "–∑–∏–º–∞","–≤–µ—Å–Ω–∞","–ª–µ—Ç–æ","–æ—Å–µ–Ω—å","—É—Ç—Ä–æ","–¥–µ–Ω—å","–≤–µ—á–µ—Ä","–Ω–æ—á—å","—á–∞—Å","–º–∏–Ω—É—Ç–∞",
    "—Ä–∞–±–æ—Ç–∞","–æ—Ç–¥—ã—Ö","–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ","–¥—Ä—É–≥","—Å–µ–º—å—è","–ª—é–±–æ–≤—å","—Å—á–∞—Å—Ç—å–µ","–º–µ—á—Ç–∞","—Ü–µ–ª—å","—É—Å–ø–µ—Ö"
];

// ============================================================
// –ê–í–ê–¢–ê–†
// ============================================================
const AVATAR_COLORS = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#e91e63'];
function getAvatarColor(name) {
    let h = 0;
    for (let c of name) h = (h * 31 + c.charCodeAt(0)) & 0xffffffff;
    return AVATAR_COLORS[Math.abs(h) % AVATAR_COLORS.length];
}
function renderAvatar(el, name) {
    if (!el || !name) return;
    el.style.background = getAvatarColor(name);
    el.textContent = name[0].toUpperCase();
}

// ============================================================
// FIREBASE: –•–†–ê–ù–ò–õ–ò–©–ï
// ============================================================
async function loadAllUsers() {
    showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
    try {
        const snap = await db.ref('users').get();
        users = snap.exists() ? snap.val() : {};
        await ensureSystemAccount();
        hideLoading();
        updateUsersList();
        updateUsersCounter();
        setFirebaseConnected(true);
    } catch (e) {
        console.error('Firebase load error:', e);
        hideLoading();
        const d = localStorage.getItem('ridcoin_current_user');
        if (d) {
            try {
                const saved = JSON.parse(d);
                if (saved.username && saved.data) users[saved.username] = saved.data;
            } catch(e) {}
        }
        await ensureSystemAccount();
        setFirebaseConnected(false);
        showToast('‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase, —Ä–∞–±–æ—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω', 'error');
        updateUsersList();
        updateUsersCounter();
    }
}

async function saveUser(username) {
    function safeCopy(data) {
        const s = Object.assign({}, data);
        delete s.passwordHash; delete s.password; delete s.recoveryPhraseHash;
        return s;
    }
    try {
        await db.ref(`users/${username}`).set(users[username]);
        await syncUserMeta(username);
        if (username === currentUser) {
            localStorage.setItem('ridcoin_current_user', JSON.stringify({username, data: safeCopy(users[username])}));
        }
    } catch (e) {
        if (username === currentUser) {
            localStorage.setItem('ridcoin_current_user', JSON.stringify({username, data: safeCopy(users[username])}));
        }
        showToast('‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)', 'error');
    }
}

let userListener = null;
function subscribeToUserUpdates(username) {
    if (userListener) { userListener(); userListener = null; }
    userListener = db.ref(`users/${username}`).on('value', snap => {
        if (snap.exists()) {
            users[username] = snap.val();
            if (currentUser === username) updateWalletDisplay();
        }
    });
}

// ============================================================
// –§–û–ù–î –ë–ï–°–ü–õ–ê–¢–ù–û–ô –†–ê–ó–î–ê–ß–ò ‚Äî —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ Firebase
// ============================================================
const AIRDROP_FUND_INITIAL = 1000000;

function subscribeToAirdropFund() {
    db.ref('airdropFund').on('value', snap => {
        const val = snap.exists() ? snap.val() : AIRDROP_FUND_INITIAL;
        const el = document.getElementById('airdropFundCounter');
        if (el) {
            el.textContent = val.toLocaleString('ru-RU');
            // –ê–Ω–∏–º–∞—Ü–∏—è –º–∏–≥–∞–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            el.style.transition = 'color 0.3s';
            el.style.color = '#fff';
            setTimeout(() => { el.style.color = 'var(--gold-primary)'; }, 300);
        }
    });
}

async function decrementAirdropFund() {
    try {
        await db.ref('airdropFund').transaction(current => {
            if (current === null) return AIRDROP_FUND_INITIAL - 1;
            if (current <= 0) return current;
            return current - 1;
        });
    } catch(e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–æ–Ω–¥ —Ä–∞–∑–¥–∞—á–∏:', e);
    }
}

function subscribeToUsersCount() {
    db.ref('usersMeta').on('value', snap => {
        if (!snap.exists()) return;
        const data = snap.val();
        const count = Object.keys(data).filter(u => !data[u].hidden).length;
        const el = document.getElementById('totalUsersCount');
        if (el) el.textContent = count;
        Object.keys(data).forEach(u => {
            if (!users[u]) users[u] = { balance: data[u].balance, admin: data[u].admin, hidden: data[u].hidden };
            else {
                users[u].balance = data[u].balance;
                users[u].admin   = data[u].admin;
                users[u].hidden  = data[u].hidden;
            }
        });
        updateUsersList();
    });
}

async function syncUserMeta(username) {
    if (!users[username]) return;
    const meta = {
        balance: users[username].balance || 0,
        admin:   users[username].admin   || false,
        hidden:  users[username].hidden  || false
    };
    try { await db.ref('usersMeta/' + username).set(meta); } catch(e) {}
}

function setFirebaseConnected(ok) {
    const badge  = document.getElementById('firebaseBadge');
    const status = document.getElementById('firebaseStatus');
    if (ok) {
        badge.classList.add('connected');
        status.textContent = 'Firebase –ø–æ–¥–∫–ª—é—á—ë–Ω';
    } else {
        badge.classList.remove('connected');
        status.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
    }
}

async function ensureSystemAccount() {
    if (users['RIDCOIN']) {
        let needSave = false;
        if (!users['RIDCOIN'].hidden) { users['RIDCOIN'].hidden = true; needSave = true; }
        if (!users['RIDCOIN'].admin)  { users['RIDCOIN'].admin  = true; needSave = true; }
        if (needSave) await db.ref('users/RIDCOIN').update({ hidden: true, admin: true });
    }
}

function updateUsersCounter() {
    const count = Object.keys(users).filter(u => !users[u].hidden).length;
    const el = document.getElementById('totalUsersCount');
    if (el) el.textContent = count;
}

// ============================================================
// –°–ü–ò–°–û–ö –ù–ê –≠–ö–†–ê–ù–ï –í–•–û–î–ê
// ============================================================
function updateUsersList() {
    const visible = getSortedUsers();
    const listDiv = document.getElementById('userList');
    const container = document.getElementById('usersContainer');
    if (visible.length === 0) { listDiv.style.display = 'none'; return; }
    listDiv.style.display = 'block';
    container.innerHTML = '';
    visible.forEach(({username, user}) => {
        const balance = user.balance || 0;
        const div = document.createElement('div');
        div.className = user.admin ? 'user-item user-item-admin' : 'user-item';
        div.innerHTML = `
            <div class="balance-display" style="display:flex;align-items:center;gap:10px;">
                <div style="width:36px;height:36px;border-radius:50%;background:${getAvatarColor(username)};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;flex-shrink:0;">${username[0].toUpperCase()}</div>
                <strong>${escapeHtml(username)}</strong> ${user.admin ? '<span class="crown-icon">üëë</span>' : ''}
            </div>
            <span class="${balance===0?'zero-balance':'gold-text'}">${formatRid(balance)} RID</span>`;
        container.appendChild(div);
    });
}

function getSortedUsers() {
    return Object.keys(users)
        .filter(u => !users[u].hidden)
        .map(u => ({username:u, user:users[u]}))
        .sort((a,b) => {
            if (a.user.admin && !b.user.admin) return -1;
            if (!a.user.admin && b.user.admin) return 1;
            return (b.user.balance||0) - (a.user.balance||0);
        });
}

// ============================================================
// –ì–†–ê–§–ò–ö –ö–£–†–°–ê
// ============================================================
function drawRidChart() {
    const canvas = document.getElementById('ridChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.offsetWidth; const H = 120;
    canvas.width = W; canvas.height = H;
    const price = getCurrentRidPrice();
    const points = [];
    for (let i = 6; i >= 0; i--) points.push(price - i * RID_DAILY_INCREASE);
    const minP = Math.min(...points) - 1;
    const maxP = Math.max(...points) + 1;
    const pad = { top:10, bottom:25, left:8, right:8 };
    const chartW = W - pad.left - pad.right;
    const chartH = H - pad.top - pad.bottom;
    const toX = i => pad.left + (i / (points.length - 1)) * chartW;
    const toY = v => pad.top + (1 - (v - minP) / (maxP - minP)) * chartH;
    const grad = ctx.createLinearGradient(0, pad.top, 0, H - pad.bottom);
    grad.addColorStop(0, 'rgba(241,196,15,0.3)');
    grad.addColorStop(1, 'rgba(241,196,15,0)');
    ctx.beginPath();
    points.forEach((p, i) => i === 0 ? ctx.moveTo(toX(i), toY(p)) : ctx.lineTo(toX(i), toY(p)));
    ctx.lineTo(toX(points.length-1), H - pad.bottom);
    ctx.lineTo(toX(0), H - pad.bottom);
    ctx.closePath();
    ctx.fillStyle = grad; ctx.fill();
    ctx.beginPath();
    points.forEach((p, i) => i === 0 ? ctx.moveTo(toX(i), toY(p)) : ctx.lineTo(toX(i), toY(p)));
    ctx.strokeStyle = '#F1C40F'; ctx.lineWidth = 2.5; ctx.lineJoin = 'round'; ctx.stroke();
    const now = new Date();
    points.forEach((p, i) => {
        ctx.beginPath(); ctx.arc(toX(i), toY(p), 3.5, 0, Math.PI*2); ctx.fillStyle = '#F1C40F'; ctx.fill();
        const d = new Date(now); d.setDate(d.getDate() - (6 - i));
        const label = `${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}`;
        ctx.fillStyle = 'rgba(192,192,192,0.6)'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(label, toX(i), H - 5);
    });
    ctx.fillStyle = '#F1C40F'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(`${price.toFixed(0)} USD`, W - pad.right, pad.top + 12);
}

// ============================================================
// –ß–ê–°–¢–ò–¶–´
// ============================================================
function launchParticles() {
    const canvas = document.getElementById('particles-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    canvas.classList.add('active');
    const particles = Array.from({length: 60}, () => ({
        x: Math.random() * canvas.width, y: Math.random() * canvas.height,
        r: Math.random() * 4 + 2, dx: (Math.random() - 0.5) * 3, dy: -(Math.random() * 4 + 2),
        alpha: 1, color: ['#F1C40F','#FFD700','#fff','#B8860B'][Math.floor(Math.random()*4)]
    }));
    let frame = 0;
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
            p.x += p.dx; p.y += p.dy; p.alpha -= 0.015;
            ctx.save(); ctx.globalAlpha = Math.max(0, p.alpha);
            ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
            ctx.fillStyle = p.color; ctx.fill(); ctx.restore();
        });
        frame++;
        if (frame < 80) requestAnimationFrame(animate);
        else { canvas.classList.remove('active'); ctx.clearRect(0,0,canvas.width,canvas.height); }
    }
    animate();
}

// ============================================================
// POLYGON –ë–ê–õ–ê–ù–°
// ============================================================
const CHAIN_WALLET   = '0xa09073eFC2aaf713799A04c21440199783713972';
const CHAIN_CONTRACT = '0xcD36914FD4C560D1475088eB84bB82C11f3E19DE';
const POLYGON_RPC    = 'https://polygon-rpc.com';

async function loadChainBalance() {
    const valEl = document.getElementById('chainBalance');
    const subEl = document.getElementById('chainBalanceSub');
    if (!valEl) return;
    valEl.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...'; subEl.textContent = '';
    try {
        const data = '0x70a08231' + CHAIN_WALLET.replace('0x','').padStart(64,'0');
        const resp = await fetch(POLYGON_RPC, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jsonrpc:'2.0', method:'eth_call', params:[{to:CHAIN_CONTRACT, data},'latest'], id:1 })
        });
        const json = await resp.json();
        if (json.result && json.result !== '0x') {
            const raw = BigInt(json.result);
            const whole = raw / (10n ** 18n);
            valEl.textContent = Number(whole).toLocaleString('ru-RU') + ' RID';
            subEl.textContent = '–ê–¥—Ä–µ—Å: ' + CHAIN_WALLET.slice(0,8) + '...' + CHAIN_WALLET.slice(-6) + ' ¬∑ Polygon';
        } else {
            valEl.textContent = '0 RID'; subEl.textContent = '–ë–∞–ª–∞–Ω—Å –Ω–µ –Ω–∞–π–¥–µ–Ω';
        }
    } catch(e) {
        valEl.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞'; subEl.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏';
    }
}

// ============================================================
// –°–ò–õ–ê –ü–ê–†–û–õ–Ø
// ============================================================
function evalPasswordStrength(pw) {
    if (!pw) return null;
    let s = 0;
    if (pw.length >= 6) s++;
    if (pw.length >= 10) s++;
    if (/[0-9]/.test(pw)) s++;
    if (/[A-Za-z]/.test(pw)) s++;
    if (/[^A-Za-z0-9]/.test(pw)) s++;
    return s <= 2 ? 'weak' : s <= 3 ? 'medium' : 'strong';
}
function applyStrength(barId, labelId, pw) {
    const bar = document.getElementById(barId), label = document.getElementById(labelId);
    const s = evalPasswordStrength(pw);
    if (!s) { bar.className = 'password-strength'; label.textContent = ''; return; }
    bar.className = `password-strength ${s}`;
    label.className = `strength-label ${s}`;
    label.textContent = {weak:'–°–ª–∞–±—ã–π', medium:'–°—Ä–µ–¥–Ω–∏–π', strong:'–ù–∞–¥—ë–∂–Ω—ã–π'}[s];
}
function checkPasswordStrength(pw) { applyStrength('pwStrengthBar','pwStrengthLabel',pw); }
function checkNewPasswordStrength(pw) { applyStrength('cpStrengthBar','cpStrengthLabel',pw); }

// ============================================================
// –§–†–ê–ó–ê –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø
// ============================================================
function cryptoRandInt(max) {
    const arr = new Uint32Array(1);
    crypto.getRandomValues(arr);
    return arr[0] % max;
}
function generateRecoveryPhrase() {
    const words = [];
    for (let i = 0; i < 12; i++) words.push(RECOVERY_WORDS_FULL[cryptoRandInt(RECOVERY_WORDS_FULL.length)]);
    currentRecoveryPhrase = words.join(' ');
    const d = document.getElementById('recoveryPhraseDisplay');
    d.innerHTML = '';
    words.forEach((w,i) => {
        const s = document.createElement('span'); s.className='phrase-word';
        s.textContent=`${i+1}. ${w}`; d.appendChild(s);
    });
    return currentRecoveryPhrase;
}
function copyRecoveryPhrase() {
    if (!currentRecoveryPhrase) { showToast('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ñ—Ä–∞–∑—É!','error'); return; }
    navigator.clipboard.writeText(currentRecoveryPhrase)
        .then(() => showToast('–§—Ä–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!','success'))
        .catch(() => {
            const ta=document.createElement('textarea'); ta.value=currentRecoveryPhrase;
            document.body.appendChild(ta); ta.select(); document.execCommand('copy');
            document.body.removeChild(ta); showToast('–§—Ä–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!','success');
        });
}

// ============================================================
// –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
// ============================================================
function showRegisterModal() {
    document.getElementById('registerModal').style.display = 'flex';
    generateRecoveryPhrase();
}
function hideRegisterModal() { document.getElementById('registerModal').style.display = 'none'; }

function checkRegRateLimit() {
    const key = 'ridcoin_reg_attempts';
    const now = Date.now();
    const WINDOW = 60 * 60 * 1000;
    const MAX = 3;
    let attempts = [];
    try { attempts = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) { attempts = []; }
    attempts = attempts.filter(t => now - t < WINDOW);
    if (attempts.length >= MAX) {
        const wait = Math.ceil((WINDOW - (now - attempts[0])) / 60000);
        showToast('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ ' + wait + ' –º–∏–Ω.', 'error');
        return false;
    }
    attempts.push(now);
    localStorage.setItem(key, JSON.stringify(attempts));
    return true;
}

function isValidUsername(name) {
    return /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_-]{3,32}$/.test(name);
}

async function createAccount() {
    const username = document.getElementById('reg-username').value.trim();
    const password = document.getElementById('reg-password').value;
    const confirm  = document.getElementById('reg-confirm').value;
    if (!username)                          { showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è','error'); return; }
    if (!isValidUsername(username))         { showToast('–ò–º—è: 3-32 —Å–∏–º–≤–æ–ª–∞, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã/_/-','error'); return; }
    if (username.toUpperCase()==='RIDCOIN') { showToast('–≠—Ç–æ –∏–º—è –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ','error'); return; }
    if (!checkRegRateLimit())               { return; }
    if (users[username])                    { showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç','error'); return; }
    if (!password || password.length < 6)  { showToast('–ü–∞—Ä–æ–ª—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤','error'); return; }
    if (password !== confirm)              { showToast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç','error'); return; }
    if (!currentRecoveryPhrase)            { showToast('–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ñ—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è','error'); return; }

    showLoading('–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞...');
    const pwHash = await hashPassword(password);
    const phraseHash = await hashPhrase(currentRecoveryPhrase);

    users[username] = {
        passwordHash: pwHash,
        recoveryPhraseHash: phraseHash,
        balance: 1,
        history: ['üÜï –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω', `[${new Date().toLocaleString('ru-RU')}] ‚Üê RIDCOIN: 1.00 RID | üéÅ –ë–æ–Ω—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é`],
        admin: false,
        createdAt: new Date().toISOString(),
        lastLogin: null,
        sentTotal: 0, receivedTotal: 1, txCount: 1
    };

    // –°–ø–∏—Å—ã–≤–∞–µ–º 1 RID —Å –∞–∫–∫–∞—É–Ω—Ç–∞ RIDCOIN
    try {
        const ridcoinSnap = await db.ref('users/RIDCOIN').get();
        if (ridcoinSnap.exists()) {
            const ridcoinData = ridcoinSnap.val();
            const date = new Date().toLocaleString('ru-RU');
            ridcoinData.balance   = (ridcoinData.balance || 0) - 1;
            ridcoinData.sentTotal = (ridcoinData.sentTotal || 0) + 1;
            ridcoinData.txCount   = (ridcoinData.txCount || 0) + 1;
            if (!Array.isArray(ridcoinData.history)) ridcoinData.history = [];
            ridcoinData.history.push(`[${date}] ‚Üí ${username}: 1.00 RID | üéÅ –ë–æ–Ω—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é`);
            const updates = {};
            updates[`users/RIDCOIN`] = ridcoinData;
            updates[`users/${username}`] = users[username];
            await db.ref().update(updates);
            users['RIDCOIN'] = ridcoinData;
        } else {
            await saveUser(username);
        }
    } catch(e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–ø–∏—Å–∞—Ç—å —Å RIDCOIN:', e);
        await saveUser(username);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ usersMeta –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
    try {
        await db.ref(`usersMeta/${username}`).set({
            balance: 1,
            admin: false,
            hidden: false
        });
    } catch(e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å usersMeta:', e);
    }

    await decrementAirdropFund();
    hideLoading();
    hideRegisterModal();
    showToast(`‚úÖ –ö–æ—à–µ–ª—ë–∫ "${username}" —Å–æ–∑–¥–∞–Ω!`, 'success');
    setTimeout(() => alert(`‚úÖ –§—Ä–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:\n\n${currentRecoveryPhrase}\n\n‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ—ë –≤ –Ω–∞–¥—ë–∂–Ω–æ–º –º–µ—Å—Ç–µ!`), 300);
    currentUser = username;
    subscribeToUserUpdates(username);
    showWallet();
}

// ============================================================
// –í–•–û–î
// ============================================================
async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    if (!username) { showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è','error'); return; }
    if (!password) { showToast('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å','error'); return; }

    showLoading('–í—Ö–æ–¥...');
    try {
        const snap = await db.ref(`users/${username}`).get();
        if (!snap.exists()) { hideLoading(); showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
        users[username] = snap.val();
    } catch(e) {
        hideLoading();
        if (!users[username]) { showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)','error'); return; }
    }

    const u = users[username];
    const MAX_ATTEMPTS = 5;
    const BLOCK_MS     = 15 * 60 * 1000;
    const now          = Date.now();
    const blockedUntil = u.blockedUntil || 0;
    const failCount    = u.failedLogins || 0;

    if (now < blockedUntil) {
        const mins = Math.ceil((blockedUntil - now) / 60000);
        hideLoading();
        showToast(`‚õî –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${mins} –º–∏–Ω.`, 'error');
        return;
    }

    let valid = false;
    if (u.passwordHash) {
        valid = await verifyPassword(password, u.passwordHash);
        if (valid && !u.passwordHash.startsWith('pbkdf2$')) {
            u.passwordHash = await hashPassword(password);
        }
    } else if (u.password) {
        valid = u.password === password;
        if (valid) { u.passwordHash = await hashPassword(password); delete u.password; }
    }

    if (!valid) {
        const newFail = failCount + 1;
        const updates = { failedLogins: newFail };
        if (newFail >= MAX_ATTEMPTS) {
            updates.blockedUntil = now + BLOCK_MS;
            updates.failedLogins = 0;
            await db.ref(`users/${username}`).update(updates);
            hideLoading();
            showToast(`‚õî –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫! –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 15 –º–∏–Ω—É—Ç.`, 'error');
        } else {
            await db.ref(`users/${username}`).update(updates);
            hideLoading();
            showToast(`–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ${MAX_ATTEMPTS - newFail}`, 'error');
        }
        return;
    }

    u.failedLogins  = 0;
    u.blockedUntil  = 0;

    if (u.recoveryPhrase && !u.recoveryPhraseHash) {
        u.recoveryPhraseHash = await hashPhrase(u.recoveryPhrase);
        delete u.recoveryPhrase;
    }

    u.lastLogin = new Date().toISOString();
    await saveUser(username);
    hideLoading();
    currentUser = username;
    subscribeToUserUpdates(username);
    showWallet();
    launchParticles();
}

// ============================================================
// –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ü–ê–†–û–õ–Ø
// ============================================================
function showRecoveryModal() { document.getElementById('recoveryModal').style.display='flex'; document.getElementById('recoveryError').style.display='none'; }
function hideRecoveryModal() { document.getElementById('recoveryModal').style.display='none'; }

async function recoverPassword() {
    const username = document.getElementById('recovery-username').value.trim();
    const phrase   = document.getElementById('recovery-phrase-input').value.trim();
    const errDiv   = document.getElementById('recoveryError');
    errDiv.style.display = 'none';
    if (!username) { errDiv.textContent='–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'; errDiv.style.display='block'; return; }

    showLoading('–ü—Ä–æ–≤–µ—Ä–∫–∞...');
    try {
        const snap = await db.ref(`users/${username}`).get();
        if (!snap.exists()) { hideLoading(); errDiv.textContent='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'; errDiv.style.display='block'; return; }
        users[username] = snap.val();
    } catch(e) {
        hideLoading();
        if (!users[username]) { errDiv.textContent='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'; errDiv.style.display='block'; return; }
    }
    hideLoading();

    if (!phrase) { errDiv.textContent='–í–≤–µ–¥–∏—Ç–µ —Ñ—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è'; errDiv.style.display='block'; return; }
    const phraseMatch = await verifyPhrase(phrase, users[username].recoveryPhraseHash)
        || (users[username].recoveryPhrase && phrase.toLowerCase().trim() === users[username].recoveryPhrase.toLowerCase().trim());
    if (!phraseMatch) { errDiv.textContent='–ù–µ–≤–µ—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è'; errDiv.style.display='block'; return; }

    hideRecoveryModal();
    const newPw = prompt('‚úÖ –§—Ä–∞–∑–∞ –≤–µ—Ä–Ω–∞!\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤):');
    if (!newPw || newPw.length < 6) { showToast('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π','error'); return; }
    showLoading('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    users[username].passwordHash = await hashPassword(newPw);
    delete users[username].password;
    await saveUser(username);
    hideLoading();
    showToast('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω! –í–æ–π–¥–∏—Ç–µ —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º.','success');
    document.getElementById('username').value = username;
}

// ============================================================
// –ö–û–®–ï–õ–Å–ö
// ============================================================
function showWallet() {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('wallet').style.display = 'block';
    refreshAdminPanel();
    updateWalletDisplay();
    subscribeToUnread(currentUser);
}

function refreshAdminPanel() {
    const isAdmin   = currentUser && users[currentUser] && users[currentUser].admin === true;
    const isRidcoin = currentUser === 'RIDCOIN';
    document.getElementById('adminPanel').style.display = (isAdmin && isRidcoin) ? 'block' : 'none';
}

function updateWalletDisplay() {
    if (!currentUser || !users[currentUser]) return;
    const user = users[currentUser];
    const ridBalance = user.balance || 0;
    const ridPrice   = getCurrentRidPrice();
    const usdValue   = (ridBalance * ridPrice).toFixed(2);

    document.getElementById('userName').textContent = currentUser;
    renderAvatar(document.getElementById('profileAvatar'), currentUser);

    const balDiv = document.getElementById('balance');
    balDiv.textContent = formatRid(ridBalance) + ' RID';
    balDiv.style.color = ridBalance === 0 ? '#e74c3c' : '#F1C40F';

    document.getElementById('usdBalance').innerHTML = `‚âà ${usdValue} USD`;
    document.getElementById('userBadge').textContent = user.admin ? 'üëë –ê–î–ú–ò–ù' : 'üë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨';

    const ll = document.getElementById('lastLoginNote');
    if (user.lastLogin) ll.textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: ${new Date(user.lastLogin).toLocaleString('ru-RU')}`;

    document.getElementById('statTxCount').textContent  = user.txCount || 0;
    document.getElementById('statVolume').textContent   = formatRid(user.sentTotal || 0);
    document.getElementById('statReceived').textContent = formatRid(user.receivedTotal || 0);
    document.getElementById('statDaysActive').textContent = user.createdAt
        ? Math.floor((Date.now() - new Date(user.createdAt).getTime()) / 86400000) : 0;

    drawRidChart();
    loadChainBalance();
    updateHistory();
    updateUsersList();
}

// ============================================================
// –ò–°–¢–û–†–ò–Ø
// ============================================================
function setHistoryFilter(f, btn) {
    historyFilter = f; historyPage = 0;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    updateHistory();
}
function getFilteredHistory() {
    if (!currentUser || !users[currentUser]) return [];
    const raw = (users[currentUser].history || []).slice().reverse();
    if (historyFilter === 'all') return raw;
    return raw.filter(t => historyFilter === 'in' ? (t.includes('‚Üê')||t.includes('—Å–æ–∑–¥–∞–Ω')) : t.includes('‚Üí'));
}
function updateHistory() {
    const div = document.getElementById('history');
    div.innerHTML = '';
    const all = getFilteredHistory();
    const totalPages = Math.ceil(all.length / HISTORY_PAGE_SIZE);
    if (historyPage >= totalPages && totalPages > 0) historyPage = totalPages - 1;
    const page = all.slice(historyPage * HISTORY_PAGE_SIZE, (historyPage + 1) * HISTORY_PAGE_SIZE);
    if (!page.length) {
        div.innerHTML = '<p style="color:#777;text-align:center;padding:10px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>';
    } else {
        page.forEach(t => {
            const item = document.createElement('div');
            let kind = 'system', kindLabel = '–°–∏—Å—Ç–µ–º–∞';
            if (t.includes('‚Üí')) { kind='out'; kindLabel='‚ñ≤ –ò—Å—Ö–æ–¥—è—â–∏–π'; }
            else if (t.includes('‚Üê')) { kind='in'; kindLabel='‚ñº –í—Ö–æ–¥—è—â–∏–π'; }
            const dateMatch   = t.match(/^\[(.+?)\]/);
            const amountMatch = t.match(/([\d\s.,]+ RID|\d+ —Å–∞—Ç–æ—à–∏)/);
            const usdMatch    = t.match(/\(\$([^)]+)\)/);
            const commentIdx  = t.lastIndexOf('|');
            const comment     = commentIdx !== -1 ? t.slice(commentIdx+1).trim() : '';
            let counterpart = '';
            if (t.includes('‚Üí')) counterpart = (t.match(/‚Üí\s*(.+?):/)||[])[1]?.trim()||'';
            if (t.includes('‚Üê')) counterpart = (t.match(/‚Üê\s*(.+?):/)||[])[1]?.trim()||'';
            item.className = `history-item ${kind}`;
            item.innerHTML = `
                <div class="hi-top">
                    <span class="hi-type ${kind}">${kindLabel}${counterpart?' ‚Ä¢ '+counterpart:''}</span>
                    <span class="hi-amount">${amountMatch?amountMatch[0]:''}</span>
                </div>
                <div class="hi-meta">${dateMatch?dateMatch[1]:''}${usdMatch?' ‚Ä¢ $'+usdMatch[1]:''}</div>
                ${comment?`<div class="hi-comment">üí¨ ${escapeHtml(comment)}</div>`:''}`;
            div.appendChild(item);
        });
    }
    const pag = document.getElementById('historyPagination');
    if (totalPages > 1) {
        pag.style.display = 'flex';
        document.getElementById('pageInfo').textContent = `${historyPage+1} / ${totalPages}`;
    } else { pag.style.display = 'none'; }
}
function historyPagePrev() { if (historyPage > 0) { historyPage--; updateHistory(); } }
function historyPageNext() {
    if (historyPage < Math.ceil(getFilteredHistory().length / HISTORY_PAGE_SIZE) - 1) { historyPage++; updateHistory(); }
}

// ============================================================
// –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï
// ============================================================
function onRecipientInput(val) {
    const list = document.getElementById('autocompleteList');
    if (!val) { list.style.display='none'; return; }
    const matches = Object.keys(users).filter(u => u !== currentUser && !users[u].hidden && u.toLowerCase().startsWith(val.toLowerCase()));
    if (!matches.length) { list.style.display='none'; return; }
    list.innerHTML = '';
    matches.slice(0,6).forEach(name => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = `<div class="ac-avatar" style="background:${getAvatarColor(name)};color:#fff;">${escapeHtml(name[0].toUpperCase())}</div><span>${escapeHtml(name)}</span>${users[name].admin?'<span class="crown-icon" style="margin-left:auto;">üëë</span>':''}`;
        item.addEventListener('mousedown', () => { document.getElementById('to').value = name; list.style.display='none'; });
        list.appendChild(item);
    });
    list.style.display = 'block';
}
function hideAutocomplete() { setTimeout(() => { const l=document.getElementById('autocompleteList'); if(l) l.style.display='none'; }, 150); }

// ============================================================
// –ü–ï–†–ï–í–û–î
// ============================================================
function initiateSend() {
    if (!currentUser || !users[currentUser]) return;
    const to      = document.getElementById('to').value.trim();
    const amount  = parseFloat(document.getElementById('amount').value);
    const comment = document.getElementById('transferComment').value.trim();
    const errDiv  = document.getElementById('amountError');
    errDiv.style.display = 'none';
    const showErr = msg => { errDiv.textContent=msg; errDiv.style.display='block'; };
    if (!to)                                     { showErr('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è'); return; }
    if (!amount || isNaN(amount) || amount <= 0) { showErr('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É'); return; }
    if (Math.floor(amount*SATOSHI_PER_RID) < 1)  { showErr('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 0.00000001 RID'); return; }
    if (!users[to])                              { showErr(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${to}" –Ω–µ –Ω–∞–π–¥–µ–Ω`); return; }
    if (currentUser === to)                      { showErr('–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ'); return; }
    if ((users[currentUser].balance||0) < amount){ showErr(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ RID. –ë–∞–ª–∞–Ω—Å: ${formatRid(users[currentUser].balance||0)} RID`); return; }
    const ridPrice = getCurrentRidPrice();
    document.getElementById('confirmDetails').innerHTML = `
        <div class="confirm-row"><span class="label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</span><span class="value">${escapeHtml(to)}</span></div>
        <div class="confirm-row"><span class="label">–°—É–º–º–∞</span><span class="value">${formatRid(amount)} RID</span></div>
        <div class="confirm-row"><span class="label">–í USD</span><span class="value">‚âà $${(amount*ridPrice).toFixed(2)}</span></div>
        ${comment?`<div class="confirm-row"><span class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span><span class="value">${escapeHtml(comment)}</span></div>`:''}`;
    pendingTransfer = {to, amount, comment};
    document.getElementById('confirmModal').style.display = 'flex';
}
function hideConfirmModal() { document.getElementById('confirmModal').style.display='none'; pendingTransfer=null; }

async function confirmSend() {
    if (!pendingTransfer) return;
    const {to, amount, comment} = pendingTransfer;
    hideConfirmModal();
    showLoading('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞...');

    const amountSatoshi = Math.floor(amount * SATOSHI_PER_RID);
    const amountToSend  = amountSatoshi / SATOSHI_PER_RID;
    let displayAmount;
    if (amountToSend >= 0.01)          displayAmount = amountToSend.toFixed(2) + ' RID';
    else if (amountToSend >= 0.000001) displayAmount = amountToSend.toFixed(6) + ' RID';
    else                               displayAmount = amountSatoshi + ' —Å–∞—Ç–æ—à–∏';

    const password = prompt('üîê –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞:');
    if (!password) { hideLoading(); return; }

    try {
        const response = await fetch('https://ridcoin.vercel.app/api/transfer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({from: currentUser, password, to, amount: amountToSend, comment})
        });

        const result = await response.json();

        if (!response.ok) {
            hideLoading();
            showToast('–û—à–∏–±–∫–∞: ' + result.error, 'error');
            return;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase
        const senderSnap = await db.ref(`users/${currentUser}`).get();
        if (senderSnap.exists()) {
            users[currentUser] = senderSnap.val();
            localStorage.setItem('ridcoin_current_user', JSON.stringify({username: currentUser, data: users[currentUser]}));
        }

    } catch (e) {
        hideLoading();
        showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: ' + e.message, 'error');
        return;
    }

    hideLoading();
    const balDiv = document.getElementById('balance');
    balDiv.classList.remove('flash'); void balDiv.offsetWidth; balDiv.classList.add('flash');
    updateWalletDisplay();
    document.getElementById('to').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('transferComment').value = '';
    showToast(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${displayAmount} ‚Üí ${to}`, 'success');
}

// ============================================================
// –ü–†–û–§–ò–õ–¨
// ============================================================
function showProfileModal() {
    const user = users[currentUser];
    document.getElementById('profileModal').style.display = 'flex';
    renderAvatar(document.getElementById('profileAvatarModal'), currentUser);
    document.getElementById('profileName').textContent = currentUser + (user.admin ? ' üëë' : '');
    document.getElementById('profileCreated').textContent = `–°–æ–∑–¥–∞–Ω: ${new Date(user.createdAt).toLocaleDateString('ru-RU')}`;
    document.getElementById('cpError').style.display = 'none';
    ['cp-current','cp-new','cp-confirm'].forEach(id => document.getElementById(id).value = '');
    applyStrength('cpStrengthBar','cpStrengthLabel','');
}
function hideProfileModal() { document.getElementById('profileModal').style.display='none'; }

async function changePassword() {
    const current = document.getElementById('cp-current').value;
    const newPw   = document.getElementById('cp-new').value;
    const confirm = document.getElementById('cp-confirm').value;
    const errDiv  = document.getElementById('cpError');
    errDiv.style.display = 'none';
    const showErr = msg => { errDiv.textContent=msg; errDiv.style.display='block'; };
    const user = users[currentUser];
    let valid = false;
    if (user.passwordHash) valid = await verifyPassword(current, user.passwordHash);
    else if (user.password) valid = user.password === current;
    if (!valid)           { showErr('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å'); return; }
    if (newPw.length < 6) { showErr('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å ‚Äî –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
    if (newPw !== confirm) { showErr('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); return; }
    showLoading('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    user.passwordHash = await hashPassword(newPw);
    delete user.password;
    await saveUser(currentUser);
    hideLoading();
    hideProfileModal();
    showToast('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!', 'success');
}

// ============================================================
// –í–°–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º)
// ============================================================
function showAllUsers() {
    if (currentUser === 'RIDCOIN') { showAllUsersAdmin(); return; }
    const modal = document.getElementById('usersModal');
    const listDiv = document.getElementById('allUsersList');
    listDiv.innerHTML = '';
    getSortedUsers().forEach(({username, user}) => {
        const balance = user.balance || 0;
        const div = document.createElement('div');
        div.className = user.admin ? 'user-item user-item-admin' : 'user-item';
        div.style.marginBottom='15px'; div.style.padding='15px';
        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:42px;height:42px;border-radius:50%;background:${getAvatarColor(username)};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;flex-shrink:0;">${username[0].toUpperCase()}</div>
                <div>
                    <div style="font-size:17px;font-weight:700;">${escapeHtml(username)} ${user.admin?'<span class="admin-badge">üëë –ê–î–ú–ò–ù</span>':''}</div>
                    <div>–ë–∞–ª–∞–Ω—Å: <span class="${balance===0?'zero-balance':'gold-text'}">${formatRid(balance)} RID</span></div>
                    <div style="color:#777;font-size:13px;">–°–æ–∑–¥–∞–Ω: ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ru-RU') : '‚Äî'} ¬∑ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${user.txCount||0}</div>
                </div>
            </div>`;
        listDiv.appendChild(div);
    });
    modal.style.display = 'flex';
}
function hideUsersModal() { document.getElementById('usersModal').style.display='none'; }

// ============================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò ‚Äî ADMIN (–í–´–ë–û–†–û–ß–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï)
// ============================================================
function showAllUsersAdmin() {
    if (currentUser !== 'RIDCOIN' || !users[currentUser]?.admin) {
        showToast('‚õî –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞', 'error'); return;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—ç—à
    adminUsersCache = Object.keys(users)
        .filter(u => u !== 'RIDCOIN')
        .map(u => ({username: u, user: users[u]}))
        .sort((a,b) => (b.user.balance||0) - (a.user.balance||0));

    document.getElementById('adminUserSearch').value = '';
    renderAdminUsersList(adminUsersCache);
    document.getElementById('adminUsersModal').style.display = 'flex';
}

function hideAdminUsersModal() {
    document.getElementById('adminUsersModal').style.display = 'none';
}

function filterAdminUsersList(query) {
    const q = query.toLowerCase().trim();
    const filtered = q
        ? adminUsersCache.filter(({username}) => username.toLowerCase().includes(q))
        : adminUsersCache;
    renderAdminUsersList(filtered);
}

function renderAdminUsersList(list) {
    const container = document.getElementById('adminUsersList');
    const label     = document.getElementById('adminUsersCountLabel');
    container.innerHTML = '';

    const total = adminUsersCache.length;
    const shown = list.length;
    label.textContent = shown === total
        ? `–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${total}`
        : `–ü–æ–∫–∞–∑–∞–Ω–æ: ${shown} –∏–∑ ${total}`;

    if (!list.length) {
        container.innerHTML = '<div style="text-align:center;color:#555;padding:30px;font-size:14px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }

    list.forEach(({username, user}) => {
        const balance = user.balance || 0;
        const div = document.createElement('div');
        div.className = 'user-item';
        div.style.cssText = 'margin-bottom:12px;padding:14px;flex-wrap:nowrap;gap:10px;';

        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
                <div style="width:42px;height:42px;border-radius:50%;background:${getAvatarColor(username)};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;flex-shrink:0;">${escapeHtml(username[0].toUpperCase())}</div>
                <div style="min-width:0;">
                    <div style="font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                        ${escapeHtml(username)}
                        ${user.hidden ? '<span style="color:#e74c3c;font-size:11px;"> [—Å–∫—Ä—ã—Ç—ã–π]</span>' : ''}
                        ${user.admin  ? '<span class="admin-badge" style="font-size:11px;padding:3px 8px;">üëë</span>' : ''}
                    </div>
                    <div style="font-size:13px;margin-top:2px;">
                        –ë–∞–ª–∞–Ω—Å: <span class="${balance===0?'zero-balance':'gold-text'}">${formatRid(balance)} RID</span>
                    </div>
                    <div style="color:#555;font-size:12px;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${user.txCount||0}</div>
                </div>
            </div>
            <button class="delete-user-btn" onclick="deleteUserConfirm('${escapeHtml(username)}')">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </button>`;

        container.appendChild(div);
    });
}

async function deleteUserConfirm(username) {
    if (currentUser !== 'RIDCOIN' || !users[currentUser]?.admin) {
        showToast('‚õî –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞', 'error'); return;
    }
    if (username === 'RIDCOIN') {
        showToast('‚õî –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç', 'error'); return;
    }

    const balance = formatRid(users[username]?.balance || 0);
    const txCount = users[username]?.txCount || 0;

    if (!confirm(`‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}"?\n\n–ë–∞–ª–∞–Ω—Å: ${balance} RID\n–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${txCount}\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) return;

    showLoading(`–£–¥–∞–ª–µ–Ω–∏–µ "${username}"...`);
    try {
        await db.ref(`users/${username}`).remove();
        await db.ref(`usersMeta/${username}`).remove();
        // –£–¥–∞–ª—è–µ–º —Ç–∞–∫–∂–µ –∏–Ω–¥–µ–∫—Å—ã –õ–°
        await db.ref(`dmIndex/${username}`).remove();
        delete users[username];

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
        adminUsersCache = adminUsersCache.filter(item => item.username !== username);
        const searchVal = document.getElementById('adminUserSearch').value;
        filterAdminUsersList(searchVal);

        hideLoading();
        updateUsersList();
        updateUsersCounter();
        showToast(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${username}" —É–¥–∞–ª—ë–Ω`, 'success');
    } catch(e) {
        hideLoading();
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message, 'error');
    }
}

// ============================================================
// –ü–û–ü–û–õ–ù–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê (—Ç–æ–ª—å–∫–æ –¥–ª—è RIDCOIN)
// ============================================================
function addBalanceModal() {
    if (currentUser !== 'RIDCOIN' || !users[currentUser]?.admin) {
        showToast('‚õî –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞', 'error'); return;
    }
    document.getElementById('addBalanceModal').style.display = 'flex';
    document.getElementById('ab-username').value = '';
    document.getElementById('ab-amount').value = '';
    document.getElementById('abError').style.display = 'none';
}
function hideAddBalanceModal() { document.getElementById('addBalanceModal').style.display = 'none'; }

async function confirmAddBalance() {
    if (currentUser !== 'RIDCOIN' || !users[currentUser]?.admin) {
        showToast('‚õî –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞', 'error'); return;
    }
    const username = document.getElementById('ab-username').value.trim();
    const amount   = parseFloat(document.getElementById('ab-amount').value);
    const errDiv   = document.getElementById('abError');
    errDiv.style.display = 'none';
    const showErr = msg => { errDiv.textContent = msg; errDiv.style.display = 'block'; };
    if (!username)                               { showErr('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); return; }
    if (!users[username])                        { showErr('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    if (users[username].hidden)                  { showErr('–ù–µ–ª—å–∑—è –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç'); return; }
    if (!amount || isNaN(amount) || amount <= 0) { showErr('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É'); return; }
    if ((users['RIDCOIN'].balance || 0) < amount){ showErr('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á—ë—Ç–µ RIDCOIN'); return; }

    showLoading('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...');
    try {
        const [ridSnap, userSnap] = await Promise.all([
            db.ref('users/RIDCOIN').get(),
            db.ref(`users/${username}`).get()
        ]);
        const ridData  = ridSnap.exists()  ? ridSnap.val()  : users['RIDCOIN'];
        const userData = userSnap.exists() ? userSnap.val() : users[username];

        if ((ridData.balance || 0) < amount) {
            hideLoading(); showErr('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å)'); return;
        }

        const date     = new Date().toLocaleString('ru-RU');
        const ridPrice = getCurrentRidPrice();
        const usdValue = (amount * ridPrice).toFixed(2);
        const display  = formatRid(amount) + ' RID';

        ridData.balance   = (ridData.balance || 0) - amount;
        ridData.sentTotal = (ridData.sentTotal || 0) + amount;
        ridData.txCount   = (ridData.txCount  || 0) + 1;
        if (!Array.isArray(ridData.history)) ridData.history = [];
        ridData.history.push(`[${date}] ‚Üí ${username}: ${display} ($${usdValue})`);

        userData.balance       = (userData.balance || 0) + amount;
        userData.receivedTotal = (userData.receivedTotal || 0) + amount;
        userData.txCount       = (userData.txCount || 0) + 1;
        if (!Array.isArray(userData.history)) userData.history = [];
        userData.history.push(`[${date}] ‚Üê RIDCOIN: ${display} ($${usdValue}) üéÅ`);

        const updates = {};
        updates[`users/RIDCOIN`]     = ridData;
        updates[`users/${username}`] = userData;
        await db.ref().update(updates);

        users['RIDCOIN'] = ridData;
        users[username]  = userData;
        if (currentUser && users[currentUser]) {
            localStorage.setItem('ridcoin_current_user', JSON.stringify({username: currentUser, data: users[currentUser]}));
        }
    } catch (e) {
        hideLoading(); showErr('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ' + e.message); return;
    }

    hideLoading();
    hideAddBalanceModal();
    updateWalletDisplay();
    showToast(`‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω ${username} –Ω–∞ ${formatRid(amount)} RID`, 'success');
}

// ============================================================
// –í–´–•–û–î
// ============================================================
function logout() {
    if (!confirm('–í—ã–π—Ç–∏ –∏–∑ –∫–æ—à–µ–ª—å–∫–∞?')) return;
    if (userListener) { db.ref(`users/${currentUser}`).off('value', userListener); userListener = null; }
    if (dmUnreadListener) { db.ref('dmIndex/' + currentUser).off('value', dmUnreadListener); dmUnreadListener = null; }
    if (globalChatUnreadListener) { db.ref('globalChat').off('value', globalChatUnreadListener); globalChatUnreadListener = null; }
    localStorage.removeItem('ridcoin_current_user');
    currentUser = null; historyFilter='all'; historyPage=0;
    document.getElementById('wallet').style.display = 'none';
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('username').focus();
    updateUsersList();
}

// ============================================================
// –ö–û–ü–ò–†–û–í–ê–¢–¨ –ò–ú–Ø
// ============================================================
function copyUsername() {
    if (!currentUser) return;
    navigator.clipboard.writeText(currentUser)
        .then(() => showToast('–ò–º—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!','info'))
        .catch(() => showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å','error'));
}

// ============================================================
// –§–û–†–ú–ê–¢
// ============================================================
function formatRid(amount) {
    if (amount === 0) return '0';
    if (amount >= 1000) return amount.toLocaleString('ru-RU', {maximumFractionDigits:0});
    if (amount >= 1)    return amount.toLocaleString('ru-RU', {minimumFractionDigits:2,maximumFractionDigits:8});
    return amount.toFixed(8).replace(/\.?0+$/,'');
}

// ============================================================
// –ë–ï–ô–î–ñ–ò –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–•
// ============================================================
let dmUnreadListener = null;
let globalChatLastSeen = 0;
let globalChatUnreadListener = null;

function subscribeToUnread(username) {
    if (dmUnreadListener) db.ref('dmIndex/' + username).off('value', dmUnreadListener);
    dmUnreadListener = db.ref('dmIndex/' + username).on('value', snap => {
        const data = snap.val();
        let total = 0;
        if (data) Object.values(data).forEach(d => { total += (d.unread || 0); });
        updateDmBadge(total);
    });

    const seen = parseInt(localStorage.getItem('globalChat_seen_' + username) || '0');
    globalChatLastSeen = seen;
    if (globalChatUnreadListener) db.ref('globalChat').off('value', globalChatUnreadListener);
    globalChatUnreadListener = db.ref('globalChat').on('value', snap => {
        const data = snap.val();
        if (!data) return;
        const newMsgs = Object.values(data).filter(m => m.ts > globalChatLastSeen && m.from !== username).length;
        updateGlobalChatBadge(newMsgs);
    });
}

function updateDmBadge(count) {
    const badge = document.getElementById('dmUnreadBadge');
    if (!badge) return;
    if (count > 0) { badge.textContent = count > 99 ? '99+' : count; badge.style.display = 'inline-flex'; }
    else badge.style.display = 'none';
}
function updateGlobalChatBadge(count) {
    const badge = document.getElementById('globalChatBadge');
    if (!badge) return;
    if (count > 0) { badge.textContent = count > 99 ? '99+' : count; badge.style.display = 'inline-flex'; }
    else badge.style.display = 'none';
}

// ============================================================
// –û–ë–©–ò–ô –ß–ê–¢
// ============================================================
let globalChatListener = null;

function showGlobalChat() {
    document.getElementById('globalChatModal').style.display = 'flex';
    const container = document.getElementById('globalChatMessages');
    container.innerHTML = '<div style="text-align:center;color:#555;font-size:13px;margin:auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    globalChatLastSeen = Date.now();
    localStorage.setItem('globalChat_seen_' + currentUser, globalChatLastSeen);
    updateGlobalChatBadge(0);

    if (globalChatListener) db.ref('globalChat').off('value', globalChatListener);
    globalChatListener = db.ref('globalChat').limitToLast(100).on('value', snap => {
        container.innerHTML = '';
        const msgs = snap.val();
        if (!msgs) {
            container.innerHTML = '<div style="text-align:center;color:#555;font-size:13px;margin:auto;">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ë—É–¥—å –ø–µ—Ä–≤—ã–º! üëã</div>';
            return;
        }
        Object.entries(msgs).forEach(([key, msg]) => container.appendChild(renderChatMsg(msg, msg.from === currentUser, key)));
        container.scrollTop = container.scrollHeight;
    });
    setTimeout(() => document.getElementById('globalChatInput').focus(), 100);
}

function hideGlobalChat() {
    document.getElementById('globalChatModal').style.display = 'none';
    if (globalChatListener) { db.ref('globalChat').off('value', globalChatListener); globalChatListener = null; }
}

async function sendGlobalMessage() {
    const input = document.getElementById('globalChatInput');
    const text = input.value.trim();
    if (!text || !currentUser) return;
    input.value = '';
    await db.ref('globalChat').push({ from: currentUser, text, ts: Date.now() });
}

function renderChatMsg(msg, isMe, msgKey) {
    const isAdmin = currentUser === 'RIDCOIN' && users[currentUser] && users[currentUser].admin;
    const canDelete = (isAdmin || isMe) && msgKey;
    const div = document.createElement('div');
    div.style.cssText = `display:flex;flex-direction:column;align-items:${isMe?'flex-end':'flex-start'};`;
    const time = new Date(msg.ts).toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
    const date = new Date(msg.ts).toLocaleDateString('ru-RU', {day:'2-digit',month:'2-digit'});
    const deleteBtn = canDelete ? `<button onclick="deleteGlobalMessage('${msgKey}')" title="–£–¥–∞–ª–∏—Ç—å"
        style="width:auto;padding:2px 8px;margin:2px 0 0;font-size:11px;border-radius:6px;
        background:rgba(231,76,60,0.15);border:1px solid rgba(231,76,60,0.4);color:#e74c3c;
        text-transform:none;letter-spacing:0;cursor:pointer;">üóëÔ∏è</button>` : '';
    div.innerHTML = `
        ${!isMe ? `<div style="font-size:11px;color:var(--gold-primary);font-weight:700;margin-bottom:3px;padding-left:4px;">${escapeHtml(msg.from||'')}</div>` : ''}
        <div style="max-width:80%;padding:10px 14px;border-radius:${isMe?'16px 16px 4px 16px':'16px 16px 16px 4px'};
            background:${isMe?'linear-gradient(135deg,#B8860B,#F1C40F)':'rgba(255,255,255,0.07)'};
            color:${isMe?'#000':'var(--platinum)'};font-size:14px;word-break:break-word;line-height:1.5;">
            ${escapeHtml(msg.text)}
        </div>
        <div style="font-size:10px;color:#555;margin-top:3px;padding:0 4px;">${date} ${time}</div>
        ${deleteBtn}`;
    return div;
}

async function deleteGlobalMessage(msgKey) {
    if (!msgKey) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
    try {
        await db.ref('globalChat/' + msgKey).remove();
        showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
    } catch(e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
    }
}

// ============================================================
// –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø
// ============================================================
let dmChatPartner = null;
let dmChatListener = null;

function getDMKey(a, b) { return [a, b].sort().join('__'); }

function showDMList() {
    document.getElementById('dmListModal').style.display = 'flex';
    loadDMConversations();
}
function hideDMList() { document.getElementById('dmListModal').style.display = 'none'; }

async function loadDMConversations() {
    const container = document.getElementById('dmConversationsList');
    container.innerHTML = '<div style="text-align:center;color:#555;font-size:13px;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    const snap = await db.ref('dmIndex/' + currentUser).once('value');
    const data = snap.val();
    if (!data) { container.innerHTML = '<div style="text-align:center;color:#555;font-size:13px;padding:20px;">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>'; return; }
    container.innerHTML = '';
    const partners = Object.keys(data).sort((a,b) => (data[b].lastTs||0) - (data[a].lastTs||0));
    partners.forEach(partner => {
        const info = data[partner];
        const div = document.createElement('div');
        div.className = 'user-item';
        div.style.cursor = 'pointer';
        div.onclick = () => { hideDMList(); openDMChat(partner); };
        const unread = info.unread ? `<span style="background:#e74c3c;color:#fff;border-radius:10px;padding:2px 8px;font-size:11px;font-weight:700;">${info.unread}</span>` : '';
        const lastMsg = info.lastMsg ? `<div style="font-size:12px;color:#777;margin-top:3px;">${escapeHtml(info.lastMsg.slice(0,40))}${info.lastMsg.length>40?'...':''}</div>` : '';
        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px;width:100%;">
                <div style="width:38px;height:38px;border-radius:50%;background:${getAvatarColor(partner)};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;flex-shrink:0;">${partner[0].toUpperCase()}</div>
                <div style="flex:1;">
                    <div style="font-weight:700;font-size:15px;">${escapeHtml(partner)} ${unread}</div>
                    ${lastMsg}
                </div>
            </div>`;
        container.appendChild(div);
    });
}

function onDmSearchInput(val) {
    const list = document.getElementById('dmAutocompleteList');
    document.getElementById('dmSearchInput')._selected = '';
    if (!val.trim()) { list.style.display = 'none'; return; }
    const matches = Object.keys(users).filter(u => u !== currentUser && u.toLowerCase().includes(val.toLowerCase())).slice(0,6);
    if (!matches.length) { list.style.display = 'none'; return; }
    list.innerHTML = '';
    matches.forEach(u => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = `<div class="ac-avatar" style="background:${getAvatarColor(u)};color:#fff;">${escapeHtml(u[0].toUpperCase())}</div>${escapeHtml(u)}`;
        item.onmousedown = () => {
            document.getElementById('dmSearchInput').value = u;
            document.getElementById('dmSearchInput')._selected = u;
            list.style.display = 'none';
        };
        list.appendChild(item);
    });
    list.style.display = 'block';
}
function hideDmAutocomplete() { document.getElementById('dmAutocompleteList').style.display = 'none'; }

function openDMFromSearch() {
    const input = document.getElementById('dmSearchInput');
    const partner = (input._selected || input.value).trim();
    if (!partner || !users[partner] || partner === currentUser) { showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error'); return; }
    hideDMList();
    openDMChat(partner);
}

function openDMChat(partner) {
    dmChatPartner = partner;
    document.getElementById('dmChatTitle').textContent = 'üí¨ ' + partner;
    document.getElementById('dmChatModal').style.display = 'flex';
    const container = document.getElementById('dmChatMessages');
    container.innerHTML = '<div style="text-align:center;color:#555;font-size:13px;margin:auto;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

    if (dmChatListener) db.ref('dm/' + getDMKey(currentUser, partner)).off('value', dmChatListener);
    db.ref('dmIndex/' + currentUser + '/' + partner + '/unread').set(0);

    dmChatListener = db.ref('dm/' + getDMKey(currentUser, partner)).limitToLast(100).on('value', snap => {
        container.innerHTML = '';
        const msgs = snap.val();
        if (!msgs) {
            container.innerHTML = '<div style="text-align:center;color:#555;font-size:13px;margin:auto;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ! üëã</div>';
            return;
        }
        Object.values(msgs).forEach(msg => container.appendChild(renderChatMsg(msg, msg.from === currentUser)));
        container.scrollTop = container.scrollHeight;
    });
    setTimeout(() => document.getElementById('dmChatInput').focus(), 100);
}

function hideDMChat() {
    document.getElementById('dmChatModal').style.display = 'none';
    if (dmChatListener) { db.ref('dm/' + getDMKey(currentUser, dmChatPartner)).off('value', dmChatListener); dmChatListener = null; }
    dmChatPartner = null;
}

async function sendDMMessage() {
    const input = document.getElementById('dmChatInput');
    const text = input.value.trim();
    if (!text || !currentUser || !dmChatPartner) return;
    input.value = '';
    const msg = { from: currentUser, text, ts: Date.now() };
    const key = getDMKey(currentUser, dmChatPartner);
    await db.ref('dm/' + key).push(msg);
    const preview = { lastMsg: text, lastTs: msg.ts, unread: 0 };
    await db.ref('dmIndex/' + currentUser + '/' + dmChatPartner).update(preview);
    const recipSnap = await db.ref('dmIndex/' + dmChatPartner + '/' + currentUser + '/unread').once('value');
    const curUnread = recipSnap.val() || 0;
    await db.ref('dmIndex/' + dmChatPartner + '/' + currentUser).update({ lastMsg: text, lastTs: msg.ts, unread: curUnread + 1 });
}

// ============================================================
// –ö–õ–ê–í–ò–ê–¢–£–†–ê
// ============================================================
document.getElementById('username').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('password').focus(); });
document.getElementById('password').addEventListener('keypress', e => { if(e.key==='Enter') login(); });
document.getElementById('reg-username').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('reg-password').focus(); });
document.getElementById('reg-password').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('reg-confirm').focus(); });
document.getElementById('reg-confirm').addEventListener('keypress', e => { if(e.key==='Enter') createAccount(); });
document.getElementById('recovery-username').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('recovery-phrase-input').focus(); });

// ============================================================
// –°–¢–ê–†–¢
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    updateHeaderPrice();
    setInterval(updateHeaderPrice, 60000);
    document.getElementById('username').focus();

    db.ref('.info/connected').on('value', snap => {
        setFirebaseConnected(snap.val() === true);
    });

    showLoading('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...');
    auth.onAuthStateChanged(user => {
        if (user) {
            loadAllUsers().then(() => {
                subscribeToUsersCount();
                subscribeToAirdropFund();
            });
        }
    });

    auth.signInAnonymously().catch(e => {
        console.error('Firebase auth error:', e);
        loadAllUsers().then(() => {
            subscribeToUsersCount();
            subscribeToAirdropFund();
        });
    });
});
</script>
</body>
</html>
