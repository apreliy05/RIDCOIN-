<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíé RIDCOIN ‚Äî –ö–æ—à–µ–ª—ë–∫</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold-primary: #F1C40F;
            --gold-dark: #B8860B;
            --gold-light: #FFD700;
            --gold-gradient: linear-gradient(135deg, #F1C40F, #B8860B);
            --black-velvet: #0a0a0a;
            --black-charcoal: #1a1a1a;
            --black-matte: #222222;
            --emerald: #009966;
            --ruby: #8B0000;
            --silver: #C0C0C0;
            --platinum: #E5E4E2;
            --shadow-gold: 0 0 20px rgba(241, 196, 15, 0.3);
            --glow-gold: 0 0 15px rgba(241, 196, 15, 0.5);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:
                radial-gradient(circle at 20% 50%, rgba(241,196,15,0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(184,134,11,0.03) 0%, transparent 50%),
                var(--black-velvet);
            color: var(--platinum);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%; width: 100%; padding: 20px;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
        }

        .card {
            background: var(--black-charcoal); padding: 30px; border-radius: 20px;
            margin: 20px 0; border: 2px solid var(--gold-dark); box-shadow: var(--shadow-gold);
            width: 100%; max-width: 600px; transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--gold-gradient); }
        .card:hover { transform:translateY(-5px); box-shadow:0 15px 35px rgba(241,196,15,0.2); border-color:var(--gold-primary); }

        .header { text-align:center; margin-bottom:30px; padding:20px; background:rgba(0,0,0,0.5); border-radius:20px; border:1px solid var(--gold-dark); position:relative; }
        .header::after { content:'üíé'; position:absolute; top:-15px; right:-15px; font-size:40px; color:var(--gold-light); text-shadow:var(--glow-gold); }

        .logo { font-size:52px; margin-bottom:15px; background:var(--gold-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:900; letter-spacing:2px; }

        .big {
            font-size:56px; font-weight:900; color:var(--gold-primary); text-align:center;
            margin:30px 0; text-shadow:var(--glow-gold); letter-spacing:1px; transition:all 0.4s ease;
        }
        .big.flash { animation: balanceFlash 0.6s ease; }
        @keyframes balanceFlash {
            0%   { transform:scale(1);    color:var(--gold-primary); }
            30%  { transform:scale(1.12); color:#fff; text-shadow:0 0 30px #F1C40F; }
            100% { transform:scale(1);    color:var(--gold-primary); }
        }

        .price { font-size:22px; color:var(--gold-light); text-align:center; margin:25px 0; line-height:1.6; background:rgba(241,196,15,0.1); padding:20px; border-radius:15px; border-left:4px solid var(--gold-primary); border-right:4px solid var(--gold-primary); }

        input, button, select, textarea { width:100%; padding:20px; margin:15px 0; border-radius:12px; font-size:18px; border:none; outline:none; transition:all 0.3s; font-weight:600; }
        input, textarea { background:var(--black-matte); border:2px solid rgba(241,196,15,0.3); color:var(--platinum); }
        input:focus, textarea:focus { border-color:var(--gold-primary); box-shadow:var(--shadow-gold); background:rgba(241,196,15,0.05); }
        input::placeholder, textarea::placeholder { color:rgba(192,192,192,0.6); }

        button { background:var(--gold-gradient); color:#000; font-weight:900; cursor:pointer; letter-spacing:1px; text-transform:uppercase; position:relative; overflow:hidden; border:2px solid var(--gold-dark); }
        button::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent); transition:0.5s; }
        button:hover { transform:translateY(-3px); box-shadow:0 10px 25px rgba(241,196,15,0.4); }
        button:hover::before { left:100%; }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history { font-size:15px; color:var(--silver); margin-top:20px; max-height:300px; overflow-y:auto; padding:15px; background:var(--black-matte); border-radius:12px; border:1px solid rgba(241,196,15,0.2); }
        .history-item { padding:10px 12px; margin:6px 0; border-radius:8px; background:rgba(255,255,255,0.03); border-left:3px solid transparent; transition:all 0.2s; }
        .history-item:hover { background:rgba(241,196,15,0.07); }
        .history-item.in  { border-left-color:#2ecc71; }
        .history-item.out { border-left-color:#e74c3c; }
        .history-item.system { border-left-color:var(--gold-dark); }
        .history-item .hi-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .history-item .hi-type { font-weight:700; font-size:13px; text-transform:uppercase; letter-spacing:1px; }
        .history-item .hi-type.in  { color:#2ecc71; }
        .history-item .hi-type.out { color:#e74c3c; }
        .history-item .hi-type.system { color:var(--gold-primary); }
        .history-item .hi-amount { font-weight:700; color:var(--gold-light); font-size:15px; }
        .history-item .hi-meta { font-size:12px; color:#777; }
        .history-item .hi-comment { font-size:13px; color:#aaa; margin-top:4px; font-style:italic; }

        .history-filters { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
        .filter-btn { flex:1; min-width:80px; padding:8px 12px; margin:0; font-size:12px; border-radius:8px; background:var(--black-matte); color:var(--silver); border:1px solid rgba(241,196,15,0.2); }
        .filter-btn.active { background:var(--gold-gradient); color:#000; border-color:var(--gold-primary); }

        .history-pagination { display:flex; justify-content:center; align-items:center; gap:10px; margin-top:10px; }
        .page-btn { width:auto; padding:8px 16px; margin:0; font-size:13px; border-radius:8px; }
        .page-info { color:var(--silver); font-size:13px; }

        h2, h3, h4 { color:var(--gold-primary); text-align:center; margin-top:0; font-weight:700; letter-spacing:1px; }
        h2 { font-size:32px; margin-bottom:20px; }
        h3 { font-size:26px; margin:25px 0 15px 0; }

        .usd-value { font-size:24px; color:var(--gold-light); text-align:center; margin:20px 0; font-weight:700; }
        .small-note { font-size:14px; color:var(--silver); margin:8px 0; text-align:center; font-style:italic; }

        .error { color:var(--ruby); font-size:16px; margin:10px 0; padding:12px; background:rgba(139,0,0,0.1); border-radius:8px; border-left:4px solid var(--ruby); display:none; font-weight:600; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:15px 0; }
        .stat-box { background:var(--black-matte); border-radius:12px; padding:14px; text-align:center; border:1px solid rgba(241,196,15,0.15); }
        .stat-box .stat-val { font-size:20px; font-weight:900; color:var(--gold-primary); }
        .stat-box .stat-label { font-size:12px; color:var(--silver); margin-top:4px; }

        /* –ê–≤–∞—Ç–∞—Ä */
        .profile-avatar { width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:900; color:#fff; margin:0 auto 10px; border:3px solid var(--gold-primary); box-shadow:var(--shadow-gold); }

        .user-list { margin:20px 0; }
        .user-item { padding:15px; margin:10px 0; background:var(--black-matte); border-radius:12px; border-left:4px solid var(--gold-dark); transition:all 0.3s; display:flex; justify-content:space-between; align-items:center; }
        .user-item:hover { transform:translateX(10px); border-left-color:var(--gold-primary); background:rgba(241,196,15,0.05); }
        .admin-badge { background:var(--gold-gradient); color:#000; padding:6px 16px; border-radius:20px; font-size:14px; font-weight:900; text-transform:uppercase; letter-spacing:1px; box-shadow:0 3px 10px rgba(241,196,15,0.3); }
        .zero-balance { color:var(--ruby); font-weight:700; }
        .action-buttons { margin-top:30px; padding-top:25px; border-top:2px solid rgba(241,196,15,0.3); }
        .user-item-admin { border-left:4px solid var(--gold-primary); background:rgba(241,196,15,0.1); position:relative; }
        .user-item-admin::before { content:'üëë'; position:absolute; left:-25px; font-size:20px; color:var(--gold-light); }
        .balance-display { font-size:20px; font-weight:700; color:var(--gold-light); }
        .crown-icon { color:var(--gold-light); text-shadow:var(--glow-gold); }

        /* –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ */
        .autocomplete-wrap { position:relative; }
        .autocomplete-list { position:absolute; top:100%; left:0; right:0; background:#1e1e1e; border:1px solid var(--gold-dark); border-radius:0 0 10px 10px; z-index:100; max-height:200px; overflow-y:auto; }
        .autocomplete-item { padding:12px 16px; cursor:pointer; font-size:15px; display:flex; align-items:center; gap:10px; border-bottom:1px solid rgba(255,255,255,0.05); }
        .autocomplete-item:hover { background:rgba(241,196,15,0.1); color:var(--gold-primary); }
        .ac-avatar { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(10,10,10,0.95); z-index:1000; justify-content:center; align-items:center; padding:20px; backdrop-filter:blur(5px); }
        .modal-content { background:var(--black-charcoal); padding:30px; border-radius:20px; border:2px solid var(--gold-primary); max-width:500px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 50px rgba(0,0,0,0.8); animation:modalAppear 0.3s ease-out; }
        @keyframes modalAppear { from{opacity:0;transform:scale(0.9) translateY(-20px);} to{opacity:1;transform:scale(1) translateY(0);} }

        /* –¢–æ—Å—Ç—ã */
        #toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; pointer-events:none; }
        .toast { background:#1e1e1e; border-radius:12px; padding:14px 20px; min-width:260px; max-width:340px; font-size:15px; font-weight:600; border-left:4px solid var(--gold-primary); box-shadow:0 8px 24px rgba(0,0,0,0.6); animation:toastIn 0.35s ease, toastOut 0.35s ease 3.15s forwards; pointer-events:all; display:flex; align-items:center; gap:10px; }
        .toast.success { border-left-color:#2ecc71; }
        .toast.error   { border-left-color:#e74c3c; }
        .toast.info    { border-left-color:var(--gold-primary); }
        @keyframes toastIn  { from{opacity:0;transform:translateX(60px);} to{opacity:1;transform:translateX(0);} }
        @keyframes toastOut { from{opacity:1;} to{opacity:0;transform:translateX(60px);} }

        @keyframes pulseGold { 0%{box-shadow:0 0 0 0 rgba(241,196,15,0.4);} 70%{box-shadow:0 0 0 10px rgba(241,196,15,0);} 100%{box-shadow:0 0 0 0 rgba(241,196,15,0);} }
        .pulse { animation:pulseGold 2s infinite; }

        ::-webkit-scrollbar { width:8px; }
        ::-webkit-scrollbar-track { background:var(--black-matte); border-radius:4px; }
        ::-webkit-scrollbar-thumb { background:var(--gold-gradient); border-radius:4px; }

        @media(max-width:768px) { .container{padding:15px;} .card{padding:25px;} .big{font-size:44px;} .logo{font-size:42px;} input,button{padding:18px;font-size:16px;} }
        @media(max-width:480px) { .card{padding:20px;margin:15px 0;} .big{font-size:36px;} h2{font-size:28px;} .price{font-size:18px;padding:15px;} .logo{font-size:36px;} }

        .wealth-indicator { height:5px; background:var(--gold-gradient); border-radius:3px; margin:10px 0; }

        /* –†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å –±–ª–æ–∫—á–µ–π–Ω–∞ */
        .chain-balance-block {
            background: rgba(130,71,229,0.1); border: 1px solid rgba(130,71,229,0.35);
            border-radius: 14px; padding: 16px 20px; margin: 10px 0; text-align: center;
        }
        .chain-balance-block .cb-label { font-size: 12px; color: var(--silver); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .chain-balance-block .cb-value { font-size: 26px; font-weight: 900; color: #a97ff5; }
        .chain-balance-block .cb-sub { font-size: 12px; color: #777; margin-top: 4px; }
        .chain-balance-block .cb-refresh { background: none; border: 1px solid rgba(130,71,229,0.4); color: #a97ff5; font-size: 12px; padding: 6px 14px; margin: 8px 0 0; width: auto; text-transform: none; letter-spacing: 0; border-radius: 8px; cursor: pointer; }
        .chain-balance-block .cb-refresh:hover { background: rgba(130,71,229,0.2); transform: none; box-shadow: none; }
        .gold-text { color:var(--gold-primary); font-weight:700; }
        .diamond { color:var(--gold-light); text-shadow:0 0 10px rgba(255,215,0,0.5); }

        .recovery-section { margin-top:30px; padding:20px; background:rgba(46,204,113,0.1); border-radius:12px; border:2px solid rgba(46,204,113,0.3); }
        .recovery-textarea { width:100%; padding:15px; background:var(--black-matte); border:2px solid rgba(46,204,113,0.5); border-radius:10px; color:var(--platinum); font-size:16px; resize:none; font-family:'Courier New',monospace; margin:10px 0; }
        .phrase-display { font-family:'Courier New',monospace; font-size:16px; line-height:1.6; padding:15px; background:rgba(0,0,0,0.3); border-radius:8px; margin:10px 0; border-left:4px solid var(--emerald); word-break:break-all; }
        .phrase-word { display:inline-block; background:rgba(46,204,113,0.2); padding:4px 10px; margin:3px; border-radius:6px; border:1px solid rgba(46,204,113,0.3); }
        .warning-box { background:rgba(241,196,15,0.1); border:2px solid rgba(241,196,15,0.3); border-radius:10px; padding:15px; margin:15px 0; }
        .warning-icon { color:#f39c12; font-weight:bold; }
        .generate-btn { background:linear-gradient(135deg,#2ecc71,#27ae60)!important; border:2px solid #27ae60!important; margin:10px 0; }
        .recovery-btn { background:linear-gradient(135deg,#e74c3c,#c0392b)!important; border:2px solid #c0392b!important; margin:10px 0; }
        .copy-btn { background:linear-gradient(135deg,#3498db,#2980b9)!important; border:2px solid #2980b9!important; padding:12px!important; font-size:14px!important; margin:5px 0; }
        .purple-btn { background:linear-gradient(135deg,#9b59b6,#8e44ad)!important; border:2px solid #8e44ad!important; }
        .blue-btn { background:linear-gradient(135deg,#3498db,#2980b9)!important; border:2px solid #2980b9!important; }
        .tg-btn { background:linear-gradient(135deg,#0088cc,#006ba6)!important; border:2px solid #006ba6!important; }
        .share-btn { background:linear-gradient(135deg,#27ae60,#1e8449)!important; border:2px solid #1e8449!important; }

        .forgot-password { text-align:center; margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); }
        .forgot-password a { color:var(--gold-primary); text-decoration:none; font-weight:600; font-size:14px; }
        .forgot-password a:hover { text-decoration:underline; }
        .form-actions { display:flex; gap:10px; margin-top:20px; }
        .form-actions button { flex:1; }

        /* –°–∏–ª–∞ –ø–∞—Ä–æ–ª—è */
        .password-strength { height:4px; border-radius:2px; margin:-10px 0 10px; transition:all 0.3s; background:#333; }
        .password-strength.weak   { background:#e74c3c; width:33%; }
        .password-strength.medium { background:#f39c12; width:66%; }
        .password-strength.strong { background:#2ecc71; width:100%; }
        .strength-label { font-size:12px; text-align:right; margin:-8px 0 10px; }
        .strength-label.weak   { color:#e74c3c; }
        .strength-label.medium { color:#f39c12; }
        .strength-label.strong { color:#2ecc71; }

        /* –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–º—è */
        .username-copy-btn { display:inline-block; background:none; border:none; padding:2px 6px; font-size:14px; cursor:pointer; opacity:0.6; width:auto; margin:0; vertical-align:middle; transform:none!important; box-shadow:none!important; }
        .username-copy-btn:hover { opacity:1; }

        /* –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞ */
        .confirm-details { background:var(--black-matte); border-radius:12px; padding:20px; margin:15px 0; border:1px solid rgba(241,196,15,0.3); }
        .confirm-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05); }
        .confirm-row:last-child { border-bottom:none; }
        .confirm-row .label { color:var(--silver); font-size:14px; }
        .confirm-row .value { font-weight:700; color:var(--gold-light); }

        /* –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è */
        .change-password-section { margin-top:20px; padding:20px; background:rgba(52,152,219,0.07); border-radius:12px; border:2px solid rgba(52,152,219,0.2); }

        /* –°—á—ë—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .users-counter {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: rgba(241,196,15,0.08); border: 1px solid rgba(241,196,15,0.2);
            border-radius: 12px; padding: 12px 20px; margin: 15px 0;
        }
        .users-counter .uc-num { font-size: 22px; font-weight: 900; color: var(--gold-primary); }
        .users-counter .uc-label { font-size: 13px; color: var(--silver); }

        /* –ì—Ä–∞—Ñ–∏–∫ –∫—É—Ä—Å–∞ */
        .chart-wrap { background: var(--black-matte); border-radius: 14px; padding: 16px; margin: 20px 0; border: 1px solid rgba(241,196,15,0.15); }
        .chart-title { font-size: 13px; color: var(--silver); text-align: center; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        #ridChart { width: 100%; height: 120px; display: block; }

        /* –û –ø—Ä–æ–µ–∫—Ç–µ */
        .about-section { background: var(--black-matte); border-radius: 14px; padding: 20px; margin: 20px 0; border: 1px solid rgba(241,196,15,0.15); }
        .about-row { display: flex; align-items: flex-start; gap: 12px; margin: 12px 0; }
        .about-icon { font-size: 22px; flex-shrink: 0; margin-top: 2px; }
        .about-text { font-size: 14px; color: var(--silver); line-height: 1.6; }
        .about-text strong { color: var(--gold-light); }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —á–∞—Å—Ç–∏—Ü –ø—Ä–∏ –≤—Ö–æ–¥–µ */
        #particles-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; opacity: 0; transition: opacity 0.3s; }
        #particles-canvas.active { opacity: 1; }

        /* ===== FIREBASE: Phone Verification ===== */
        .phone-section {
            background: rgba(0,136,204,0.08); border: 1px solid rgba(0,136,204,0.3);
            border-radius: 14px; padding: 20px; margin: 15px 0;
        }
        .phone-section h4 { color: #0088cc; margin-bottom: 12px; }
        .phone-flag { font-size: 18px; margin-right: 6px; }
        #recaptcha-container { margin: 10px 0; }
        .phone-step { display: none; }
        .phone-step.active { display: block; }

        /* Firebase —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
        .firebase-badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3);
            border-radius: 20px; padding: 4px 12px; font-size: 12px; color: #ffc107;
            margin: 8px auto; text-align: center;
        }
        .firebase-badge .dot { width:8px; height:8px; border-radius:50%; background:#ffc107; animation: blink 1.5s infinite; }
        .firebase-badge.connected .dot { background:#2ecc71; }
        .firebase-badge.connected { color:#2ecc71; border-color:rgba(46,204,113,0.3); background:rgba(46,204,113,0.08); }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(10,10,10,0.85); z-index:9998; justify-content:center; align-items:center; flex-direction:column; gap:20px; }
        .loading-overlay.show { display:flex; }
        .spinner { width:50px; height:50px; border:4px solid rgba(241,196,15,0.2); border-top-color:var(--gold-primary); border-radius:50%; animation:spin 0.8s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg);} }
        .loading-text { color:var(--gold-light); font-size:16px; font-weight:600; }
    </style>
</head>
<body>

<canvas id="particles-canvas"></canvas>
<div id="toast-container"></div>

<!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</div>
</div>

<div class="container">

    <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
    <div class="card header">
        <h1 class="logo">üíé RIDCOIN</h1>
        <div class="price" id="headerPrice">
            <div class="gold-text" id="headerPriceValue">1 RID = ... USD</div>
            <div id="headerDate"></div>
        </div>
        <!-- Firebase —Å—Ç–∞—Ç—É—Å -->
        <div style="text-align:center;">
            <span class="firebase-badge" id="firebaseBadge">
                <span class="dot"></span>
                <span id="firebaseStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </span>
        </div>
        <!-- –°—á—ë—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="users-counter">
            <span class="uc-num" id="totalUsersCount">0</span>
            <span class="uc-label">üë• —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ</span>
        </div>
        <div class="wealth-indicator"></div>
    </div>

    <div id="walletMode" style="width:100%;display:block;">

        <!-- –í–•–û–î -->
        <div class="card" id="loginSection">
            <h3>üëë –í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h3>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off">
            <button onclick="login()" class="pulse">üîë –í–æ–π—Ç–∏</button>
            <div class="forgot-password">
                <a href="javascript:void(0)" onclick="showRecoveryModal()">üîì –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
            </div>
            <div style="text-align:center;margin-top:20px;color:var(--silver);">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</div>
            <button onclick="showRegisterModal()" class="purple-btn">‚ú® –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>

            <!-- –û –ø—Ä–æ–µ–∫—Ç–µ -->
            <div style="margin-top:30px;">
                <h4 style="margin-bottom:5px;">üìñ –û –ø—Ä–æ–µ–∫—Ç–µ</h4>
                <div class="about-section">
                    <div class="about-row">
                        <span class="about-icon">üíé</span>
                        <div class="about-text"><strong>RIDCOIN</strong> ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ü–∏—Ñ—Ä–æ–≤–∞—è –º–æ–Ω–µ—Ç–∞ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã RidcoinEcoSystem.</div>
                    </div>
                    <div class="about-row">
                        <span class="about-icon">üìà</span>
                        <div class="about-text">–ö—É—Ä—Å –º–æ–Ω–µ—Ç—ã <strong>—Ä–∞—Å—Ç—ë—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</strong> ‚Äî —á–µ–º —Ä–∞–Ω—å—à–µ –≤—Å—Ç—É–ø–∏—à—å, —Ç–µ–º –≤—ã–≥–æ–¥–Ω–µ–µ.</div>
                    </div>
                    <div class="about-row">
                        <span class="about-icon">üéÅ</span>
                        <div class="about-text">–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–∞—à <strong>Telegram-–∫–∞–Ω–∞–ª</strong> –∏ –ø–æ–ª—É—á–∏ <strong>1 RID</strong> –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.</div>
                    </div>
                    <div class="about-row">
                        <span class="about-icon">üîí</span>
                        <div class="about-text">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ —Å <strong>SHA-256</strong> –∑–∞—â–∏—Ç–æ–π –∏ —Ñ—Ä–∞–∑–æ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.</div>
                    </div>
                    <div class="about-row">
                        <span class="about-icon">üî•</span>
                        <div class="about-text">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ <strong>Firebase Realtime Database</strong> ‚Äî –∫–æ—à–µ–ª—ë–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</div>
                    </div>
                    <button onclick="window.open('https://t.me/RidcoinEcoSystem','_blank')" class="tg-btn" style="margin-top:10px;font-size:15px;padding:14px;">
                        ‚úàÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –≤ Telegram-–∫–∞–Ω–∞–ª
                    </button>
                    <button onclick="window.open('https://polygonscan.com/address/0xa09073eFC2aaf713799A04c21440199783713972','_blank')" style="background:linear-gradient(135deg,#8247e5,#6a35c2);border:2px solid #6a35c2;margin-top:8px;font-size:15px;padding:14px;">
                        üî∑ –°–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ Polygon
                    </button>
                </div>
            </div>

            <div class="user-list" id="userList" style="display:none;">
                <h4>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã:</h4>
                <div id="usersContainer"></div>
            </div>
        </div>

        <!-- –ö–û–®–ï–õ–Å–ö -->
        <div class="card" id="wallet" style="display:none;">
            <div class="profile-avatar" id="profileAvatar">?</div>
            <h3 style="margin-top:0;">üí∞ –ö–æ—à–µ–ª—ë–∫</h3>
            <p style="text-align:center;">
                <strong id="userName" class="gold-text"></strong>
                <button class="username-copy-btn" onclick="copyUsername()" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–º—è">üìã</button>
                <span id="userBadge" class="admin-badge" style="margin-left:8px;"></span>
            </p>
            <p class="small-note" id="lastLoginNote" style="margin-top:4px;"></p>

            <div class="big" id="balance">0 RID</div>
            <div class="usd-value" id="usdBalance">‚âà 0 USD</div>

            <!-- –†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å –±–ª–æ–∫—á–µ–π–Ω–∞ -->
            <div class="chain-balance-block">
                <div class="cb-label">üîó –†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ Polygon</div>
                <div class="cb-value" id="chainBalance">‚Äî</div>
                <div class="cb-sub" id="chainBalanceSub">–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                <button class="cb-refresh" onclick="loadChainBalance()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –∫—É—Ä—Å–∞ -->
            <div class="chart-wrap">
                <div class="chart-title">üìà –†–æ—Å—Ç –∫—É—Ä—Å–∞ RID –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
                <canvas id="ridChart"></canvas>
            </div>

            <div class="stats-grid">
                <div class="stat-box"><div class="stat-val" id="statTxCount">0</div><div class="stat-label">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div></div>
                <div class="stat-box"><div class="stat-val" id="statVolume">0</div><div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ RID</div></div>
                <div class="stat-box"><div class="stat-val" id="statReceived">0</div><div class="stat-label">–ü–æ–ª—É—á–µ–Ω–æ RID</div></div>
                <div class="stat-box"><div class="stat-val" id="statDaysActive">0</div><div class="stat-label">–î–Ω–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</div></div>
            </div>

            <h3 style="margin-top:30px;">üè¶ –ü–µ—Ä–µ–≤–æ–¥</h3>
            <div class="autocomplete-wrap">
                <input type="text" id="to" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è" autocomplete="off" oninput="onRecipientInput(this.value)" onblur="hideAutocomplete()">
                <div class="autocomplete-list" id="autocompleteList" style="display:none;"></div>
            </div>
            <input type="number" id="amount" placeholder="–°—É–º–º–∞ –≤ RID" step="0.00000001" min="0.00000001" autocomplete="off">
            <input type="text" id="transferComment" placeholder="üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" autocomplete="off" style="font-size:15px;padding:14px 20px;">
            <div class="small-note">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 0.00000001 RID (1 —Å–∞—Ç–æ—à–∏)</div>
            <div class="error" id="amountError"></div>
            <button onclick="initiateSend()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>

            <h3 style="margin-top:30px;">üìú –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <div class="history-filters">
                <button class="filter-btn active" onclick="setHistoryFilter('all',this)">–í—Å–µ</button>
                <button class="filter-btn" onclick="setHistoryFilter('in',this)">–í—Ö–æ–¥—è—â–∏–µ</button>
                <button class="filter-btn" onclick="setHistoryFilter('out',this)">–ò—Å—Ö–æ–¥—è—â–∏–µ</button>
            </div>
            <div id="history" class="history"></div>
            <div class="history-pagination" id="historyPagination" style="display:none;">
                <button class="page-btn" onclick="historyPagePrev()">‚Üê –ù–∞–∑–∞–¥</button>
                <span class="page-info" id="pageInfo"></span>
                <button class="page-btn" onclick="historyPageNext()">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
            </div>

            <div class="action-buttons">
                <button onclick="showAllUsers()" class="blue-btn" style="margin-bottom:15px;">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button onclick="showProfileModal()" class="purple-btn" style="margin-bottom:15px;">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å –∏ —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</button>
                <button onclick="window.open('https://t.me/RidcoinEcoSystem','_blank')" class="tg-btn" style="margin-bottom:15px;">‚úàÔ∏è –ù–∞—à Telegram-–∫–∞–Ω–∞–ª</button>
                <button onclick="window.open('https://polygonscan.com/address/0xa09073eFC2aaf713799A04c21440199783713972','_blank')" style="background:linear-gradient(135deg,#8247e5,#6a35c2);border:2px solid #6a35c2;margin-bottom:15px;">üî∑ –ö–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ Polygon</button>
                <button onclick="logout()" style="background:linear-gradient(135deg,var(--ruby),#6a0000);">üö™ –í—ã–π—Ç–∏</button>
            </div>

            <!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è RIDCOIN -->
            <div id="adminPanel" style="display:none; margin-top:20px; padding:20px; background:rgba(231,76,60,0.08); border-radius:16px; border:2px solid rgba(231,76,60,0.3);">
                <h4 style="color:#e74c3c; margin-bottom:15px;">‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
                <button onclick="resetAllData()" style="background:linear-gradient(135deg,#e74c3c,#c0392b); border-color:#c0392b; margin-bottom:10px;">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                </button>
                <button onclick="showAllUsersAdmin()" style="background:linear-gradient(135deg,#e67e22,#d35400); border-color:#d35400; margin-bottom:10px;">
                    üëÅÔ∏è –í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã (—Å –±–∞–ª–∞–Ω—Å–∞–º–∏)
                </button>
                <button onclick="addBalanceModal()" style="background:linear-gradient(135deg,#27ae60,#1e8449); border-color:#1e8449;">
                    üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </button>
            </div>

            <div class="wealth-indicator" style="margin-top:30px;"></div>
        </div>
    </div>

    <!-- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ -->
    <div id="addBalanceModal" class="modal-overlay">
        <div class="modal-content">
            <h3>üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h3>
            <input type="text" id="ab-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <input type="number" id="ab-amount" placeholder="–°—É–º–º–∞ –≤ RID" step="0.00000001" min="0.00000001">
            <div class="error" id="abError"></div>
            <div class="form-actions">
                <button onclick="confirmAddBalance()" style="background:linear-gradient(135deg,#27ae60,#1e8449);">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                <button onclick="hideAddBalanceModal()" style="background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div id="usersModal" class="modal-overlay">
        <div class="modal-content">
            <h3><span class="diamond">üëë</span> –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã</h3>
            <div id="allUsersList"></div>
            <button onclick="hideUsersModal()" style="margin-top:20px;width:100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <h3><span class="diamond">‚ú®</span> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input type="text" id="reg-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" autocomplete="off" oninput="checkPasswordStrength(this.value)">
            <div class="password-strength" id="pwStrengthBar"></div>
            <div class="strength-label" id="pwStrengthLabel"></div>
            <input type="password" id="reg-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="off">

            <!-- Phone Verification Block -->
            <div class="phone-section">
                <h4>üì± –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h4>
                <p style="font-size:13px;color:var(--silver);margin-bottom:12px;">–ü—Ä–∏–≤—è–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞</p>

                <!-- –®–∞–≥ 1: –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ -->
                <div class="phone-step active" id="phoneStep1">
                    <input type="tel" id="reg-phone" placeholder="+7 999 123 45 67" style="font-size:16px;padding:14px 20px;" autocomplete="tel">
                    <div id="recaptcha-container"></div>
                    <button onclick="sendPhoneCode()" style="background:linear-gradient(135deg,#0088cc,#006ba6);border-color:#006ba6;font-size:15px;padding:14px;">
                        üì≤ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
                    </button>
                    <p style="font-size:12px;color:#777;text-align:center;margin-top:8px;">
                        –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
                    </p>
                    <button onclick="skipPhoneVerification()" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--silver);font-size:13px;padding:10px;margin-top:0;">
                        –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å ‚Üí
                    </button>
                </div>

                <!-- –®–∞–≥ 2: –≤–≤–æ–¥ –∫–æ–¥–∞ -->
                <div class="phone-step" id="phoneStep2">
                    <p style="font-size:14px;color:#2ecc71;margin-bottom:10px;">‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ <span id="phoneSentTo"></span></p>
                    <input type="text" id="reg-sms-code" placeholder="–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" maxlength="6" style="font-size:20px;text-align:center;letter-spacing:8px;padding:14px;">
                    <button onclick="verifyPhoneCode()" style="background:linear-gradient(135deg,#2ecc71,#27ae60);border-color:#27ae60;font-size:15px;padding:14px;">
                        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥
                    </button>
                    <button onclick="resendCode()" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--silver);font-size:13px;padding:10px;margin-top:0;">
                        üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    </button>
                </div>

                <!-- –®–∞–≥ 3: –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ -->
                <div class="phone-step" id="phoneStep3">
                    <div style="text-align:center;padding:15px;background:rgba(46,204,113,0.1);border-radius:10px;border:1px solid rgba(46,204,113,0.3);">
                        <div style="font-size:32px;margin-bottom:8px;">‚úÖ</div>
                        <div style="color:#2ecc71;font-weight:700;font-size:16px;">–ù–æ–º–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!</div>
                        <div id="verifiedPhoneNumber" style="color:var(--silver);font-size:14px;margin-top:4px;"></div>
                    </div>
                </div>
            </div>

            <div class="recovery-section">
                <h4 style="color:#2ecc71;margin-bottom:15px;">üîê –§—Ä–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</h4>
                <div class="phrase-display" id="recoveryPhraseDisplay">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                <div class="form-actions">
                    <button onclick="generateRecoveryPhrase()" class="generate-btn">üé≤ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button onclick="copyRecoveryPhrase()" class="copy-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="warning-box">
                    <span class="warning-icon">‚ö†Ô∏è</span> <strong>–í–ê–ñ–ù–û!</strong> –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç—É —Ñ—Ä–∞–∑—É –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ!<br>–ë–µ–∑ –Ω–µ–µ –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø.
                </div>
            </div>
            <div class="form-actions">
                <button onclick="createAccount()">‚úÖ –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <button onclick="hideRegisterModal()" style="background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ -->
    <div id="recoveryModal" class="modal-overlay">
        <div class="modal-content">
            <h3><span class="diamond">üîì</span> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞</h3>
            <input type="text" id="recovery-username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off">
            <textarea id="recovery-phrase-input" class="recovery-textarea" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (12 —Å–ª–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª)"></textarea>
            <div class="error" id="recoveryError"></div>
            <div class="form-actions">
                <button onclick="recoverPassword()" class="recovery-btn">üîì –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <button onclick="hideRecoveryModal()" style="background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞</h3>
            <div class="confirm-details" id="confirmDetails"></div>
            <div class="form-actions" style="margin-top:20px;">
                <button onclick="confirmSend()" style="background:linear-gradient(135deg,#27ae60,#1e8449);">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button onclick="hideConfirmModal()" style="background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</h3>
            <div class="profile-avatar" id="profileAvatarModal" style="width:70px;height:70px;font-size:32px;">?</div>
            <p style="text-align:center;margin:10px 0 5px;font-size:18px;font-weight:700;" id="profileName"></p>
            <p style="text-align:center;color:var(--silver);font-size:13px;" id="profileCreated"></p>
            <p style="text-align:center;color:#0088cc;font-size:13px;" id="profilePhone"></p>
            <div class="change-password-section">
                <h4 style="color:#3498db;margin-bottom:15px;">üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h4>
                <input type="password" id="cp-current" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" autocomplete="off">
                <input type="password" id="cp-new" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" autocomplete="off" oninput="checkNewPasswordStrength(this.value)">
                <div class="password-strength" id="cpStrengthBar"></div>
                <div class="strength-label" id="cpStrengthLabel"></div>
                <input type="password" id="cp-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" autocomplete="off">
                <div class="error" id="cpError"></div>
                <button onclick="changePassword()" class="blue-btn">üîë –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </div>
            <button onclick="hideProfileModal()" style="margin-top:15px;background:linear-gradient(135deg,#95a5a6,#7f8c8d);">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="welcomeModal" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <div style="background:rgba(255,0,0,0.06); border:2px solid rgba(255,50,50,0.3); border-radius:16px; padding:22px; margin-bottom:18px;">
                <div style="font-size:13px; color:#e74c3c; text-transform:uppercase; letter-spacing:2px; font-weight:700; margin-bottom:10px;">‚ö°Ô∏è –≠–¢–û –°–û–û–ë–©–ï–ù–ò–ï –£–î–ê–õ–Ø–¢</div>
                <div style="font-size:14px; color:var(--platinum); line-height:1.9; text-align:left;">
                    –ï—Å—Ç—å –º–æ–Ω–µ—Ç–∞. –û–Ω–∞ –Ω–µ –Ω–∞ –±–∏—Ä–∂–µ.<br>
                    –ï—ë –Ω–µ –∫—É–ø–∏—à—å –∑–∞ –¥–µ–Ω—å–≥–∏.<br>
                    –ï—ë –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ <strong style="color:var(--gold-light);">–ø–æ–ª—É—á–∏—Ç—å</strong> ‚Äî –µ—Å–ª–∏ –∑–Ω–∞–µ—à—å –≥–¥–µ.<br><br>
                    –° –∞–ø—Ä–µ–ª—è 2025 –æ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç.<br>
                    <strong style="color:var(--gold-primary);">–ö–∞–∂–¥—ã–π. –î–µ–Ω—å. –ë–µ–∑. –ò—Å–∫–ª—é—á–µ–Ω–∏–π.</strong><br><br>
                    –ü–æ–∫–∞ –≤–µ—Å—å –º–∏—Ä –≥–æ–Ω—è–ª—Å—è –∑–∞ –±–∏—Ç–∫–æ–∏–Ω–æ–º ‚Äî<br>
                    –º–∞–ª–µ–Ω—å–∫–∞—è –≥—Ä—É–ø–ø–∞ –ª—é–¥–µ–π —Ç–∏—Ö–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–ª–∞ <strong style="color:var(--gold-light);">RIDCOIN.</strong><br><br>
                    –û–Ω–∏ –Ω–µ —Å–ø–µ—à–∏–ª–∏ —Ç–µ–±–µ –æ–± —ç—Ç–æ–º —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å.<br><br>
                    <strong style="color:#fff;">–ù–æ —Å–µ–≥–æ–¥–Ω—è ‚Äî —Ç—ã —É–∑–Ω–∞–ª. –≠—Ç–æ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å.</strong>
                </div>
            </div>
            <div style="background:var(--black-matte); border-radius:12px; padding:18px; margin:12px 0; border:1px solid rgba(241,196,15,0.2);">
                <div style="font-size:12px; color:var(--silver); margin-bottom:6px;">üìà –ö—É—Ä—Å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</div>
                <div style="font-size:30px; font-weight:900; color:var(--gold-primary);" id="welcomeRate">1 RID = ... USD</div>
                <div style="font-size:12px; color:var(--silver); margin-top:4px;" id="welcomeDate"></div>
                <div style="font-size:12px; color:#e74c3c; margin-top:6px; font-weight:700;">‚è≥ –ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Ä–æ–∂–µ</div>
            </div>
            <div style="background:rgba(241,196,15,0.1); border:2px solid var(--gold-primary); border-radius:16px; padding:18px; margin:12px 0;">
                <div style="font-size:13px; color:var(--silver); margin-bottom:8px;">üéÅ –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö –∫—Ç–æ —É—Å–ø–µ–µ—Ç</div>
                <div style="font-size:44px; font-weight:900; color:var(--gold-primary); text-shadow:var(--glow-gold);">1 RID</div>
                <div style="font-size:13px; color:var(--gold-light); margin-top:4px;">–±–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É</div>
            </div>
            <div style="margin:16px 0 8px; font-size:13px; color:var(--silver);">üëá –ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª—ã –∏ –Ω–∞–ø–∏—à–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</div>
            <button onclick="window.open('https://t.me/RidcoinEcoSystem','_blank')" style="background:linear-gradient(135deg,#0088cc,#006ba6);border:2px solid #006ba6;margin-bottom:8px;font-size:15px;padding:14px;">
                ‚úàÔ∏è RIDCOIN EcoSystem
            </button>
            <button onclick="window.open('https://t.me/atigotovizmenitsa','_blank')" style="background:linear-gradient(135deg,#0088cc,#006ba6);border:2px solid #006ba6;margin-bottom:8px;font-size:15px;padding:14px;">
                ‚úàÔ∏è –ê—Ç–∏ –≥–æ—Ç–æ–≤ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
            </button>
            <button onclick="window.open('https://t.me/vne_sisteme','_blank')" style="background:linear-gradient(135deg,#0088cc,#006ba6);border:2px solid #006ba6;margin-bottom:16px;font-size:15px;padding:14px;">
                ‚úàÔ∏è –í–Ω–µ —Å–∏—Å—Ç–µ–º—ã
            </button>
            <button onclick="hideWelcomeModal();" style="background:var(--gold-gradient);font-size:16px;padding:16px;">
                üíé –Ø —É–∂–µ –≤–Ω—É—Ç—Ä–∏ ‚Äî –∑–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

</div>

<!-- Firebase SDK (compat –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
// ============================================================
// FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================
const firebaseConfig = {
    apiKey:            "AIzaSyBYwiL1O7WiHXxlAEOZ2PWQFyDmiU_Bjjs",
    authDomain:        "ridcoin-d1ed7.firebaseapp.com",
    databaseURL:       "https://ridcoin-d1ed7-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:         "ridcoin-d1ed7",
    storageBucket:     "ridcoin-d1ed7.firebasestorage.app",
    messagingSenderId: "768053669932",
    appId:             "1:768053669932:web:8a1062808d2401b8e96189",
    measurementId:     "G-6MWY9G7XL7"
};

firebase.initializeApp(firebaseConfig);
const db   = firebase.database();
const auth = firebase.auth();

// ============================================================
// –¶–ï–ù–ê
// ============================================================
const RID_CREATION_DATE  = '2025-04-27';
const RID_INITIAL_PRICE  = 1.00;
const RID_DAILY_INCREASE = 1.00;
const SATOSHI_PER_RID    = 100000000;
const TG_CHANNEL         = 'https://t.me/RidcoinEcoSystem';

function getCurrentRidPrice() {
    const c = new Date(RID_CREATION_DATE + 'T00:00:00Z');
    const now = new Date();
    const days = Math.max(0, Math.floor(
        (Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()) -
         Date.UTC(c.getUTCFullYear(),  c.getUTCMonth(),   c.getUTCDate())) / 86400000
    ));
    return RID_INITIAL_PRICE + days * RID_DAILY_INCREASE;
}

function updateHeaderPrice() {
    const price = getCurrentRidPrice();
    const d = document.getElementById('headerPriceValue');
    if (d) d.textContent = `1 RID = ${price.toFixed(2)} USD`;
    const dd = document.getElementById('headerDate');
    if (dd) dd.textContent = new Date().toLocaleDateString('ru-RU', {day:'2-digit',month:'2-digit',year:'numeric'});
}

// ============================================================
// –ó–ê–ì–†–£–ó–û–ß–ù–´–ô –≠–ö–†–ê–ù
// ============================================================
function showLoading(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const o = document.getElementById('loadingOverlay');
    document.getElementById('loadingText').textContent = text;
    o.classList.add('show');
}
function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('show');
}

// ============================================================
// –¢–û–°–¢–´
// ============================================================
function showToast(msg, type = 'info') {
    const icons = {success:'‚úÖ', error:'‚ùå', info:'üíé'};
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<span>${icons[type]||'üíé'}</span><span>${msg}</span>`;
    document.getElementById('toast-container').appendChild(el);
    setTimeout(() => el.remove(), 3500);
}

// ============================================================
// SHA-256
// ============================================================
async function hashPassword(pw) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

// ============================================================
// –î–ê–ù–ù–´–ï (–≤ –ø–∞–º—è—Ç–∏ + Firebase —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
// ============================================================
let users = {}, currentUser = null, currentRecoveryPhrase = '', pendingTransfer = null;
let historyFilter = 'all', historyPage = 0;
const HISTORY_PAGE_SIZE = 10;
let phoneConfirmationResult = null;
let phoneVerified = false;
let verifiedPhone = '';

const RECOVERY_WORDS_FULL = [
    "–∫–æ—à–∫–∞","–¥–æ–º","—Å–æ–ª–Ω—Ü–µ","—Ä–µ–∫–∞","–≥–æ—Ä—ã","–∫–Ω–∏–≥–∞","—á–∞—à–∫–∞","—Å—Ç–æ–ª","–æ–∫–Ω–æ","–º–æ—Ä–µ",
    "–ø—Ç–∏—Ü–∞","—Ü–≤–µ—Ç–æ–∫","–¥–µ—Ä–µ–≤–æ","–∫–ª—é—á","–æ–≥–æ–Ω—å","–≤–µ—Ç–µ—Ä","–∑–≤–µ–∑–¥–∞","–ª—É–Ω–∞","–¥–æ–∂–¥—å","—Å–Ω–µ–≥",
    "—Ç—Ä–∞–≤–∞","–ª–∏—Å—Ç","–∫–∞–º–µ–Ω—å","–ø–µ—Å–æ–∫","–≤–æ–¥–∞","–≤–æ–∑–¥—É—Ö","–∑–µ–º–ª—è","–º–µ—Ç–∞–ª–ª","—Ä—É–∫–∞","–Ω–æ–≥–∞",
    "–≥–æ–ª–æ–≤–∞","—Å–µ—Ä–¥—Ü–µ","–≥–ª–∞–∑","—É—Ö–æ","–Ω–æ—Å","—Ä–æ—Ç","–∑—É–±","–≤–æ–ª–æ—Å","—è–±–ª–æ–∫–æ","—Ö–ª–µ–±",
    "–º–æ–ª–æ–∫–æ","—Å–∞—Ö–∞—Ä","—Å–æ–ª—å","—á–∞–π","–∫–æ—Ñ–µ","–º—è—Å–æ","—Ä—ã–±–∞","—Å—ã—Ä","—Å—Ç—É–ª","–¥–≤–µ—Ä—å",
    "–∫—Ä–æ–≤–∞—Ç—å","–ª–∞–º–ø–∞","—á–∞—Å—ã","–∑–µ—Ä–∫–∞–ª–æ","–∫–æ–≤–µ—Ä","–ø–æ–ª–∫–∞","—à–∫–∞—Ñ","–º–∞—à–∏–Ω–∞","–¥–æ—Ä–æ–≥–∞",
    "–º–æ—Å—Ç","–ø–æ–µ–∑–¥","—Å–∞–º–æ–ª–µ—Ç","–∫–æ—Ä–∞–±–ª—å","–≤–µ–ª–æ—Å–∏–ø–µ–¥","–ª–æ–¥–∫–∞","—Ä–∞–∫–µ—Ç–∞","—Ç—Ä–∞–∫—Ç–æ—Ä",
    "–≥–æ—Ä–æ–¥","—Å–µ–ª–æ","—É–ª–∏—Ü–∞","–ø–ª–æ—â–∞–¥—å","–ø–∞—Ä–∫","—Å–∞–¥","–ª–µ—Å","–ø–æ–ª–µ","–æ–∑–µ—Ä–æ","–æ–∫–µ–∞–Ω",
    "–∑–∏–º–∞","–≤–µ—Å–Ω–∞","–ª–µ—Ç–æ","–æ—Å–µ–Ω—å","—É—Ç—Ä–æ","–¥–µ–Ω—å","–≤–µ—á–µ—Ä","–Ω–æ—á—å","—á–∞—Å","–º–∏–Ω—É—Ç–∞",
    "—Ä–∞–±–æ—Ç–∞","–æ—Ç–¥—ã—Ö","–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ","–¥—Ä—É–≥","—Å–µ–º—å—è","–ª—é–±–æ–≤—å","—Å—á–∞—Å—Ç—å–µ","–º–µ—á—Ç–∞","—Ü–µ–ª—å","—É—Å–ø–µ—Ö"
];

// ============================================================
// –ê–í–ê–¢–ê–†
// ============================================================
const AVATAR_COLORS = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#e91e63'];
function getAvatarColor(name) {
    let h = 0;
    for (let c of name) h = (h * 31 + c.charCodeAt(0)) & 0xffffffff;
    return AVATAR_COLORS[Math.abs(h) % AVATAR_COLORS.length];
}
function renderAvatar(el, name) {
    if (!el || !name) return;
    el.style.background = getAvatarColor(name);
    el.textContent = name[0].toUpperCase();
}

// ============================================================
// FIREBASE: –•–†–ê–ù–ò–õ–ò–©–ï
// ============================================================

/** –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Firebase */
async function loadAllUsers() {
    showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
    try {
        const snap = await db.ref('users').get();
        users = snap.exists() ? snap.val() : {};
        await ensureSystemAccount();
        hideLoading();
        updateUsersList();
        updateUsersCounter();
        setFirebaseConnected(true);
    } catch (e) {
        console.error('Firebase load error:', e);
        hideLoading();
        // Fallback –Ω–∞ localStorage
        const d = localStorage.getItem('ridcoin_gold');
        if (d) users = JSON.parse(d);
        await ensureSystemAccount();
        setFirebaseConnected(false);
        showToast('‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase, —Ä–∞–±–æ—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω', 'error');
        updateUsersList();
        updateUsersCounter();
    }
}

/** –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase */
async function saveUser(username) {
    try {
        await db.ref(`users/${username}`).set(users[username]);
        // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
        localStorage.setItem('ridcoin_gold', JSON.stringify(users));
    } catch (e) {
        console.error('Firebase save error:', e);
        // Fallback: —Ç–æ–ª—å–∫–æ localStorage
        localStorage.setItem('ridcoin_gold', JSON.stringify(users));
        showToast('‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)', 'error');
    }
}

/** –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ —Ä–∞–∑ (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è) */
async function saveUsers(usernameList) {
    const updates = {};
    for (const u of usernameList) updates[`users/${u}`] = users[u];
    try {
        await db.ref().update(updates);
        localStorage.setItem('ridcoin_gold', JSON.stringify(users));
    } catch (e) {
        console.error('Firebase multi-save error:', e);
        localStorage.setItem('ridcoin_gold', JSON.stringify(users));
        showToast('‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)', 'error');
    }
}

/** –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
let userListener = null;
function subscribeToUserUpdates(username) {
    if (userListener) { userListener(); userListener = null; }
    userListener = db.ref(`users/${username}`).on('value', snap => {
        if (snap.exists()) {
            users[username] = snap.val();
            if (currentUser === username) updateWalletDisplay();
        }
    });
}

/** –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å—á—ë—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (real-time) */
function subscribeToUsersCount() {
    db.ref('users').on('value', snap => {
        if (!snap.exists()) return;
        const data = snap.val();
        const count = Object.keys(data).filter(u => !data[u].hidden).length;
        const el = document.getElementById('totalUsersCount');
        if (el) el.textContent = count;
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∏–º–µ–Ω–∞ + –±–∞–ª–∞–Ω—Å—ã –¥–ª—è autocomplete)
        Object.keys(data).forEach(u => {
            if (!users[u]) users[u] = data[u];
            else {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –ø–æ–ª—è
                users[u].balance = data[u].balance;
                users[u].admin   = data[u].admin;
                users[u].hidden  = data[u].hidden;
            }
        });
        updateUsersList();
    });
}

function setFirebaseConnected(ok) {
    const badge  = document.getElementById('firebaseBadge');
    const status = document.getElementById('firebaseStatus');
    if (ok) {
        badge.classList.add('connected');
        status.textContent = 'Firebase –ø–æ–¥–∫–ª—é—á—ë–Ω';
    } else {
        badge.classList.remove('connected');
        status.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
    }
}

// ============================================================
// –°–ò–°–¢–ï–ú–ù–´–ô –ê–ö–ö–ê–£–ù–¢
// ============================================================
async function ensureSystemAccount() {
    if (!users['RIDCOIN']) {
        users['RIDCOIN'] = {
            passwordHash: await hashPassword('RIDcoin'),
            recoveryPhrase: '—Å–∏—Å—Ç–µ–º–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è',
            balance: 108000000,
            history: ['üíé –°–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ RIDCOIN'],
            admin: false,
            hidden: true,
            createdAt: '2025-04-27T00:00:00.000Z',
            lastLogin: null,
            sentTotal: 0, receivedTotal: 0, txCount: 0
        };
        await saveUser('RIDCOIN');
    } else if (!users['RIDCOIN'].hidden) {
        users['RIDCOIN'].hidden = true;
        users['RIDCOIN'].admin  = false;
        await saveUser('RIDCOIN');
    }
}

// ============================================================
// –°–ß–Å–¢–ß–ò–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
// ============================================================
function updateUsersCounter() {
    const count = Object.keys(users).filter(u => !users[u].hidden).length;
    const el = document.getElementById('totalUsersCount');
    if (el) el.textContent = count;
}

// ============================================================
// –°–ü–ò–°–û–ö –ù–ê –≠–ö–†–ê–ù–ï –í–•–û–î–ê
// ============================================================
function updateUsersList() {
    const visible = getSortedUsers();
    const listDiv = document.getElementById('userList');
    const container = document.getElementById('usersContainer');
    if (visible.length === 0) { listDiv.style.display = 'none'; return; }
    listDiv.style.display = 'block';
    container.innerHTML = '';
    visible.forEach(({username, user}) => {
        const balance = user.balance || 0;
        const div = document.createElement('div');
        div.className = user.admin ? 'user-item user-item-admin' : 'user-item';
        div.innerHTML = `
            <div class="balance-display" style="display:flex;align-items:center;gap:10px;">
                <div style="width:36px;height:36px;border-radius:50%;background:${getAvatarColor(username)};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;flex-shrink:0;">${username[0].toUpperCase()}</div>
                <strong>${username}</strong> ${user.admin ? '<span class="crown-icon">üëë</span>' : ''}
            </div>
            <span class="${balance===0?'zero-balance':'gold-text'}">${formatRid(balance)} RID</span>`;
        container.appendChild(div);
    });
}

function getSortedUsers() {
    return Object.keys(users)
        .filter(u => !users[u].hidden)
        .map(u => ({username:u, user:users[u]}))
        .sort((a,b) => {
            if (a.user.admin && !b.user.admin) return -1;
            if (!a.user.admin && b.user.admin) return 1;
            return (b.user.balance||0) - (a.user.balance||0);
        });
}

// ============================================================
// –ì–†–ê–§–ò–ö –ö–£–†–°–ê
// ============================================================
function drawRidChart() {
    const canvas = document.getElementById('ridChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.offsetWidth; const H = 120;
    canvas.width = W; canvas.height = H;
    const price = getCurrentRidPrice();
    const points = [];
    for (let i = 6; i >= 0; i--) points.push(price - i * RID_DAILY_INCREASE);
    const minP = Math.min(...points) - 1;
    const maxP = Math.max(...points) + 1;
    const pad = { top:10, bottom:25, left:8, right:8 };
    const chartW = W - pad.left - pad.right;
    const chartH = H - pad.top - pad.bottom;
    const toX = i => pad.left + (i / (points.length - 1)) * chartW;
    const toY = v => pad.top + (1 - (v - minP) / (maxP - minP)) * chartH;
    const grad = ctx.createLinearGradient(0, pad.top, 0, H - pad.bottom);
    grad.addColorStop(0, 'rgba(241,196,15,0.3)');
    grad.addColorStop(1, 'rgba(241,196,15,0)');
    ctx.beginPath();
    points.forEach((p, i) => i === 0 ? ctx.moveTo(toX(i), toY(p)) : ctx.lineTo(toX(i), toY(p)));
    ctx.lineTo(toX(points.length-1), H - pad.bottom);
    ctx.lineTo(toX(0), H - pad.bottom);
    ctx.closePath();
    ctx.fillStyle = grad;
    ctx.fill();
    ctx.beginPath();
    points.forEach((p, i) => i === 0 ? ctx.moveTo(toX(i), toY(p)) : ctx.lineTo(toX(i), toY(p)));
    ctx.strokeStyle = '#F1C40F'; ctx.lineWidth = 2.5; ctx.lineJoin = 'round'; ctx.stroke();
    const now = new Date();
    points.forEach((p, i) => {
        ctx.beginPath(); ctx.arc(toX(i), toY(p), 3.5, 0, Math.PI*2); ctx.fillStyle = '#F1C40F'; ctx.fill();
        const d = new Date(now); d.setDate(d.getDate() - (6 - i));
        const label = `${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}`;
        ctx.fillStyle = 'rgba(192,192,192,0.6)'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(label, toX(i), H - 5);
    });
    ctx.fillStyle = '#F1C40F'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(`${price.toFixed(0)} USD`, W - pad.right, pad.top + 12);
}

// ============================================================
// –ß–ê–°–¢–ò–¶–´
// ============================================================
function launchParticles() {
    const canvas = document.getElementById('particles-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    canvas.classList.add('active');
    const particles = Array.from({length: 60}, () => ({
        x: Math.random() * canvas.width, y: Math.random() * canvas.height,
        r: Math.random() * 4 + 2, dx: (Math.random() - 0.5) * 3, dy: -(Math.random() * 4 + 2),
        alpha: 1, color: ['#F1C40F','#FFD700','#fff','#B8860B'][Math.floor(Math.random()*4)]
    }));
    let frame = 0;
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
            p.x += p.dx; p.y += p.dy; p.alpha -= 0.015;
            ctx.save(); ctx.globalAlpha = Math.max(0, p.alpha);
            ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
            ctx.fillStyle = p.color; ctx.fill(); ctx.restore();
        });
        frame++;
        if (frame < 80) requestAnimationFrame(animate);
        else { canvas.classList.remove('active'); ctx.clearRect(0,0,canvas.width,canvas.height); }
    }
    animate();
}

// ============================================================
// –†–ï–ê–õ–¨–ù–´–ô –ë–ê–õ–ê–ù–° –° POLYGON
// ============================================================
const CHAIN_WALLET   = '0xa09073eFC2aaf713799A04c21440199783713972';
const CHAIN_CONTRACT = '0xcD36914FD4C560D1475088eB84bB82C11f3E19DE';
const POLYGON_RPC    = 'https://polygon-rpc.com';

async function loadChainBalance() {
    const valEl = document.getElementById('chainBalance');
    const subEl = document.getElementById('chainBalanceSub');
    if (!valEl) return;
    valEl.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...'; subEl.textContent = '';
    try {
        const data = '0x70a08231' + CHAIN_WALLET.replace('0x','').padStart(64,'0');
        const resp = await fetch(POLYGON_RPC, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jsonrpc:'2.0', method:'eth_call', params:[{to:CHAIN_CONTRACT, data},'latest'], id:1 })
        });
        const json = await resp.json();
        if (json.result && json.result !== '0x') {
            const raw = BigInt(json.result);
            const whole = raw / (10n ** 18n);
            valEl.textContent = Number(whole).toLocaleString('ru-RU') + ' RID';
            subEl.textContent = '–ê–¥—Ä–µ—Å: ' + CHAIN_WALLET.slice(0,8) + '...' + CHAIN_WALLET.slice(-6) + ' ¬∑ Polygon';
        } else {
            valEl.textContent = '0 RID'; subEl.textContent = '–ë–∞–ª–∞–Ω—Å –Ω–µ –Ω–∞–π–¥–µ–Ω';
        }
    } catch(e) {
        valEl.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞'; subEl.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏';
    }
}

// ============================================================
// –°–ò–õ–ê –ü–ê–†–û–õ–Ø
// ============================================================
function evalPasswordStrength(pw) {
    if (!pw) return null;
    let s = 0;
    if (pw.length >= 6) s++;
    if (pw.length >= 10) s++;
    if (/[0-9]/.test(pw)) s++;
    if (/[A-Za-z]/.test(pw)) s++;
    if (/[^A-Za-z0-9]/.test(pw)) s++;
    return s <= 2 ? 'weak' : s <= 3 ? 'medium' : 'strong';
}
function applyStrength(barId, labelId, pw) {
    const bar = document.getElementById(barId), label = document.getElementById(labelId);
    const s = evalPasswordStrength(pw);
    if (!s) { bar.className = 'password-strength'; label.textContent = ''; return; }
    bar.className = `password-strength ${s}`;
    label.className = `strength-label ${s}`;
    label.textContent = {weak:'–°–ª–∞–±—ã–π', medium:'–°—Ä–µ–¥–Ω–∏–π', strong:'–ù–∞–¥—ë–∂–Ω—ã–π'}[s];
}
function checkPasswordStrength(pw) { applyStrength('pwStrengthBar','pwStrengthLabel',pw); }
function checkNewPasswordStrength(pw) { applyStrength('cpStrengthBar','cpStrengthLabel',pw); }

// ============================================================
// –§–†–ê–ó–ê –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø
// ============================================================
function generateRecoveryPhrase() {
    const words = [];
    for (let i = 0; i < 12; i++) words.push(RECOVERY_WORDS_FULL[Math.floor(Math.random() * RECOVERY_WORDS_FULL.length)]);
    currentRecoveryPhrase = words.join(' ');
    const d = document.getElementById('recoveryPhraseDisplay');
    d.innerHTML = '';
    words.forEach((w,i) => {
        const s = document.createElement('span'); s.className='phrase-word';
        s.textContent=`${i+1}. ${w}`; d.appendChild(s);
    });
    return currentRecoveryPhrase;
}
function copyRecoveryPhrase() {
    if (!currentRecoveryPhrase) { showToast('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ñ—Ä–∞–∑—É!','error'); return; }
    navigator.clipboard.writeText(currentRecoveryPhrase)
        .then(() => showToast('–§—Ä–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!','success'))
        .catch(() => {
            const ta=document.createElement('textarea'); ta.value=currentRecoveryPhrase;
            document.body.appendChild(ta); ta.select(); document.execCommand('copy');
            document.body.removeChild(ta); showToast('–§—Ä–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!','success');
        });
}

// ============================================================
// FIREBASE PHONE VERIFICATION
// ============================================================
let recaptchaVerifier = null;

function initRecaptcha() {
    if (recaptchaVerifier) return;
    recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        'size': 'normal',
        'theme': 'dark',
        'callback': () => { /* reCAPTCHA –ø—Ä–æ–π–¥–µ–Ω–∞ */ },
        'expired-callback': () => {
            showToast('reCAPTCHA —É—Å—Ç–∞—Ä–µ–ª–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É', 'error');
            recaptchaVerifier = null;
        }
    });
    recaptchaVerifier.render();
}

async function sendPhoneCode() {
    const phone = document.getElementById('reg-phone').value.trim();
    if (!phone || phone.length < 10) { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error'); return; }
    if (!recaptchaVerifier) initRecaptcha();
    showLoading('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...');
    try {
        phoneConfirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);
        hideLoading();
        document.getElementById('phoneSentTo').textContent = phone;
        document.getElementById('phoneStep1').classList.remove('active');
        document.getElementById('phoneStep2').classList.add('active');
        showToast('üì≤ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
    } catch (e) {
        hideLoading();
        console.error(e);
        recaptchaVerifier = null;
        const msg = e.code === 'auth/invalid-phone-number' ? '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞' :
                    e.code === 'auth/too-many-requests' ? '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ' :
                    '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: ' + e.message;
        showToast(msg, 'error');
    }
}

async function verifyPhoneCode() {
    const code = document.getElementById('reg-sms-code').value.trim();
    if (!code || code.length !== 6) { showToast('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥', 'error'); return; }
    if (!phoneConfirmationResult) { showToast('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥', 'error'); return; }
    showLoading('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...');
    try {
        const result = await phoneConfirmationResult.confirm(code);
        hideLoading();
        phoneVerified = true;
        verifiedPhone = result.user.phoneNumber;
        document.getElementById('phoneStep2').classList.remove('active');
        document.getElementById('phoneStep3').classList.add('active');
        document.getElementById('verifiedPhoneNumber').textContent = verifiedPhone;
        showToast('‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!', 'success');
        // –í—ã—Ö–æ–¥–∏–º –∏–∑ Firebase Auth (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)
        await auth.signOut();
    } catch (e) {
        hideLoading();
        const msg = e.code === 'auth/invalid-verification-code' ? '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥' :
                    e.code === 'auth/code-expired' ? '–ö–æ–¥ —É—Å—Ç–∞—Ä–µ–ª, –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π' :
                    '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞';
        showToast(msg, 'error');
    }
}

function resendCode() {
    phoneConfirmationResult = null;
    recaptchaVerifier = null;
    document.getElementById('phoneStep2').classList.remove('active');
    document.getElementById('phoneStep1').classList.add('active');
    document.getElementById('reg-sms-code').value = '';
    document.getElementById('recaptcha-container').innerHTML = '';
    initRecaptcha();
}

function skipPhoneVerification() {
    phoneVerified = false;
    verifiedPhone = '';
    showToast('–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞', 'info');
}

// ============================================================
// –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
// ============================================================
function showRegisterModal() {
    document.getElementById('registerModal').style.display = 'flex';
    generateRecoveryPhrase();
    // –°–±—Ä–æ—Å–∏—Ç—å phone steps
    ['phoneStep1','phoneStep2','phoneStep3'].forEach(id => document.getElementById(id).classList.remove('active'));
    document.getElementById('phoneStep1').classList.add('active');
    phoneVerified = false; verifiedPhone = '';
    phoneConfirmationResult = null;
    setTimeout(() => initRecaptcha(), 300);
}
function hideRegisterModal() {
    document.getElementById('registerModal').style.display = 'none';
    recaptchaVerifier = null;
}

async function createAccount() {
    const username = document.getElementById('reg-username').value.trim();
    const password = document.getElementById('reg-password').value;
    const confirm  = document.getElementById('reg-confirm').value;
    if (!username)                       { showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è','error'); return; }
    if (username.toUpperCase()==='RIDCOIN') { showToast('–≠—Ç–æ –∏–º—è –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ','error'); return; }
    if (users[username])                 { showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç','error'); return; }
    if (!password || password.length < 6){ showToast('–ü–∞—Ä–æ–ª—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤','error'); return; }
    if (password !== confirm)            { showToast('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç','error'); return; }
    if (!currentRecoveryPhrase)          { showToast('–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ñ—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è','error'); return; }

    showLoading('–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞...');
    const pwHash = await hashPassword(password);

    users[username] = {
        passwordHash: pwHash,
        recoveryPhrase: currentRecoveryPhrase,
        balance: 0,
        history: ['üÜï –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω'],
        admin: false,
        createdAt: new Date().toISOString(),
        lastLogin: null,
        sentTotal: 0, receivedTotal: 0, txCount: 0,
        phone: phoneVerified ? verifiedPhone : null,
        phoneVerified: phoneVerified
    };

    await saveUser(username);
    hideLoading();
    hideRegisterModal();
    showToast(`‚úÖ –ö–æ—à–µ–ª—ë–∫ "${username}" —Å–æ–∑–¥–∞–Ω!`, 'success');
    setTimeout(() => alert(`‚úÖ –§—Ä–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:\n\n${currentRecoveryPhrase}\n\n‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ—ë –≤ –Ω–∞–¥—ë–∂–Ω–æ–º –º–µ—Å—Ç–µ!`), 300);
    currentUser = username;
    subscribeToUserUpdates(username);
    showWallet();
    setTimeout(() => showWelcomeModal(), 600);
}

// ============================================================
// –í–•–û–î
// ============================================================
async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    if (!username) { showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è','error'); return; }
    if (!password) { showToast('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å','error'); return; }

    showLoading('–í—Ö–æ–¥...');
    // –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firebase
    try {
        const snap = await db.ref(`users/${username}`).get();
        if (!snap.exists()) { hideLoading(); showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
        users[username] = snap.val();
    } catch(e) {
        hideLoading();
        if (!users[username]) { showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)','error'); return; }
    }

    const u = users[username];
    let valid = false;
    if (u.passwordHash) {
        valid = (await hashPassword(password)) === u.passwordHash;
    } else if (u.password) {
        valid = u.password === password;
        if (valid) { u.passwordHash = await hashPassword(password); delete u.password; }
    }

    if (!valid) { hideLoading(); showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å','error'); return; }

    u.lastLogin = new Date().toISOString();
    await saveUser(username);
    hideLoading();
    currentUser = username;
    subscribeToUserUpdates(username);
    showWallet();
    launchParticles();
    setTimeout(() => showWelcomeModal(), 400);
}

// ============================================================
// –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ü–ê–†–û–õ–Ø
// ============================================================
function showRecoveryModal() { document.getElementById('recoveryModal').style.display='flex'; document.getElementById('recoveryError').style.display='none'; }
function hideRecoveryModal() { document.getElementById('recoveryModal').style.display='none'; }

async function recoverPassword() {
    const username = document.getElementById('recovery-username').value.trim();
    const phrase   = document.getElementById('recovery-phrase-input').value.trim();
    const errDiv   = document.getElementById('recoveryError');
    errDiv.style.display = 'none';
    if (!username) { errDiv.textContent='–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'; errDiv.style.display='block'; return; }

    showLoading('–ü—Ä–æ–≤–µ—Ä–∫–∞...');
    try {
        const snap = await db.ref(`users/${username}`).get();
        if (!snap.exists()) { hideLoading(); errDiv.textContent='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'; errDiv.style.display='block'; return; }
        users[username] = snap.val();
    } catch(e) {
        hideLoading();
        if (!users[username]) { errDiv.textContent='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'; errDiv.style.display='block'; return; }
    }
    hideLoading();

    if (!phrase) { errDiv.textContent='–í–≤–µ–¥–∏—Ç–µ —Ñ—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è'; errDiv.style.display='block'; return; }
    if (phrase.toLowerCase().replace(/\s+/g,' ').trim() !== users[username].recoveryPhrase.toLowerCase()) {
        errDiv.textContent='–ù–µ–≤–µ—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è'; errDiv.style.display='block'; return;
    }
    hideRecoveryModal();
    const newPw = prompt('‚úÖ –§—Ä–∞–∑–∞ –≤–µ—Ä–Ω–∞!\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤):');
    if (!newPw || newPw.length < 6) { showToast('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π','error'); return; }
    showLoading('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    users[username].passwordHash = await hashPassword(newPw);
    delete users[username].password;
    await saveUser(username);
    hideLoading();
    showToast('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω! –í–æ–π–¥–∏—Ç–µ —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º.','success');
    document.getElementById('username').value = username;
}

// ============================================================
// –ö–û–®–ï–õ–Å–ö
// ============================================================
function showWallet() {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('wallet').style.display = 'block';
    document.getElementById('adminPanel').style.display = currentUser === 'RIDCOIN' ? 'block' : 'none';
    updateWalletDisplay();
}

function updateWalletDisplay() {
    if (!currentUser || !users[currentUser]) return;
    const user = users[currentUser];
    const ridBalance = user.balance || 0;
    const ridPrice   = getCurrentRidPrice();
    const usdValue   = (ridBalance * ridPrice).toFixed(2);

    document.getElementById('userName').textContent = currentUser;
    renderAvatar(document.getElementById('profileAvatar'), currentUser);

    const balDiv = document.getElementById('balance');
    balDiv.textContent = formatRid(ridBalance) + ' RID';
    balDiv.style.color = ridBalance === 0 ? '#e74c3c' : '#F1C40F';

    document.getElementById('usdBalance').innerHTML = `‚âà ${usdValue} USD`;
    document.getElementById('userBadge').textContent = user.admin ? 'üëë –ê–î–ú–ò–ù' : 'üë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨';

    const ll = document.getElementById('lastLoginNote');
    if (user.lastLogin) ll.textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: ${new Date(user.lastLogin).toLocaleString('ru-RU')}`;

    document.getElementById('statTxCount').textContent  = user.txCount || 0;
    document.getElementById('statVolume').textContent   = formatRid(user.sentTotal || 0);
    document.getElementById('statReceived').textContent = formatRid(user.receivedTotal || 0);
    document.getElementById('statDaysActive').textContent = user.createdAt
        ? Math.floor((Date.now() - new Date(user.createdAt).getTime()) / 86400000) : 0;

    drawRidChart();
    loadChainBalance();
    updateHistory();
    updateUsersList();
}

// ============================================================
// –ò–°–¢–û–†–ò–Ø
// ============================================================
function setHistoryFilter(f, btn) {
    historyFilter = f; historyPage = 0;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    updateHistory();
}
function getFilteredHistory() {
    if (!currentUser || !users[currentUser]) return [];
    const raw = (users[currentUser].history || []).slice().reverse();
    if (historyFilter === 'all') return raw;
    return raw.filter(t => historyFilter === 'in' ? (t.includes('‚Üê')||t.includes('—Å–æ–∑–¥–∞–Ω')) : t.includes('‚Üí'));
}
function updateHistory() {
    const div = document.getElementById('history');
    div.innerHTML = '';
    const all = getFilteredHistory();
    const totalPages = Math.ceil(all.length / HISTORY_PAGE_SIZE);
    if (historyPage >= totalPages && totalPages > 0) historyPage = totalPages - 1;
    const page = all.slice(historyPage * HISTORY_PAGE_SIZE, (historyPage + 1) * HISTORY_PAGE_SIZE);
    if (!page.length) {
        div.innerHTML = '<p style="color:#777;text-align:center;padding:10px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>';
    } else {
        page.forEach(t => {
            const item = document.createElement('div');
            let kind = 'system', kindLabel = '–°–∏—Å—Ç–µ–º–∞';
            if (t.includes('‚Üí')) { kind='out'; kindLabel='‚ñ≤ –ò—Å—Ö–æ–¥—è—â–∏–π'; }
            else if (t.includes('‚Üê')) { kind='in'; kindLabel='‚ñº –í—Ö–æ–¥—è—â–∏–π'; }
            const dateMatch   = t.match(/^\[(.+?)\]/);
            const amountMatch = t.match(/([\d\s.,]+ RID|\d+ —Å–∞—Ç–æ—à–∏)/);
            const usdMatch    = t.match(/\(\$([^)]+)\)/);
            const commentIdx  = t.lastIndexOf('|');
            const comment     = commentIdx !== -1 ? t.slice(commentIdx+1).trim() : '';
            let counterpart = '';
            if (t.includes('‚Üí')) counterpart = (t.match(/‚Üí\s*(.+?):/)||[])[1]?.trim()||'';
            if (t.includes('‚Üê')) counterpart = (t.match(/‚Üê\s*(.+?):/)||[])[1]?.trim()||'';
            item.className = `history-item ${kind}`;
            item.innerHTML = `
                <div class="hi-top">
                    <span class="hi-type ${kind}">${kindLabel}${counterpart?' ‚Ä¢ '+counterpart:''}</span>
                    <span class="hi-amount">${amountMatch?amountMatch[0]:''}</span>
                </div>
                <div class="hi-meta">${dateMatch?dateMatch[1]:''}${usdMatch?' ‚Ä¢ $'+usdMatch[1]:''}</div>
                ${comment?`<div class="hi-comment">üí¨ ${comment}</div>`:''}`;
            div.appendChild(item);
        });
    }
    const pag = document.getElementById('historyPagination');
    if (totalPages > 1) {
        pag.style.display = 'flex';
        document.getElementById('pageInfo').textContent = `${historyPage+1} / ${totalPages}`;
    } else { pag.style.display = 'none'; }
}
function historyPagePrev() { if (historyPage > 0) { historyPage--; updateHistory(); } }
function historyPageNext() {
    if (historyPage < Math.ceil(getFilteredHistory().length / HISTORY_PAGE_SIZE) - 1) { historyPage++; updateHistory(); }
}

// ============================================================
// –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï
// ============================================================
function onRecipientInput(val) {
    const list = document.getElementById('autocompleteList');
    if (!val) { list.style.display='none'; return; }
    const matches = Object.keys(users).filter(u => u !== currentUser && !users[u].hidden && u.toLowerCase().startsWith(val.toLowerCase()));
    if (!matches.length) { list.style.display='none'; return; }
    list.innerHTML = '';
    matches.slice(0,6).forEach(name => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = `<div class="ac-avatar" style="background:${getAvatarColor(name)};color:#fff;">${name[0].toUpperCase()}</div><span>${name}</span>${users[name].admin?'<span class="crown-icon" style="margin-left:auto;">üëë</span>':''}`;
        item.addEventListener('mousedown', () => { document.getElementById('to').value = name; list.style.display='none'; });
        list.appendChild(item);
    });
    list.style.display = 'block';
}
function hideAutocomplete() { setTimeout(() => { const l=document.getElementById('autocompleteList'); if(l) l.style.display='none'; }, 150); }

// ============================================================
// –ü–ï–†–ï–í–û–î
// ============================================================
function initiateSend() {
    if (!currentUser || !users[currentUser]) return;
    const to      = document.getElementById('to').value.trim();
    const amount  = parseFloat(document.getElementById('amount').value);
    const comment = document.getElementById('transferComment').value.trim();
    const errDiv  = document.getElementById('amountError');
    errDiv.style.display = 'none';
    const showErr = msg => { errDiv.textContent=msg; errDiv.style.display='block'; };
    if (!to)                                     { showErr('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è'); return; }
    if (!amount || isNaN(amount) || amount <= 0) { showErr('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É'); return; }
    if (Math.floor(amount*SATOSHI_PER_RID) < 1)  { showErr('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 0.00000001 RID'); return; }
    if (!users[to])                              { showErr(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${to}" –Ω–µ –Ω–∞–π–¥–µ–Ω`); return; }
    if (currentUser === to)                      { showErr('–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ'); return; }
    if ((users[currentUser].balance||0) < amount){ showErr(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ RID. –ë–∞–ª–∞–Ω—Å: ${formatRid(users[currentUser].balance||0)} RID`); return; }
    const ridPrice = getCurrentRidPrice();
    document.getElementById('confirmDetails').innerHTML = `
        <div class="confirm-row"><span class="label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</span><span class="value">${to}</span></div>
        <div class="confirm-row"><span class="label">–°—É–º–º–∞</span><span class="value">${formatRid(amount)} RID</span></div>
        <div class="confirm-row"><span class="label">–í USD</span><span class="value">‚âà $${(amount*ridPrice).toFixed(2)}</span></div>
        ${comment?`<div class="confirm-row"><span class="label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span><span class="value">${comment}</span></div>`:''}`;
    pendingTransfer = {to, amount, comment};
    document.getElementById('confirmModal').style.display = 'flex';
}
function hideConfirmModal() { document.getElementById('confirmModal').style.display='none'; pendingTransfer=null; }

async function confirmSend() {
    if (!pendingTransfer) return;
    const {to, amount, comment} = pendingTransfer;
    hideConfirmModal();
    showLoading('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞...');

    const amountSatoshi = Math.floor(amount * SATOSHI_PER_RID);
    const amountToSend  = amountSatoshi / SATOSHI_PER_RID;
    const ridPrice      = getCurrentRidPrice();
    const usdValue      = (amountToSend * ridPrice).toFixed(2);
    const date          = new Date().toLocaleString('ru-RU');
    let displayAmount;
    if (amountToSend >= 0.01)        displayAmount = amountToSend.toFixed(2) + ' RID';
    else if (amountToSend >= 0.000001) displayAmount = amountToSend.toFixed(6) + ' RID';
    else                             displayAmount = amountSatoshi + ' —Å–∞—Ç–æ—à–∏';

    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–∑ Firebase
        const [senderSnap, recipientSnap] = await Promise.all([
            db.ref(`users/${currentUser}`).get(),
            db.ref(`users/${to}`).get()
        ]);

        if (!senderSnap.exists()) { hideLoading(); showToast('–û—à–∏–±–∫–∞: –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error'); return; }
        if (!recipientSnap.exists()) { hideLoading(); showToast(`–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${to}" –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error'); return; }

        const senderData    = senderSnap.val();
        const recipientData = recipientSnap.val();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
        if ((senderData.balance || 0) < amountToSend) {
            hideLoading();
            showToast(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ RID. –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${formatRid(senderData.balance||0)} RID`, 'error');
            users[currentUser] = senderData;
            updateWalletDisplay();
            return;
        }

        const cs = comment ? ` | ${comment}` : '';

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        senderData.balance    = (senderData.balance || 0) - amountToSend;
        senderData.sentTotal  = (senderData.sentTotal || 0) + amountToSend;
        senderData.txCount    = (senderData.txCount || 0) + 1;
        if (!Array.isArray(senderData.history)) senderData.history = [];
        senderData.history.push(`[${date}] ‚Üí ${to}: ${displayAmount} ($${usdValue})${cs}`);

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        recipientData.balance       = (recipientData.balance || 0) + amountToSend;
        recipientData.receivedTotal = (recipientData.receivedTotal || 0) + amountToSend;
        recipientData.txCount       = (recipientData.txCount || 0) + 1;
        if (!Array.isArray(recipientData.history)) recipientData.history = [];
        recipientData.history.push(`[${date}] ‚Üê ${currentUser}: ${displayAmount} ($${usdValue})${cs}`);

        // –ê—Ç–æ–º–∞—Ä–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–æ–∏—Ö –≤ Firebase
        const updates = {};
        updates[`users/${currentUser}`] = senderData;
        updates[`users/${to}`]          = recipientData;
        await db.ref().update(updates);

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
        users[currentUser] = senderData;
        users[to]          = recipientData;
        localStorage.setItem('ridcoin_gold', JSON.stringify(users));

    } catch (e) {
        console.error('Transfer error:', e);
        hideLoading();
        showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: ' + e.message, 'error');
        return;
    }

    hideLoading();

    const balDiv = document.getElementById('balance');
    balDiv.classList.remove('flash'); void balDiv.offsetWidth; balDiv.classList.add('flash');
    updateWalletDisplay();
    document.getElementById('to').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('transferComment').value = '';
    showToast(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${displayAmount} ‚Üí ${to}`, 'success');
}

// ============================================================
// –ü–†–û–§–ò–õ–¨
// ============================================================
function showProfileModal() {
    const user = users[currentUser];
    document.getElementById('profileModal').style.display = 'flex';
    renderAvatar(document.getElementById('profileAvatarModal'), currentUser);
    document.getElementById('profileName').textContent = currentUser + (user.admin ? ' üëë' : '');
    document.getElementById('profileCreated').textContent = `–°–æ–∑–¥–∞–Ω: ${new Date(user.createdAt).toLocaleDateString('ru-RU')}`;
    const phoneEl = document.getElementById('profilePhone');
    phoneEl.textContent = user.phoneVerified ? `üì± ${user.phone}` : 'üì± –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
    document.getElementById('cpError').style.display = 'none';
    ['cp-current','cp-new','cp-confirm'].forEach(id => document.getElementById(id).value = '');
    applyStrength('cpStrengthBar','cpStrengthLabel','');
}
function hideProfileModal() { document.getElementById('profileModal').style.display='none'; }

async function changePassword() {
    const current = document.getElementById('cp-current').value;
    const newPw   = document.getElementById('cp-new').value;
    const confirm = document.getElementById('cp-confirm').value;
    const errDiv  = document.getElementById('cpError');
    errDiv.style.display = 'none';
    const showErr = msg => { errDiv.textContent=msg; errDiv.style.display='block'; };
    const user = users[currentUser];
    let valid = false;
    if (user.passwordHash) valid = (await hashPassword(current)) === user.passwordHash;
    else if (user.password) valid = user.password === current;
    if (!valid)          { showErr('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å'); return; }
    if (newPw.length < 6){ showErr('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å ‚Äî –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'); return; }
    if (newPw !== confirm){ showErr('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); return; }
    showLoading('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    user.passwordHash = await hashPassword(newPw);
    delete user.password;
    await saveUser(currentUser);
    hideLoading();
    hideProfileModal();
    showToast('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!', 'success');
}

// ============================================================
// –í–°–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò
// ============================================================
function showAllUsers() {
    if (currentUser === 'RIDCOIN') { showAllUsersAdmin(); return; }
    const modal = document.getElementById('usersModal');
    const listDiv = document.getElementById('allUsersList');
    listDiv.innerHTML = '';
    getSortedUsers().forEach(({username, user}) => {
        const balance = user.balance || 0;
        const div = document.createElement('div');
        div.className = user.admin ? 'user-item user-item-admin' : 'user-item';
        div.style.marginBottom='15px'; div.style.padding='15px';
        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:42px;height:42px;border-radius:50%;background:${getAvatarColor(username)};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;flex-shrink:0;">${username[0].toUpperCase()}</div>
                <div>
                    <div style="font-size:17px;font-weight:700;">${username} ${user.admin?'<span class="admin-badge">üëë –ê–î–ú–ò–ù</span>':''}</div>
                    <div>–ë–∞–ª–∞–Ω—Å: <span class="${balance===0?'zero-balance':'gold-text'}">${formatRid(balance)} RID</span></div>
                    <div style="color:#777;font-size:13px;">–°–æ–∑–¥–∞–Ω: ${new Date(user.createdAt).toLocaleDateString('ru-RU')} ¬∑ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${user.txCount||0}</div>
                </div>
            </div>`;
        listDiv.appendChild(div);
    });
    modal.style.display = 'flex';
}
function hideUsersModal() { document.getElementById('usersModal').style.display='none'; }

// ============================================================
// –ü–†–ò–í–ï–¢–°–¢–í–ï–ù–ù–û–ï –û–ö–ù–û
// ============================================================
function showWelcomeModal() {
    const price = getCurrentRidPrice();
    const today = new Date();
    document.getElementById('welcomeRate').textContent = `1 RID = ${price.toFixed(2)} USD`;
    document.getElementById('welcomeDate').textContent = today.toLocaleDateString('ru-RU', {day:'2-digit', month:'long', year:'numeric'});
    document.getElementById('welcomeModal').style.display = 'flex';
}
function hideWelcomeModal() { document.getElementById('welcomeModal').style.display = 'none'; }

// ============================================================
// –°–ë–†–û–° –î–ê–ù–ù–´–• (—Ç–æ–ª—å–∫–æ –¥–ª—è RIDCOIN)
// ============================================================
async function resetAllData() {
    if (!confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
    if (!confirm('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ. –í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
    showLoading('–£–¥–∞–ª–µ–Ω–∏–µ...');
    await db.ref('users').remove();
    localStorage.removeItem('ridcoin_gold');
    users = {};
    hideLoading();
    location.reload();
}

// ============================================================
// –ü–û–ü–û–õ–ù–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê (—Ç–æ–ª—å–∫–æ –¥–ª—è RIDCOIN)
// ============================================================
function addBalanceModal() {
    document.getElementById('addBalanceModal').style.display = 'flex';
    document.getElementById('ab-username').value = '';
    document.getElementById('ab-amount').value = '';
    document.getElementById('abError').style.display = 'none';
}
function hideAddBalanceModal() { document.getElementById('addBalanceModal').style.display = 'none'; }

async function confirmAddBalance() {
    const username = document.getElementById('ab-username').value.trim();
    const amount   = parseFloat(document.getElementById('ab-amount').value);
    const errDiv   = document.getElementById('abError');
    errDiv.style.display = 'none';
    const showErr = msg => { errDiv.textContent = msg; errDiv.style.display = 'block'; };
    if (!username)                              { showErr('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); return; }
    if (!users[username])                       { showErr('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    if (users[username].hidden)                 { showErr('–ù–µ–ª—å–∑—è –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç'); return; }
    if (!amount || isNaN(amount) || amount <= 0){ showErr('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É'); return; }
    if ((users['RIDCOIN'].balance || 0) < amount){ showErr('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á—ë—Ç–µ RIDCOIN'); return; }

    showLoading('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...');
    try {
        const [ridSnap, userSnap] = await Promise.all([
            db.ref('users/RIDCOIN').get(),
            db.ref(`users/${username}`).get()
        ]);
        const ridData  = ridSnap.exists()  ? ridSnap.val()  : users['RIDCOIN'];
        const userData = userSnap.exists() ? userSnap.val() : users[username];

        if ((ridData.balance || 0) < amount) {
            hideLoading();
            showErr('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á—ë—Ç–µ RIDCOIN (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å)');
            return;
        }

        const date     = new Date().toLocaleString('ru-RU');
        const ridPrice = getCurrentRidPrice();
        const usdValue = (amount * ridPrice).toFixed(2);
        const display  = formatRid(amount) + ' RID';

        ridData.balance   = (ridData.balance || 0) - amount;
        ridData.sentTotal = (ridData.sentTotal || 0) + amount;
        ridData.txCount   = (ridData.txCount  || 0) + 1;
        if (!Array.isArray(ridData.history)) ridData.history = [];
        ridData.history.push(`[${date}] ‚Üí ${username}: ${display} ($${usdValue})`);

        userData.balance       = (userData.balance || 0) + amount;
        userData.receivedTotal = (userData.receivedTotal || 0) + amount;
        userData.txCount       = (userData.txCount || 0) + 1;
        if (!Array.isArray(userData.history)) userData.history = [];
        userData.history.push(`[${date}] ‚Üê RIDCOIN: ${display} ($${usdValue}) üéÅ`);

        const updates = {};
        updates[`users/RIDCOIN`]     = ridData;
        updates[`users/${username}`] = userData;
        await db.ref().update(updates);

        users['RIDCOIN'] = ridData;
        users[username]  = userData;
        localStorage.setItem('ridcoin_gold', JSON.stringify(users));

    } catch (e) {
        console.error('AddBalance error:', e);
        hideLoading();
        showErr('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ' + e.message);
        return;
    }

    hideLoading();
    hideAddBalanceModal();
    updateWalletDisplay();
    showToast(`‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω ${username} –Ω–∞ ${formatRid(amount)} RID`, 'success');
}

// ============================================================
// –í–°–ï –ê–ö–ö–ê–£–ù–¢–´ (ADMIN)
// ============================================================
function showAllUsersAdmin() {
    const modal = document.getElementById('usersModal');
    const listDiv = document.getElementById('allUsersList');
    listDiv.innerHTML = '';
    const all = Object.keys(users).map(u => ({username:u, user:users[u]}))
        .sort((a,b) => (b.user.balance||0) - (a.user.balance||0));
    all.forEach(({username, user}) => {
        const balance = user.balance || 0;
        const div = document.createElement('div');
        div.className = 'user-item';
        div.style.marginBottom = '15px'; div.style.padding = '15px';
        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:42px;height:42px;border-radius:50%;background:${getAvatarColor(username)};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;flex-shrink:0;">${username[0].toUpperCase()}</div>
                <div>
                    <div style="font-size:17px;font-weight:700;">${username} ${user.hidden?'<span style="color:#e74c3c;font-size:12px;">[—Å–∫—Ä—ã—Ç—ã–π]</span>':''} ${user.admin?'<span class="admin-badge">üëë</span>':''}</div>
                    <div>–ë–∞–ª–∞–Ω—Å: <span class="${balance===0?'zero-balance':'gold-text'}">${formatRid(balance)} RID</span></div>
                    <div style="color:#777;font-size:13px;">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${user.txCount||0} ${user.phoneVerified?'¬∑ üì± '+user.phone:''}</div>
                </div>
            </div>`;
        listDiv.appendChild(div);
    });
    modal.style.display = 'flex';
}

// ============================================================
// –í–´–•–û–î
// ============================================================
function logout() {
    if (!confirm('–í—ã–π—Ç–∏ –∏–∑ –∫–æ—à–µ–ª—å–∫–∞?')) return;
    if (userListener) { db.ref(`users/${currentUser}`).off('value', userListener); userListener = null; }
    currentUser = null; historyFilter='all'; historyPage=0;
    document.getElementById('wallet').style.display = 'none';
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('username').focus();
    updateUsersList();
}

// ============================================================
// –ö–û–ü–ò–†–û–í–ê–¢–¨ –ò–ú–Ø
// ============================================================
function copyUsername() {
    if (!currentUser) return;
    navigator.clipboard.writeText(currentUser)
        .then(() => showToast('–ò–º—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!','info'))
        .catch(() => showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å','error'));
}

// ============================================================
// –§–û–†–ú–ê–¢
// ============================================================
function formatRid(amount) {
    if (amount === 0) return '0';
    if (amount >= 1000) return amount.toLocaleString('ru-RU', {maximumFractionDigits:0});
    if (amount >= 1)    return amount.toLocaleString('ru-RU', {minimumFractionDigits:2,maximumFractionDigits:8});
    return amount.toFixed(8).replace(/\.?0+$/,'');
}

// ============================================================
// –ö–õ–ê–í–ò–ê–¢–£–†–ê
// ============================================================
document.getElementById('username').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('password').focus(); });
document.getElementById('password').addEventListener('keypress', e => { if(e.key==='Enter') login(); });
document.getElementById('reg-username').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('reg-password').focus(); });
document.getElementById('reg-password').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('reg-confirm').focus(); });
document.getElementById('reg-confirm').addEventListener('keypress', e => { if(e.key==='Enter') createAccount(); });
document.getElementById('recovery-username').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('recovery-phrase-input').focus(); });

// ============================================================
// –°–¢–ê–†–¢
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    loadAllUsers().then(() => {
        subscribeToUsersCount();
    });
    updateHeaderPrice();
    setInterval(updateHeaderPrice, 60000);
    document.getElementById('username').focus();

    // Firebase connection state
    db.ref('.info/connected').on('value', snap => {
        setFirebaseConnected(snap.val() === true);
    });
});
</script>
</body>
</html>
