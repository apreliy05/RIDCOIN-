<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>RiDcoin Вклад с WalletConnect (Trust Wallet)</title>
<style>
  /* ваш стили (по предыдущему примеру) */
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
    background-color: #fafafa;
    border: 1px solid #ddd;
    border-radius: 12px;
  }
  h1 {
    text-align: center;
    color: #226622;
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 20px;
  }
  input[type=password], input[type=number] {
    width: 100%;
    padding: 8px;
    font-size: 1em;
    margin-top: 6px;
    border-radius: 6px;
    border: 1px solid #aaa;
  }
  button {
    margin-top: 20px;
    width: 100%;
    padding: 12px;
    font-size: 1.2em;
    background-color: #4caf50;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background-color: #388e3c;
  }
  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
  #status {
    margin-top: 25px;
    font-size: 1.1em;
    text-align: center;
    min-height: 2em;
    white-space: pre-wrap;
  }
</style>
</head>
<body>

<h1>Вклад RiDcoin (Polygon)</h1>

<div id="loginSection">
  <label for="accessKey">Введите ключ доступа (пароль):</label>
  <input type="password" id="accessKey" placeholder="Введите пароль для доступа" />
  <button id="loginBtn">Войти</button>
</div>

<div id="appSection" style="display:none; margin-top: 30px;">
  <p><b>Ваш кошелёк:</b> <span id="userAddress">не подключен</span></p>
  <p><b>Баланс RiDcoin:</b> <span id="userBalance">-</span></p>

  <button id="connectWalletBtn">Подключить кошелёк</button>

  <label for="depositAmount">Сумма вложения RiDcoin (минимум 1):</label>
  <input type="number" id="depositAmount" min="1" value="1" step="0.0001" />

  <button id="sendTokenBtn" disabled>Отправить вклад</button>

  <div id="status"></div>
</div>

<!-- Подключаем ethers.js и WalletConnect перед скриптом -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>

<script>
  (function(){
    const ACCESS_PASSWORD = "supersecret123"; // Замените на свой пароль доступа

    // Минимальный ABI: transfer, decimals, balanceOf
    const erc20ABI = [
      "function transfer(address to, uint amount) public returns (bool)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address owner) view returns (uint)"
    ];

    const tokenAddress = "0xcD36914FD4C560D1475088eB84bB82C11f3E19DE"; // Ваш RiDcoin контракт

    const loginBtn = document.getElementById('loginBtn');
    const accessKeyInput = document.getElementById('accessKey');
    const appSection = document.getElementById('appSection');
    const loginSection = document.getElementById('loginSection');
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const sendTokenBtn = document.getElementById('sendTokenBtn');
    const userAddressSpan = document.getElementById('userAddress');
    const userBalanceSpan = document.getElementById('userBalance');
    const statusDiv = document.getElementById('status');
    const depositAmountInput = document.getElementById('depositAmount');

    let provider;
    let signer, userAddress, tokenContract, decimals;

    // WalletConnect provider init и enable с обработкой ошибки закрытия модала
    async function initWalletConnectProvider() {
      const WalletConnectProvider = window.WalletConnectProvider.default;
      provider = new WalletConnectProvider({
        rpc: { 137: "https://polygon-rpc.com" },
        chainId: 137,
        qrcode: true
      });
      try {
        await provider.enable();
      } catch (err) {
        if (err.message && err.message.includes("User closed modal")) {
          statusDiv.textContent = "Подключение отменено пользователем.";
        } else {
          statusDiv.textContent = "Ошибка подключения: " + err.message;
        }
        throw err;
      }
      return provider;
    }

    loginBtn.onclick = () => {
      if (accessKeyInput.value === ACCESS_PASSWORD) {
        accessKeyInput.value = "";
        loginSection.style.display = "none";
        appSection.style.display = "block";
        statusDiv.textContent = "Введите пароль успешно, теперь подключите кошелёк.";
      } else {
        alert("Неверный пароль доступа!");
      }
    };

    connectWalletBtn.onclick = async () => {
      statusDiv.textContent = "Подключаем кошелёк...";
      try {
        if (window.ethereum) {
          // MetaMask или Trust Wallet встроенный браузер
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await window.ethereum.request({ method: 'eth_requestAccounts' });
        } else {
          // WalletConnect
          const wcProvider = await initWalletConnectProvider();
          provider = new ethers.providers.Web3Provider(wcProvider);
        }

        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        userAddressSpan.textContent = userAddress;

        tokenContract = new ethers.Contract(tokenAddress, erc20ABI, signer);
        decimals = await tokenContract.decimals();

        await updateBalance();

        sendTokenBtn.disabled = false;
        statusDiv.textContent = "Кошелёк подключён, готово к отправке.";
      } catch (e) {
        if (e.message && e.message.includes("User closed modal")) {
          // Ошибка закрытия окна QR — уже обработана, не показываем повторно
        } else {
          statusDiv.textContent = "Ошибка подключения: " + e.message;
        }
      }
    };

    async function updateBalance() {
      try {
        let bal = await tokenContract.balanceOf(userAddress);
        bal = ethers.utils.formatUnits(bal, decimals);
        userBalanceSpan.textContent = bal;
      } catch(e) {
        userBalanceSpan.textContent = 'Ошибка';
      }
    }

    sendTokenBtn.onclick = async () => {
      const amountRaw = depositAmountInput.value;
      const amountNum = parseFloat(amountRaw);
      if (isNaN(amountNum) || amountNum < 1) {
        alert("Введите сумму не меньше 1 RiDcoin");
        return;
      }
      if (!tokenContract || !userAddress) {
        alert("Кошелёк не подключён");
        return;
      }
      sendTokenBtn.disabled = true;
      statusDiv.textContent = "Отправляем транзакцию, ожидайте...";

      try {
        const amountWei = ethers.utils.parseUnits(amountNum.toString(), decimals);
        // Адрес проекта для вкладов (можете изменить)
        const recipientAddress = tokenAddress;

        const tx = await tokenContract.transfer(recipientAddress, amountWei);
        statusDiv.textContent = `Транзакция отправлена.\nХэш: ${tx.hash}`;

        await tx.wait();

        statusDiv.textContent = `Вклад ${amountNum} RiDcoin успешно отправлен!`;

        await updateBalance();
      } catch(e) {
        statusDiv.textContent = "Ошибка отправки: " + e.message;
      } finally {
        sendTokenBtn.disabled = false;
      }
    };
  })();
</script>
</body>
</html>
